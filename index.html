<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Realtime Bus & Subway - Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Pretendard', sans-serif;
            background-color: #F2F4F6;
            color: #191F28;
            touch-action: pan-y;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-toss-gradient { background: linear-gradient(to bottom right, #F2F4F6, #E8ECF2, #DEE2E6); }
        .toss-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04); 
            transition: transform 0.1s;
            overflow: hidden;
        }
        .toss-card:active { transform: scale(0.98); }
        .glass-item {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
        }
        .text-main { color: #191F28; }
        .text-sub { color: #6B7684; }
        .pt-safe { padding-top: max(10px, env(safe-area-inset-top)); }
        .pb-safe-nav { padding-bottom: max(80px, env(safe-area-inset-bottom)); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .region-card-selected { background-color: rgba(255, 255, 255, 0.9) !important; border-color: #3182F6 !important; box-shadow: 0 4px 12px rgba(49, 130, 246, 0.15) !important; }
        
        #dynamic-island { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .island-active {
            width: 140px !important; background-color: #191F28 !important; border-radius: 9999px !important;
            margin-top: 10px; padding: 8px 16px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
        }
        /* .header-title ëŒ€ì‹  .header-left-groupì„ ìˆ¨ê¹€ ì²˜ë¦¬í•˜ì—¬ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ë„ ê°™ì´ ìˆ¨ê¹€ */
        .island-active .header-left-group { width: 0; opacity: 0; margin: 0; overflow: hidden; transform: scale(0.8); }
        .island-active .icon-container { width: 100%; justify-content: center; gap: 24px !important; }
        .island-active .icon-bg { background-color: transparent !important; width: auto !important; height: auto !important; box-shadow: none !important; color: white !important; }
        
        @keyframes pulse-custom { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse-custom { animation: pulse-custom 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .btn-kakao { background-color: #FAE100; color: #3C1E1E; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
        .toss-card:hover .delete-btn { opacity: 1; }
        
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nav-pill-active { background-color: #191F28; color: white; }
        .nav-pill-inactive { background-color: transparent; color: #6B7684; }
        
        .badge-daegyeong { background-color: #0054A6; color: white; }
        
        .line-badge { transition: all 0.2s; border: 1px solid transparent; }
        .line-badge-active { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.05); }
        .line-badge-inactive { opacity: 0.5; background-color: #F2F4F6; color: #8B95A1; border-color: #E5E8EB; }
    </style>
</head>
<body class="w-full h-[100dvh] flex flex-col overflow-hidden bg-toss-gradient">

    <!-- í—¤ë” -->
    <header class="fixed top-0 left-0 w-full z-50 flex justify-center pt-safe pointer-events-none">
        <div id="dynamic-island" class="pointer-events-auto w-full max-w-md px-5 py-2 flex items-center justify-between bg-transparent mx-auto origin-top mt-2">
            <!-- ì¢Œì¸¡ ê·¸ë£¹ (ë’¤ë¡œê°€ê¸° + íƒ€ì´í‹€) -->
            <div class="header-left-group flex items-center gap-3 transition-all duration-300 origin-left">
                <a href="https://won429.github.io/enjoysite/" class="text-main text-lg p-1 hover:opacity-60 transition-opacity">
                    <i class="fa-solid fa-chevron-left"></i>
                </a>
                <h1 class="header-title text-xl font-bold text-main whitespace-nowrap">ëŒ€ì¤‘êµí†µ</h1>
            </div>
            
            <div class="icon-container flex gap-2 transition-all duration-300">
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="openSearchModal()">
                    <i class="fa-solid fa-magnifying-glass text-sm"></i>
                </div>
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="openSettings()">
                    <i class="fa-solid fa-gear text-sm"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main id="main-content" class="flex-1 overflow-y-auto scrollbar-hide px-5 pb-safe-nav w-full max-w-md mx-auto relative pt-16">
        
        <!-- [1] ë²„ìŠ¤ ë·° -->
        <div id="view-bus" class="fade-in-up">
            <!-- ì§€ì—­ ì„ íƒ (ë²„ìŠ¤) -->
            <div class="mb-6 fade-in-up delay-100">
                <h3 class="text-lg font-bold text-main mb-3 px-1">ì§€ì—­ ì„ íƒ</h3>
                <div class="flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1">
                    <div id="btn-andong" onclick="selectRegion('andong')" class="toss-card region-card-selected min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 text-lg"><i class="fa-solid fa-location-dot"></i></div>
                        <div><p class="text-sm font-bold text-main">ì•ˆë™ì‹œ</p><p class="text-xs text-sub status-text" id="status-andong">ì—°ê²° ëŒ€ê¸°</p></div>
                    </div>
                    <div id="btn-gumi" onclick="selectRegion('gumi')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 text-lg"><i class="fa-solid fa-city"></i></div>
                        <div><p class="text-sm font-bold text-main">êµ¬ë¯¸ì‹œ</p><p class="text-xs text-sub status-text" id="status-gumi">ì—°ê²° ëŒ€ê¸°</p></div>
                    </div>
                    <div id="btn-chilgok" onclick="selectRegion('chilgok')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500 text-lg"><i class="fa-solid fa-tree"></i></div>
                        <div><p class="text-sm font-bold text-main">ì¹ ê³¡êµ°</p><p class="text-xs text-sub status-text" id="status-chilgok">ì—°ê²° ëŒ€ê¸°</p></div>
                    </div>
                </div>
                <p id="city-code-status" class="text-[10px] text-gray-400 mt-2 px-1 text-right">ë„ì‹œ ì½”ë“œ ì¡°íšŒ ëŒ€ê¸°ì¤‘...</p>
            </div>

            <!-- ë²„ìŠ¤ ëª©ë¡ -->
            <div class="mb-4 fade-in-up delay-200">
                <div class="flex justify-between items-end mb-3 px-1">
                    <div>
                        <h3 class="text-lg font-bold text-main">ë„ì°© ì •ë³´</h3>
                        <span class="text-xs font-medium text-sub" id="region-status-label">ì•ˆë™ì‹œ</span>
                    </div>
                    <button id="add-btn-main" onclick="openSearchModal()" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors shadow-sm">
                        + ì •ë¥˜ì¥ ì¶”ê°€
                    </button>
                </div>
                
                <div id="dynamic-list-container" class="space-y-4"></div>
                
                <div id="empty-state" class="hidden text-center py-10 bg-white/40 rounded-3xl border border-white/60">
                    <i class="fa-solid fa-key text-3xl text-gray-300 mb-2"></i>
                    <p class="text-sm font-bold text-gray-500">API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
                    <p class="text-xs text-gray-400 mt-1">
                        ì„¤ì •(ìš°ì¸¡ ìƒë‹¨ í†±ë‹ˆë°”í€´)ì—ì„œ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                        ì•ˆë™ì‹œëŠ” í‚¤ ì—†ì´ë„ ì‹œê°„í‘œ ëª¨ë“œë¡œ ì‘ë™í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>

        <!-- [2] ì§€í•˜ì²  ë·° -->
        <div id="view-subway" class="hidden fade-in-up">
            <!-- ì§€ì—­ ì„ íƒ (ì§€í•˜ì² ) -->
            <div class="mb-4 fade-in-up delay-100">
                <h3 class="text-lg font-bold text-main mb-3 px-1">ì§€ì—­ ì„ íƒ</h3>
                <div class="flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1">
                    <!-- êµ¬ë¯¸ì‹œ -->
                    <div id="sub-btn-gumi" onclick="selectSubwayRegion('gumi')" class="toss-card region-card-selected min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 text-lg"><i class="fa-solid fa-train-subway"></i></div>
                        <div><p class="text-sm font-bold text-main">ê²½ë¶ êµ¬ë¯¸ì‹œ</p><p class="text-xs text-sub status-text">ì„ íƒë¨</p></div>
                    </div>
                    <!-- ì¹ ê³¡êµ° -->
                    <div id="sub-btn-chilgok" onclick="selectSubwayRegion('chilgok')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500 text-lg"><i class="fa-solid fa-train"></i></div>
                        <div><p class="text-sm font-bold text-main">ê²½ë¶ ì¹ ê³¡êµ°</p><p class="text-xs text-sub status-text">ì„ íƒí•˜ê¸°</p></div>
                    </div>
                    <!-- ëŒ€êµ¬ê´‘ì—­ì‹œ -->
                    <div id="sub-btn-daegu" onclick="selectSubwayRegion('daegu')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 text-lg"><i class="fa-solid fa-subway"></i></div>
                        <div><p class="text-sm font-bold text-main">ëŒ€êµ¬ê´‘ì—­ì‹œ</p><p class="text-xs text-sub status-text">ì„ íƒí•˜ê¸°</p></div>
                    </div>
                    <!-- ê²½ì‚°ì‹œ -->
                    <div id="sub-btn-gyeongsan" onclick="selectSubwayRegion('gyeongsan')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 text-lg"><i class="fa-solid fa-train-tram"></i></div>
                        <div><p class="text-sm font-bold text-main">ê²½ë¶ ê²½ì‚°ì‹œ</p><p class="text-xs text-sub status-text">ì„ íƒí•˜ê¸°</p></div>
                    </div>
                </div>
            </div>

            <!-- ë…¸ì„  ë° ì—­ ì •ë³´ -->
            <div class="px-1 fade-in-up delay-200">
                <div class="mb-3">
                    <h3 class="text-lg font-bold text-main mb-2">ë…¸ì„  ì„ íƒ</h3>
                    <!-- ë…¸ì„  ì„ íƒ ë°°ì§€ ì»¨í…Œì´ë„ˆ -->
                    <div id="subway-line-badges" class="flex flex-wrap gap-2"></div>
                </div>
                <!-- ì—­ ëª©ë¡ ì»¨í…Œì´ë„ˆ -->
                <div id="subway-station-list" class="space-y-3"></div>
            </div>
        </div>

        <div class="h-20"></div>
    </main>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="fixed bottom-8 left-0 w-full z-[60] flex justify-center pointer-events-none">
        <div class="pointer-events-auto bg-white/90 backdrop-blur-xl border border-white/50 rounded-full p-1.5 shadow-2xl shadow-black/10 flex gap-1 scale-105">
            <button onclick="switchTab('bus')" id="nav-bus" class="nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300">
                <i class="fa-solid fa-bus"></i><span>ë²„ìŠ¤</span>
            </button>
            <button onclick="switchTab('subway')" id="nav-subway" class="nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100">
                <i class="fa-solid fa-train-subway"></i><span>ì§€í•˜ì² </span>
            </button>
        </div>
    </nav>

    <!-- ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="search-modal" class="hidden fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-5">
        <div class="bg-white w-full max-w-sm h-[85vh] sm:h-[80vh] sm:rounded-[32px] rounded-t-[32px] p-6 shadow-2xl scale-100 transition-all flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none">
                <div>
                    <h3 class="text-xl font-bold text-main">ì •ë¥˜ì¥ ì¶”ê°€</h3>
                    <p class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md inline-block mt-1" id="search-modal-region">ì•ˆë™ì‹œ</p>
                </div>
                <button onclick="closeSearchModal()" class="text-gray-400 hover:text-gray-600 bg-gray-100 w-8 h-8 rounded-full"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div id="andong-manual-guide" class="mb-4 hidden">
                <div class="bg-blue-50 p-4 rounded-2xl mb-4">
                    <p class="text-sm font-bold text-main mb-1">ê³ ì • ì‹œê°„í‘œ ëª¨ë“œ</p>
                    <p class="text-xs text-gray-500">ì•ˆë™ì‹œëŠ” ì‹œê°„í‘œ íŒŒì¼(CSV)ì— ìˆëŠ” ì •ë¥˜ì¥ì„ ìë™ìœ¼ë¡œ í‘œì‹œí•˜ê±°ë‚˜, ì§ì ‘ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <div id="api-search-box" class="flex gap-2 mb-2 flex-none">
                <input type="text" id="add-station-input" placeholder="ì •ë¥˜ì¥ëª… ê²€ìƒ‰" class="flex-1 bg-gray-100 rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.keyCode==13) doSearchStation()">
                <button onclick="doSearchStation()" class="bg-blue-500 text-white rounded-2xl px-4 py-3 text-sm font-bold whitespace-nowrap">ê²€ìƒ‰</button>
            </div>
            
            <div id="add-station-results" class="flex-1 overflow-y-auto space-y-2 border-t border-gray-100 pt-2 min-h-0">
                <p class="text-center text-gray-400 mt-10 text-sm">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center p-5">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl scale-95 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-main">ì„¤ì •</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-2">ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤ (êµ¬ë¯¸/ì¹ ê³¡ìš©)</label>
                <input type="text" id="api-key-input" placeholder="ì¸ì¦í‚¤ ë¶™ì—¬ë„£ê¸°" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div class="flex gap-4 mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="key-type" value="decoding" checked class="w-4 h-4 text-blue-500">
                    <span class="text-sm text-gray-600">Decoding (ì¼ë°˜)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="key-type" value="encoding" class="w-4 h-4 text-blue-500">
                    <span class="text-sm text-gray-600">Encoding</span>
                </label>
            </div>

            <div class="mb-6 bg-gray-50 p-4 rounded-2xl">
                <h4 class="text-xs font-bold text-main mb-2">ğŸ“„ ì‹œê°„í‘œ íŒŒì¼ ì—°ë™ (ì•ˆë™ë²„ìŠ¤ & ëŒ€ê²½ì„ )</h4>
                <div class="text-[10px] text-gray-500 space-y-1">
                    <p>1. ë²„ìŠ¤: <b>ID, ë²ˆí˜¸, ë°©ë©´, ìš”ì¼, ì‹œê°„...</b> (ìˆ«ì ID ì‹œì‘)</p>
                    <p>2. ì§€í•˜ì² : <b>ì—­ëª…, ë…¸ì„ , ë°©ë©´, ìš”ì¼, ì‹œê°„...</b> (ë¬¸ì ì—­ëª… ì‹œì‘)</p>
                    <p>3. <b>timetable.csv</b> íŒŒì¼ì— í†µí•©í•˜ì—¬ ì €ì¥í•˜ì„¸ìš”.</p>
                </div>
            </div>

            <div class="space-y-2 mb-4">
                <button onclick="initCityCodes()" class="w-full bg-orange-50 text-orange-600 font-bold py-3 rounded-2xl hover:bg-orange-100 transition-colors text-sm">
                    <i class="fa-solid fa-sync"></i> ë„ì‹œ ì½”ë“œ APIë¡œ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜)
                </button>
                <button onclick="testConnection()" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-2xl hover:bg-gray-200 transition-colors text-sm">
                    <i class="fa-solid fa-stethoscope"></i> API ì—°ê²° í…ŒìŠ¤íŠ¸ (êµ¬ë¯¸/ì¹ ê³¡)
                </button>
            </div>

            <button onclick="saveSettings()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-500/20 transition-all active:scale-95">ì €ì¥í•˜ê¸°</button>
            
            <div id="test-result" class="mt-4 p-3 bg-gray-50 rounded-xl text-xs text-gray-500 hidden break-all"></div>

            <div class="mt-4 text-center border-t border-gray-100 pt-4">
                <button onclick="resetData()" class="text-[10px] text-red-400 underline">ë°ì´í„° ê°•ì œ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <script>
        // 1. ì „ì—­ ë³€ìˆ˜ (Global Variables)
        const MANUAL_API_KEY = ""; 
        const ANDONG_DEFAULT_STATIONS = [
            { name: "êµ­ë¦½ì•ˆë™ëŒ€í•™êµ", nodeId: "370000023", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" },
            { name: "CGV ê±´ë„ˆ", nodeId: "370000998", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" }, 
            { name: "ì•ˆë™í„°ë¯¸ë„(ì•ˆë™ì—­)", nodeId: "354000416", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" } 
        ];
        
        let stationConfig = JSON.parse(localStorage.getItem('my_station_config_v40')) || { 
            andong: ANDONG_DEFAULT_STATIONS, gumi: [], chilgok: [] 
        };
        if(!stationConfig.andong || stationConfig.andong.length === 0) stationConfig.andong = ANDONG_DEFAULT_STATIONS;
        localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig));

        let CITY_CODES = { 'andong': '37010', 'gumi': '37030', 'chilgok': '37380' };
        const CITY_NAMES = { 'andong': 'ì•ˆë™ì‹œ', 'gumi': 'êµ¬ë¯¸ì‹œ', 'chilgok': 'ì¹ ê³¡êµ°' };
        
        let currentRegion = 'andong';
        let currentSubwayRegion = 'gumi';
        let currentSubwayLine = 'daegyeong';

        const SUBWAY_LINES_META = {
            '1': { name: '1í˜¸ì„ ', color: '#D93F5C' },
            '2': { name: '2í˜¸ì„ ', color: '#00AA80' },
            '3': { name: '3í˜¸ì„ ', color: '#FFB100' },
            'daegyeong': { name: 'ëŒ€ê²½ì„ ', color: '#0054A6' }
        };

        const SUBWAY_DATA = {
            'daegyeong': {
                name: 'ëŒ€ê²½ì„ ',
                color: 'badge-daegyeong',
                stations: {
                    'gumi': ['êµ¬ë¯¸ì—­', 'ì‚¬ê³¡'], 
                    'chilgok': ['ë¶ì‚¼', 'ì™œê´€ì—­'], 
                    'daegu': ['ì„œëŒ€êµ¬ì—­', 'ì›ëŒ€(ë‹¬ì„±ê³µì›)', 'ëŒ€êµ¬ì—­', 'ë™ëŒ€êµ¬ì—­'], 
                    'gyeongsan': ['ê²½ì‚°ì—­']
                }
            }
        };

        let apiKey = MANUAL_API_KEY || localStorage.getItem('toss_bus_api_key') || '';
        let keyType = localStorage.getItem('toss_bus_key_type') || 'decoding'; 
        const TIMETABLE_URL = "./timetable.csv"; 
        
        let GLOBAL_TIMETABLE = null; 

        // 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (Utility Functions)
        function getEncodedKey() {
            if (!apiKey) return '';
            return keyType === 'encoding' ? apiKey : encodeURIComponent(apiKey);
        }

        function normalizeBusData(bus) {
            if (!bus) return null;
            return {
                ...bus,
                routeno: (bus.routeno || bus.routeNo || '?').toString(),
                endnodenm: bus.endnodenm || bus.endNodeNm || '',
                arrtime: bus.arrtime || bus.arrTime,
                arrprevstationcnt: bus.arrprevstationcnt || bus.arrPrevStationCnt
            };
        }

        function parseHybrid(text) {
            try { return { type: 'json', data: JSON.parse(text) }; } catch(e) { }
            if (text.includes('<OpenAPI_ServiceResponse>')) {
                if (text.includes('SERVICE_KEY')) return { type: 'error', msg: 'API í‚¤ ì˜¤ë¥˜ (ì¸ì¦ ì‹¤íŒ¨)' };
                return { type: 'error', msg: 'ê³µê³µë°ì´í„° ì„œë²„ ì˜¤ë¥˜' };
            }
            return { type: 'error', msg: 'ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ í˜•ì‹' };
        }

        // [MODIFIED] renderBadge now sets a data-target for live updates
        function renderBadge(diffSeconds, timeStr) {
            const now = Date.now();
            const targetTime = now + (diffSeconds * 1000);
            const min = Math.floor(diffSeconds / 60);
            const sec = diffSeconds % 60;
            
            let badgeClass = "bg-gray-100 text-gray-500 border border-gray-200";
            let timeText = `${min}ë¶„ í›„ ë„ì°©`;
            
            if (min < 5) { 
                badgeClass = "bg-red-50 text-red-600 border border-red-100";
                if (min === 0) { timeText = `${sec}ì´ˆ í›„ ë„ì°©`; }
            }

            const timeHtml = timeStr ? `<span class="text-[10px] text-gray-400 font-medium whitespace-nowrap">(${timeStr})</span>` : '';

            // Added 'live-badge' class and 'data-target' attribute
            return `
                <div class="flex items-center justify-end gap-2 shrink-0 ml-auto">
                    ${timeHtml}
                    <span class="${badgeClass} live-badge px-2 py-0.5 rounded-md text-xs font-bold shadow-sm whitespace-nowrap" data-target="${targetTime}">${timeText}</span>
                </div>
            `;
        }

        // [NEW] Live countdown function
        function startLiveUpdates() {
            setInterval(() => {
                const now = Date.now();
                document.querySelectorAll('.live-badge').forEach(el => {
                    const target = parseInt(el.getAttribute('data-target'));
                    if (!target) return;

                    const diffMs = target - now;
                    const diffSec = Math.ceil(diffMs / 1000);

                    // Constants for classes
                    const baseClasses = "live-badge px-2 py-0.5 rounded-md text-xs font-bold shadow-sm whitespace-nowrap";
                    const redClasses = "bg-red-50 text-red-600 border border-red-100";
                    const grayClasses = "bg-gray-100 text-gray-500 border border-gray-200";

                    if (diffSec <= 0) {
                        el.innerText = "ê³§ ë„ì°©";
                        el.className = `${baseClasses} ${redClasses}`;
                    } else if (diffSec < 60) {
                        el.innerText = `${diffSec}ì´ˆ í›„ ë„ì°©`;
                        el.className = `${baseClasses} ${redClasses}`;
                    } else {
                        const min = Math.floor(diffSec / 60);
                        el.innerText = `${min}ë¶„ í›„ ë„ì°©`;
                        if (min < 5) {
                            el.className = `${baseClasses} ${redClasses}`;
                        } else {
                            el.className = `${baseClasses} ${grayClasses}`;
                        }
                    }
                });
            }, 1000);
        }

        // 3. API í†µì‹  ë° ë°ì´í„° ë¡œë“œ
        window.fetchWithFallback = async function(targetUrl) {
            const timestamp = `&_=${Date.now()}`; 
            const proxies = [
                url => `https://corsproxy.io/?${encodeURIComponent(url + timestamp)}`,
                url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url + timestamp)}`
            ];

            for (const makeProxyUrl of proxies) {
                try {
                    const response = await fetch(makeProxyUrl(targetUrl));
                    if (response.ok) return await response.text();
                } catch (e) { console.warn("Proxy failed, trying next...", e); }
            }
            throw new Error("All proxies failed");
        };

        window.fetchBusArrival = async function(cityCode, nodeId) {
            if (!apiKey || !nodeId) return null;
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/ArvlInfoInqireService/getSttnAcctoArvlPrearngeInfoList?serviceKey=${serviceKey}&cityCode=${cityCode}&nodeId=${nodeId}&numOfRows=100&pageNo=1&_type=json`;
            try {
                const text = await window.fetchWithFallback(targetUrl);
                const result = parseHybrid(text);
                if (result.type === 'error') return result.msg;
                const data = result.data;
                if (data.response?.header?.resultCode !== '00') return data.response?.header?.resultMsg || "API_ERROR";
                const items = data.response.body.items?.item;
                if (!items) return []; 
                const list = Array.isArray(items) ? items : [items];
                return list.map(normalizeBusData);
            } catch (error) { return "NETWORK_ERROR"; }
        };

        window.searchStationAPI = async function(keyword) {
            const serviceKey = getEncodedKey();
            const targetCityCode = CITY_CODES[currentRegion];
            let targetUrl = `http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getSttnNoList?serviceKey=${serviceKey}&cityCode=${targetCityCode}&numOfRows=500&_type=json`;
            targetUrl += `&nodeNm=${encodeURIComponent(keyword)}`;
            try {
                const text = await window.fetchWithFallback(targetUrl);
                const result = parseHybrid(text);
                if (result.type === 'error') return { error: result.msg };
                const items = result.data.response.body.items?.item;
                if (!items) return [];
                const list = Array.isArray(items) ? items : [items];
                return list.map(normalizeBusData);
            } catch (e) { return { error: "NETWORK_ERROR" }; }
        };

        window.initCityCodes = async function() {
            if (!apiKey) { alert("API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”."); return; }
            const resultBox = document.getElementById('test-result');
            resultBox.classList.remove('hidden');
            resultBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë„ì‹œ ì½”ë“œ ìŠ¤ìº” ì¤‘...';
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getCtyCodeList?serviceKey=${serviceKey}&_type=json`;

            try {
                const text = await window.fetchWithFallback(targetUrl);
                const result = parseHybrid(text);
                if (result.type === 'error') { resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ${result.msg}</span>`; return; }
                const items = result.data.response.body.items.item;
                const list = Array.isArray(items) ? items : [items];
                list.forEach(city => {
                    if (city.cityname.includes('ì•ˆë™')) CITY_CODES.andong = city.citycode;
                    if (city.cityname.includes('êµ¬ë¯¸')) CITY_CODES.gumi = city.citycode;
                    if (city.cityname.includes('ì¹ ê³¡')) CITY_CODES.chilgok = city.citycode;
                });
                localStorage.setItem('my_city_codes', JSON.stringify(CITY_CODES));
                resultBox.innerHTML = `<span class="text-green-600 font-bold">âœ… ë„ì‹œ ì½”ë“œ ê°±ì‹  ì™„ë£Œ!</span>`;
            } catch (e) { resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</span>`; }
        };

        // 4. ì‹œê°„í‘œ íŒŒì¼ íŒŒì‹± (Bus & Subway)
        window.loadTimetable = async function() {
            if (!TIMETABLE_URL) return;
            try {
                const response = await fetch(TIMETABLE_URL);
                if (!response.ok) throw new Error("File load failed");
                const text = await response.text();
                window.parseTimetable(text);
                console.log("í†µí•© ì‹œê°„í‘œ ë¡œë“œ ì™„ë£Œ");
            } catch (e) {
                console.warn("ì‹œê°„í‘œ ë¡œë“œ ì‹¤íŒ¨:", e);
                GLOBAL_TIMETABLE = "ERROR";
            }
            if(currentRegion === 'andong' && !document.getElementById('view-bus').classList.contains('hidden')) window.renderList();
            if(!document.getElementById('view-subway').classList.contains('hidden')) window.renderSubwayStations();
        };

        window.parseTimetable = function(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const table = {};
            lines.forEach((line, index) => {
                if (index === 0) return; 
                const cols = line.split(',').map(c => c.trim());
                if (cols.length < 5) return; 
                const key = cols[0]; const routeName = cols[1]; const dest = cols[2]; let dayType = cols[3]; 
                const dayMap = { 'í‰ì¼': ['weekday'], 'í† ìš”ì¼': ['saturday'], 'ì¼ìš”ì¼': ['holiday'], 'ê³µíœ´ì¼': ['holiday'], 'ë§¤ì¼': ['weekday', 'saturday', 'holiday'], 'ì£¼ë§': ['saturday', 'holiday'] };
                const targetDays = dayMap[dayType] || ['weekday'];
                const times = []; for(let i=4; i<cols.length; i++) { if(cols[i] && cols[i].includes(':')) times.push(cols[i]); }
                if (!table[key]) table[key] = [];
                let existing = table[key].find(r => r.routeNo === routeName && r.dest === dest);
                if (!existing) { existing = { routeNo: routeName, dest: dest, times: { weekday: [], saturday: [], holiday: [] } }; table[key].push(existing); }
                targetDays.forEach(d => { existing.times[d] = [...existing.times[d], ...times]; });
            });
            for (let k in table) {
                table[k].forEach(route => {
                    const timeSort = (a, b) => { const [h1, m1] = a.split(':').map(Number); const [h2, m2] = b.split(':').map(Number); return (h1*60 + m1) - (h2*60 + m2); };
                    route.times.weekday.sort(timeSort); route.times.saturday.sort(timeSort); route.times.holiday.sort(timeSort);
                });
            }
            GLOBAL_TIMETABLE = table;
        };

        window.getNextTimeFromFile = function(stationKey, destFilters, dayKey) {
            if (!GLOBAL_TIMETABLE || GLOBAL_TIMETABLE === "ERROR") return { diff: 999999, html: `<span class="text-gray-400 text-xs">ì •ë³´ ì—†ìŒ</span>` };
            const stationData = GLOBAL_TIMETABLE[stationKey];
            if (!stationData) return { diff: 999999, html: `<span class="text-gray-400 text-xs">ì •ë³´ ì—†ìŒ</span>` };
            const now = new Date();
            const nowTotalSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            let targetRoutes = stationData.filter(r => destFilters.some(filter => r.dest.includes(filter)));
            if (targetRoutes.length === 0) return { diff: 999999, html: `<span class="text-gray-400 text-xs">ìš´í–‰ ì¢…ë£Œ</span>` };
            let bestDiff = 999999; let bestTime = null;
            targetRoutes.forEach(route => {
                const times = route.times[dayKey] || [];
                times.forEach(time => {
                    const [h, m, s=0] = time.split(':').map(Number); const timeSec = h * 3600 + m * 60 + s;
                    if (timeSec > nowTotalSec) { const diff = timeSec - nowTotalSec; if (diff < bestDiff) { bestDiff = diff; bestTime = time; } }
                });
            });
            if (!bestTime) return { diff: 999999, html: `<span class="text-gray-400 text-xs">ìš´í–‰ ì¢…ë£Œ</span>` };
            return { diff: bestDiff, html: renderBadge(bestDiff, bestTime) };
        };

        // 5. ë Œë”ë§ í•¨ìˆ˜ë“¤
        window.renderStaticCard = function(index, station) {
            const container = document.getElementById('dynamic-list-container');
            if (GLOBAL_TIMETABLE === "ERROR") { container.innerHTML = `<div class="p-4 bg-red-50 text-red-500 text-center text-xs rounded-xl">ì‹œê°„í‘œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`; return; }
            const day = new Date().getDay(); const dayKey = (day === 0) ? 'holiday' : (day === 6 ? 'saturday' : 'weekday');
            const stationData = GLOBAL_TIMETABLE ? GLOBAL_TIMETABLE[station.nodeId] : null;
            let iconClass = "fa-solid fa-bus"; if (station.name.includes("ëŒ€í•™êµ")) iconClass = "fa-solid fa-school"; if (station.name.includes("CGV")) iconClass = "fa-solid fa-film";
            let contentHtml = '';
            
            if (stationData) {
                const now = new Date();
                const nowTotalSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

                // [ìˆ˜ì •ë¨] ê¸°ì¡´ getNextTimeFromFile ëŒ€ì‹  ê° ë…¸ì„ (r)ì˜ ì‹œê°„í‘œë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ì—¬ ì •í™•ë„ í–¥ìƒ
                const routes = stationData.map(r => { 
                    const times = r.times[dayKey] || [];
                    let bestDiff = 999999; 
                    let bestTime = null;
                    
                    times.forEach(time => {
                        const [h, m, s=0] = time.split(':').map(Number); 
                        const timeSec = h * 3600 + m * 60 + s;
                        if (timeSec > nowTotalSec) { 
                            const diff = timeSec - nowTotalSec; 
                            if (diff < bestDiff) { bestDiff = diff; bestTime = time; } 
                        }
                    });

                    let html = '';
                    if (!bestTime) html = `<span class="text-gray-400 text-xs">ìš´í–‰ ì¢…ë£Œ</span>`;
                    else html = renderBadge(bestDiff, bestTime);
                    
                    return { ...r, diff: bestDiff, html: html };
                }).filter(r => r.diff !== 999999).sort((a, b) => a.diff - b.diff);

                if (routes.length === 0) { contentHtml = `<div class="text-center text-gray-400 text-xs py-2">ìš´í–‰ ì¢…ë£Œ</div>`; } 
                else { 
                    routes.forEach(r => { 
                        const isExpress = r.routeNo.includes("ê¸‰í–‰"); 
                        contentHtml += `<div class="glass-item p-3 mb-2 flex items-center justify-between"><div class="flex items-center gap-3"><span class="${isExpress ? 'bg-red-500' : 'bg-blue-500'} text-white text-[10px] font-bold px-1.5 py-0.5 rounded min-w-[36px] text-center">${isExpress ? 'ê¸‰í–‰' : 'ì¼ë°˜'}</span><div><span class="text-sm font-bold text-main">${r.routeNo}</span><span class="text-[10px] text-sub ml-1">${r.dest} ë°©ë©´</span></div></div>${r.html}</div>`; 
                    }); 
                }
            } else { contentHtml = `<div class="text-center text-gray-400 text-xs py-2">ë°ì´í„° ë¡œë”©ì¤‘...</div>`; }
            const cardHtml = `<div class="toss-card p-5 mb-4 !bg-white/70 animate-[fadeInUp_0.4s_ease-out] relative"><div class="flex justify-between items-start mb-4"><div class="flex items-center gap-2.5"><div class="w-10 h-10 rounded-[16px] bg-gray-100 flex items-center justify-center text-gray-500 text-lg shadow-sm"><i class="${iconClass}"></i></div><div><h4 class="text-base font-bold text-main">${station.name}</h4><p class="text-xs text-sub text-[10px]">ID: ${station.nodeId}</p></div></div><button onclick="removeStation('${currentRegion}', ${index})" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div><div class="space-y-1">${contentHtml}</div></div>`;
            container.insertAdjacentHTML('beforeend', cardHtml);
        };

        window.loadStationData = async function(index, cityCode, station) {
            const cardId = `station-card-${index}`; const card = document.getElementById(cardId); if (!card) return;
            const arrivals = await window.fetchBusArrival(cityCode, station.nodeId);
            if (typeof arrivals === 'string') { card.innerHTML = `<div class="p-4 text-center bg-red-50 rounded-2xl border border-red-100"><p class="text-red-500 text-xs font-bold mb-1">ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p><p class="text-red-400 text-[10px]">${arrivals === 'NETWORK_ERROR' ? 'ì¸í„°ë„· ì—°ê²° í™•ì¸' : 'API í‚¤ í™•ì¸ í•„ìš”'}</p></div><div class="text-center mt-2"><button onclick="removeStation('${currentRegion}', ${index})" class="text-xs text-gray-400 underline">ì‚­ì œ</button></div>`; card.classList.remove('animate-pulse'); return; }
            if (arrivals.length === 0) { card.innerHTML = `<div class="p-5 flex justify-between items-center"><div class="flex items-center gap-2.5"><div class="w-10 h-10 rounded-[16px] bg-gray-100 flex items-center justify-center text-gray-400 text-lg"><i class="fa-solid fa-ban"></i></div><div><h4 class="text-base font-bold text-main">${station.name}</h4><p class="text-[10px] text-sub">ì •ë³´ ì—†ìŒ</p></div></div><button onclick="removeStation('${currentRegion}', ${index})" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div>`; card.classList.remove('animate-pulse'); return; }
            arrivals.sort((a, b) => parseInt(a.arrtime) - parseInt(b.arrtime));
            let contentHtml = ''; const now = new Date(); 
            arrivals.forEach(bus => {
                const arrSeconds = parseInt(bus.arrtime); const arrivalDate = new Date(now.getTime() + arrSeconds * 1000);
                const timeStr = `${arrivalDate.getHours()}:${arrivalDate.getMinutes().toString().padStart(2,'0')}`;
                contentHtml += `<div class="glass-item p-3 mb-2 flex items-center justify-between"><div class="flex items-center gap-3"><span class="bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded min-w-[36px] text-center">${bus.routeno}</span><div><span class="text-sm font-bold text-main">${bus.routeno}ë²ˆ</span><span class="text-[10px] text-sub ml-1">${bus.endnodenm} ë°©ë©´</span></div></div>${renderBadge(arrSeconds, timeStr)}</div>`;
            });
            card.innerHTML = `<div class="flex justify-between items-start mb-4"><div class="flex items-center gap-2.5"><div class="w-10 h-10 rounded-[16px] bg-blue-100 flex items-center justify-center text-blue-600 text-lg shadow-sm"><i class="fa-solid fa-bus-simple"></i></div><div><h4 class="text-base font-bold text-main">${station.name}</h4><p class="text-xs text-sub text-[10px]">ID: ${station.nodeId}</p></div></div><button onclick="removeStation('${currentRegion}', ${index})" class="delete-btn text-gray-300 hover:text-red-500 p-1"><i class="fa-solid fa-trash-can text-sm"></i></button></div><div class="space-y-1">${contentHtml}</div>`;
            card.classList.remove('animate-pulse'); card.classList.add('!bg-white/70');
        };

        window.renderSubwayStations = function() {
            const listContainer = document.getElementById('subway-station-list'); listContainer.innerHTML = '';
            if (currentSubwayLine !== 'daegyeong') { listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs">ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.</div>`; return; }
            
            // [ìˆ˜ì •] ì‚¬ìš©ì ì¶”ê°€ ì§€í•˜ì²  ì—­ ë¡œë“œ
            const userStations = JSON.parse(localStorage.getItem('my_subway_stations_v1')) || {};
            const userAdded = userStations[currentSubwayRegion] || [];
            
            // ê¸°ë³¸ ì—­ ëª©ë¡ + ì‚¬ìš©ì ì¶”ê°€ ëª©ë¡ ë³‘í•© (ì¤‘ë³µ ì œê±°)
            const defaultStations = SUBWAY_DATA['daegyeong'].stations[currentSubwayRegion] || [];
            const allStations = [...new Set([...defaultStations, ...userAdded])];

            const day = new Date().getDay(); const dayKey = (day === 0) ? 'holiday' : (day === 6 ? 'saturday' : 'weekday');
            
            allStations.forEach((stationName, index) => {
                let cardContent = '';

                // í™˜ìŠ¹ ë°°ì§€ ìƒì„± ë¡œì§ (ì•Œì•½ -> ì›í˜• ë³€ê²½)
                let transferBadge = '';
                if (stationName === 'ì›ëŒ€(ë‹¬ì„±ê³µì›)') {
                    transferBadge = `<span class="w-5 h-5 flex items-center justify-center rounded-full text-white font-bold ml-1 shadow-sm text-[10px]" style="background-color: #FFB100;">3</span>`;
                } else if (stationName === 'ëŒ€êµ¬ì—­' || stationName === 'ë™ëŒ€êµ¬ì—­') {
                    transferBadge = `<span class="w-5 h-5 flex items-center justify-center rounded-full text-white font-bold ml-1 shadow-sm text-[10px]" style="background-color: #D93F5C;">1</span>`;
                }
                
                // ì‚¬ìš©ì ì¶”ê°€ ì—­ ì‚­ì œ ë²„íŠ¼ (ê¸°ë³¸ ì—­ì€ ì‚­ì œ ë¶ˆê°€)
                const isUserAdded = userAdded.includes(stationName) && !defaultStations.includes(stationName);
                const deleteBtn = isUserAdded ? `<button onclick="removeSubwayStation('${currentSubwayRegion}', '${stationName}')" class="absolute top-5 right-5 text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>` : '';

                if (stationName === 'ë¶ì‚¼' || stationName === 'ì›ëŒ€(ë‹¬ì„±ê³µì›)') {
                    // [ìˆ˜ì •] ë¶ì‚¼ ê°œí†µ ì˜ˆì • ë¬¸êµ¬ ë³€ê²½
                    const status = stationName === 'ë¶ì‚¼' ? '2026ë…„ 2ì›” ê°œí†µ ì˜ˆì •' : 'ì°©ê³µ ì˜ˆì •'; 
                    const icon = stationName === 'ë¶ì‚¼' ? 'ğŸš§' : 'ğŸ—ï¸';
                    cardContent = `<div class="toss-card p-5 !bg-[#E6F0FA]/90 border border-blue-100 relative"><div class="flex items-center gap-2.5 mb-4"><span class="badge-daegyeong text-[10px] px-2 py-1 rounded-full text-white font-bold">ëŒ€ê²½ì„ </span><h4 class="text-base font-bold text-main">${stationName}</h4>${transferBadge}<span class="bg-gray-100 text-gray-500 text-[10px] font-bold px-1.5 py-0.5 rounded ml-auto">${status}</span></div><div class="text-center p-4"><div class="text-2xl mb-1">${icon}</div><p class="text-sm font-bold text-main">í˜„ì¬ ${status} ë‹¨ê³„ì…ë‹ˆë‹¤</p></div>${deleteBtn}</div>`;
                } else {
                    const upData = window.getNextTimeFromFile(stationName, ['êµ¬ë¯¸'], dayKey);
                    const downDataKyong = window.getNextTimeFromFile(stationName, ['ê²½ì‚°'], dayKey);
                    const downDataDong = window.getNextTimeFromFile(stationName, ['ë™ëŒ€êµ¬'], dayKey);
                    let upHtml = (stationName !== 'êµ¬ë¯¸ì—­') ? `<div class="glass-item p-3 flex items-center justify-between mb-2"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">ìƒí–‰</div><span class="text-sm font-bold text-main">êµ¬ë¯¸ ë°©ë©´</span></div>${upData.html}</div>` : '';
                    let downHtml = '';
                    if (stationName !== 'ê²½ì‚°ì—­') {
                        downHtml += `<div class="glass-item p-3 flex items-center justify-between mb-2"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">í•˜í–‰</div><span class="text-sm font-bold text-main">ê²½ì‚° ë°©ë©´</span></div>${downDataKyong.html}</div>`;
                        if (stationName !== 'ë™ëŒ€êµ¬ì—­') downHtml += `<div class="glass-item p-3 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">í•˜í–‰</div><span class="text-sm font-bold text-main">ë™ëŒ€êµ¬ ë°©ë©´</span></div>${downDataDong.html}</div>`;
                    }
                    cardContent = `<div class="toss-card p-5 !bg-[#E6F0FA]/90 relative border border-blue-100"><div class="flex items-center gap-2.5 mb-4"><span class="badge-daegyeong text-[10px] px-2 py-1 rounded-full text-white font-bold shadow-sm">ëŒ€ê²½ì„ </span><h4 class="text-base font-bold text-main">${stationName}</h4>${transferBadge}</div><div class="space-y-1">${upHtml}${downHtml}</div>${deleteBtn}</div>`;
                }
                listContainer.insertAdjacentHTML('beforeend', cardContent);
            });
        };

        // 6. UI ì œì–´ í•¨ìˆ˜ë“¤ (Global)
        window.selectRegion = function(region) {
            currentRegion = region;
            ['andong', 'gumi', 'chilgok'].forEach(id => {
                const el = document.getElementById('btn-' + id);
                if (id === region) { el.classList.add('region-card-selected'); el.querySelector('.status-text').innerText = 'ì„ íƒë¨'; }
                else { el.classList.remove('region-card-selected'); el.querySelector('.status-text').innerText = 'ì„ íƒí•˜ê¸°'; }
            });
            window.renderList();
        };

        window.renderList = function() {
            const container = document.getElementById('dynamic-list-container'); const empty = document.getElementById('empty-state');
            container.innerHTML = ''; empty.classList.add('hidden');
            if (!apiKey && currentRegion !== 'andong') { empty.classList.remove('hidden'); return; }
            const cityCode = CITY_CODES[currentRegion]; const targets = stationConfig[currentRegion];
            if (!targets || targets.length === 0) { container.innerHTML = `<div class="text-center py-10 text-gray-400">ë“±ë¡ëœ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒë‹¨ '+ ì •ë¥˜ì¥ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</div>`; return; }
            
            targets.forEach((station, index) => {
                if(currentRegion === 'andong') { window.renderStaticCard(index, station); } 
                else {
                    const skeletonHtml = `<div id="station-card-${index}" class="toss-card p-5 mb-4 !bg-white/50 animate-pulse relative"><div class="flex justify-between items-start mb-4"><div class="flex items-center gap-2.5"><div class="w-10 h-10 rounded-[16px] bg-gray-200"></div><div><div class="h-4 w-32 bg-gray-200 rounded mb-1.5"></div><div class="h-3 w-20 bg-gray-200 rounded"></div></div></div></div><div class="space-y-2"><div class="h-12 bg-gray-200 rounded-xl"></div></div></div>`;
                    container.insertAdjacentHTML('beforeend', skeletonHtml); window.loadStationData(index, cityCode, station);
                }
            });
        };

        window.selectSubwayRegion = function(region) {
            currentSubwayRegion = region;
            ['gumi', 'chilgok', 'daegu', 'gyeongsan'].forEach(id => {
                const el = document.getElementById('sub-btn-' + id);
                if (id === region) { el.classList.add('region-card-selected'); el.querySelector('.status-text').innerText = 'ì„ íƒë¨'; }
                else { el.classList.remove('region-card-selected'); el.querySelector('.status-text').innerText = 'ì„ íƒí•˜ê¸°'; }
            });
            window.renderSubwayStations();
        };

        window.switchTab = function(mode) {
            if (mode === 'bus') {
                document.getElementById('view-bus').classList.remove('hidden'); document.getElementById('view-subway').classList.add('hidden');
                document.getElementById('nav-bus').className = 'nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300';
                document.getElementById('nav-subway').className = 'nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100';
                window.renderList();
            } else {
                document.getElementById('view-bus').classList.add('hidden'); document.getElementById('view-subway').classList.remove('hidden');
                document.getElementById('nav-subway').className = 'nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300';
                document.getElementById('nav-bus').className = 'nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100';
                window.renderSubwayStations();
            }
        };

        // ëª¨ë‹¬ ë° ì„¤ì •
        window.openSearchModal = () => {
            const modal = document.getElementById('search-modal');
            const regionLabel = document.getElementById('search-modal-region');
            const isSubway = !document.getElementById('view-subway').classList.contains('hidden');
            
            // [ìˆ˜ì •] ëª¨ë‹¬ ì˜¤í”ˆ ì‹œ í˜„ì¬ ëª¨ë“œ(ë²„ìŠ¤/ì§€í•˜ì² )ì— ë”°ë¼ ë¼ë²¨ ë³€ê²½
            if (isSubway) {
                const subRegionNames = { 'gumi': 'ê²½ë¶ êµ¬ë¯¸ì‹œ', 'chilgok': 'ê²½ë¶ ì¹ ê³¡êµ°', 'daegu': 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'gyeongsan': 'ê²½ë¶ ê²½ì‚°ì‹œ' };
                regionLabel.innerText = subRegionNames[currentSubwayRegion] || currentSubwayRegion;
                regionLabel.className = "text-xs font-bold text-orange-500 bg-orange-50 px-2 py-0.5 rounded-md inline-block mt-1";
            } else {
                regionLabel.innerText = CITY_NAMES[currentRegion];
                regionLabel.className = "text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md inline-block mt-1";
            }
            
            document.getElementById('add-station-input').value = '';
            document.getElementById('add-station-results').innerHTML = '<p class="text-center text-gray-400 mt-10 text-sm">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
            modal.classList.remove('hidden');
        };

        window.closeSearchModal = () => document.getElementById('search-modal').classList.add('hidden');
        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden');
        
        window.doSearchStation = async () => {
            const query = document.getElementById('add-station-input').value; if(!query) return;
            const resBox = document.getElementById('add-station-results'); 
            const isSubway = !document.getElementById('view-subway').classList.contains('hidden');

            // [ìˆ˜ì •] ì§€í•˜ì²  ëª¨ë“œì¼ ê²½ìš° CSV ë°ì´í„°ì—ì„œ ê²€ìƒ‰
            if (isSubway) {
                if (!GLOBAL_TIMETABLE || GLOBAL_TIMETABLE === "ERROR") {
                    resBox.innerHTML = '<p class="text-center text-red-500 text-xs py-4">ì‹œê°„í‘œ íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>'; return;
                }
                const results = Object.keys(GLOBAL_TIMETABLE).filter(key => key.includes(query) && isNaN(key)); // ìˆ«ìê°€ ì•„ë‹Œ í‚¤(ì—­ëª…)ë§Œ ê²€ìƒ‰
                
                if (results.length === 0) {
                    resBox.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">ê²°ê³¼ ì—†ìŒ</p>'; return;
                }
                
                resBox.innerHTML = results.map(name => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl mb-2">
                        <div><p class="text-sm font-bold text-main">${name}</p><p class="text-[10px] text-gray-400">ì§€í•˜ì² /ê¸°ì°¨</p></div>
                        <button onclick="addSubwayStation('${name}')" class="text-xs bg-orange-100 text-orange-600 font-bold px-3 py-1.5 rounded-lg">ì¶”ê°€</button>
                    </div>
                `).join('');
                return;
            }

            // ê¸°ì¡´ ë²„ìŠ¤ ê²€ìƒ‰ ë¡œì§
            resBox.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-blue-500"></i></div>';
            const results = await window.searchStationAPI(query);
            if(results.error) { resBox.innerHTML = `<p class="text-center text-red-500 text-xs py-4">${results.error}</p>`; return; }
            if(!results || results.length === 0) { resBox.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">ê²°ê³¼ ì—†ìŒ</p>'; return; }
            resBox.innerHTML = results.map(item => `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl mb-2"><div><p class="text-sm font-bold text-main">${item.nodenm}</p><p class="text-[10px] text-gray-400">ID: ${item.nodeid}</p></div><button onclick="addStation('${item.nodenm}', '${item.nodeid}')" class="text-xs bg-blue-100 text-blue-600 font-bold px-3 py-1.5 rounded-lg">ì¶”ê°€</button></div>`).join('');
        };

        window.addStation = (name, id) => { stationConfig[currentRegion].push({ name: name, nodeId: id, sub: 'ì‚¬ìš©ì ì¶”ê°€' }); localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig)); alert('ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'); window.closeSearchModal(); window.renderList(); };
        
        // [ì‹ ê·œ] ì§€í•˜ì²  ì—­ ì¶”ê°€ í•¨ìˆ˜
        window.addSubwayStation = (name) => {
            const userStations = JSON.parse(localStorage.getItem('my_subway_stations_v1')) || {};
            if (!userStations[currentSubwayRegion]) userStations[currentSubwayRegion] = [];
            
            if (userStations[currentSubwayRegion].includes(name)) { alert('ì´ë¯¸ ì¶”ê°€ëœ ì—­ì…ë‹ˆë‹¤.'); return; }
            
            userStations[currentSubwayRegion].push(name);
            localStorage.setItem('my_subway_stations_v1', JSON.stringify(userStations));
            alert('ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'); window.closeSearchModal(); window.renderSubwayStations();
        };

        // [ì‹ ê·œ] ì§€í•˜ì²  ì—­ ì‚­ì œ í•¨ìˆ˜
        window.removeSubwayStation = (region, name) => {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const userStations = JSON.parse(localStorage.getItem('my_subway_stations_v1')) || {};
            if (userStations[region]) {
                userStations[region] = userStations[region].filter(s => s !== name);
                localStorage.setItem('my_subway_stations_v1', JSON.stringify(userStations));
                window.renderSubwayStations();
            }
        };

        window.removeStation = (region, idx) => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { stationConfig[region].splice(idx, 1); localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig)); window.renderList(); } };
        window.saveSettings = () => { const key = document.getElementById('api-key-input').value; const type = document.querySelector('input[name="key-type"]:checked').value; if(key) { apiKey = key; keyType = type; localStorage.setItem('toss_bus_api_key', key); localStorage.setItem('toss_bus_key_type', type); alert('ì €ì¥ë¨'); window.closeSettings(); window.renderList(); } };
        window.resetData = () => { if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { localStorage.removeItem('my_station_config_v40'); localStorage.removeItem('my_subway_stations_v1'); location.reload(); } };
        window.testConnection = async () => { alert("í…ŒìŠ¤íŠ¸ ì‹œì‘: ê²°ê³¼ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”..."); const res = await window.fetchBusArrival('37010', 'DJB8001793'); document.getElementById('test-result').innerHTML = (typeof res === 'string') ? `<span class='text-red-500'>ì‹¤íŒ¨: ${res}</span>` : "<span class='text-green-500'>ì„±ê³µ!</span>"; };

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            if(apiKey) document.getElementById('api-key-input').value = apiKey;
            window.loadTimetable();
            window.selectRegion('andong');
            
            // [IMPORTANT] Start live updates once
            startLiveUpdates();
        });

        // ìŠ¤í¬ë¡¤
        const mainContent = document.getElementById('main-content');
        const island = document.getElementById('dynamic-island');
        mainContent.addEventListener('scroll', () => { island.classList.toggle('island-active', mainContent.scrollTop > 20); });
    </script>
</body>
</html>