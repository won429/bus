<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Realtime Bus & Subway - Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Pretendard', sans-serif;
            background-color: #F2F4F6;
            color: #191F28;
            touch-action: pan-y;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-toss-gradient { background: linear-gradient(to bottom right, #F2F4F6, #E8ECF2, #DEE2E6); }
        .toss-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04); 
            transition: transform 0.1s;
            overflow: hidden;
        }
        .toss-card:active { transform: scale(0.98); }
        .glass-item {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
        }
        .text-main { color: #191F28; }
        .text-sub { color: #6B7684; }
        .pt-safe { padding-top: max(10px, env(safe-area-inset-top)); }
        .pb-safe-nav { padding-bottom: max(80px, env(safe-area-inset-bottom)); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .region-card-selected { background-color: rgba(255, 255, 255, 0.9) !important; border-color: #3182F6 !important; box-shadow: 0 4px 12px rgba(49, 130, 246, 0.15) !important; }
        
        #dynamic-island { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .island-active {
            width: 140px !important; background-color: #191F28 !important; border-radius: 9999px !important;
            margin-top: 10px; padding: 8px 16px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
        }
        .island-active .header-left-group { width: 0; opacity: 0; margin: 0; overflow: hidden; transform: scale(0.8); }
        .island-active .icon-container { width: 100%; justify-content: center; gap: 24px !important; }
        .island-active .icon-bg { background-color: transparent !important; width: auto !important; height: auto !important; box-shadow: none !important; color: white !important; }
        
        @keyframes pulse-custom { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse-custom { animation: pulse-custom 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .btn-kakao { background-color: #FAE100; color: #3C1E1E; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
        .toss-card:hover .delete-btn { opacity: 1; }
        
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nav-pill-active { background-color: #191F28; color: white; }
        .nav-pill-inactive { background-color: transparent; color: #6B7684; }
        
        .badge-daegyeong { background-color: #0054A6; color: white; }
        
        .line-badge { transition: all 0.2s; border: 1px solid transparent; }
        .line-badge-active { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.05); }
        .line-badge-inactive { opacity: 0.5; background-color: #F2F4F6; color: #8B95A1; border-color: #E5E8EB; }

        @keyframes marquee { 
            0% { transform: translateX(0); } 
            100% { transform: translateX(-50%); } 
        }
        .animate-marquee { 
            display: inline-block;
            animation: marquee 15s linear infinite; 
        }

        .timetable-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .time-chip { 
            background: #F2F4F6; padding: 6px 2px; border-radius: 8px; 
            text-align: center; font-size: 13px; font-weight: 500; color: #4E5968; 
            letter-spacing: -0.5px;
        }
        .time-chip.past { color: #ADB5BD; background: #F9FAFB; font-weight: 400; }
        .time-chip.future { color: #1B64DA; background: #E8F3FF; font-weight: 700; }
        .timetable-tab-active { background-color: #ffffff; color: #191F28; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .timetable-tab-inactive { background-color: transparent; color: #8B95A1; }
    </style>
</head>
<body class="w-full h-[100dvh] flex flex-col overflow-hidden bg-toss-gradient">

    <!-- í—¤ë” -->
    <header class="fixed top-0 left-0 w-full z-50 flex justify-center pt-safe pointer-events-none">
        <div id="dynamic-island" class="pointer-events-auto w-full max-w-md px-5 py-2 flex items-center justify-between bg-transparent mx-auto origin-top mt-2">
            <div class="header-left-group flex items-center gap-3 transition-all duration-300 origin-left">
                <a href="https://won429.github.io/enjoysite/" class="text-main text-lg p-1 hover:opacity-60 transition-opacity">
                    <i class="fa-solid fa-chevron-left"></i>
                </a>
                <h1 class="header-title text-xl font-bold text-main whitespace-nowrap">ëŒ€ì¤‘êµí†µ</h1>
            </div>
            
            <div class="icon-container flex gap-2 transition-all duration-300">
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="initCityCodes(false)">
                    <i class="fa-solid fa-arrows-rotate text-sm"></i>
                </div>
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="openSearchModal()">
                    <i class="fa-solid fa-magnifying-glass text-sm"></i>
                </div>
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="openSettings()">
                    <i class="fa-solid fa-gear text-sm"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main id="main-content" class="flex-1 overflow-y-auto scrollbar-hide px-5 pb-safe-nav w-full max-w-md mx-auto relative pt-16">
        
        <!-- [1] ë²„ìŠ¤ ë·° -->
        <div id="view-bus" class="fade-in-up">
            <div class="mb-6 fade-in-up delay-100">
                <h3 class="text-lg font-bold text-main mb-3 px-1">ì§€ì—­ ì„ íƒ</h3>
                
                <div class="flex gap-2 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1 mb-1">
                    <button onclick="selectBusBroadRegion('daegu')" id="bus-broad-btn-daegu" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ëŒ€êµ¬ê¶Œ</span>
                    </button>
                    <button onclick="selectBusBroadRegion('busan')" id="bus-broad-btn-busan" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ë¶€ì‚°ê¶Œ</span>
                    </button>
                    <button onclick="selectBusBroadRegion('chungcheong')" id="bus-broad-btn-chungcheong" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ì¶©ì²­ê¶Œ</span>
                    </button>
                    <button onclick="selectBusBroadRegion('gwangju')" id="bus-broad-btn-gwangju" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ê´‘ì£¼ì „ë‚¨</span>
                    </button>
                    <button onclick="selectBusBroadRegion('gyeongbuk')" id="bus-broad-btn-gyeongbuk" class="toss-card region-card-selected min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-main">ê²½ë¶</span>
                    </button>
                    <button onclick="selectBusBroadRegion('gyeongnam')" id="bus-broad-btn-gyeongnam" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ê²½ë‚¨</span>
                    </button>
                    <button onclick="selectBusBroadRegion('jeonju')" id="bus-broad-btn-jeonju" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ì „ì£¼ê¶Œ</span>
                    </button>
                </div>

                <div id="bus-specific-region-container" class="flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1 min-h-[90px]">
                    <!-- JS ë Œë”ë§ -->
                </div>

                <p id="city-code-status" class="text-[10px] text-gray-400 mt-2 px-1 text-right cursor-pointer hover:text-blue-500" onclick="initCityCodes(false)">ë„ì‹œ ì½”ë“œ ì¡°íšŒ ëŒ€ê¸°ì¤‘...</p>
            </div>

            <div class="mb-4 fade-in-up delay-200">
                <div class="flex justify-between items-end mb-3 px-1">
                    <div>
                        <h3 class="text-lg font-bold text-main">ë„ì°© ì •ë³´</h3>
                        <span class="text-xs font-medium text-sub" id="region-status-label">ì•ˆë™ì‹œ</span>
                    </div>
                    <button id="add-btn-main" onclick="openSearchModal()" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors shadow-sm">
                        + ì •ë¥˜ì¥ ì¶”ê°€
                    </button>
                </div>
                
                <div id="dynamic-list-container" class="space-y-4"></div>
                
                <div id="empty-state" class="hidden text-center py-10 bg-white/40 rounded-3xl border border-white/60">
                    <i class="fa-solid fa-key text-3xl text-gray-300 mb-2"></i>
                    <p class="text-sm font-bold text-gray-500">API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
                    <p class="text-xs text-gray-400 mt-1">
                        ì„¤ì •(ìš°ì¸¡ ìƒë‹¨ í†±ë‹ˆë°”í€´)ì—ì„œ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>
                        ì•ˆë™ì‹œëŠ” í‚¤ ì—†ì´ë„ ì‹œê°„í‘œ ëª¨ë“œë¡œ ì‘ë™í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>

        <!-- [2] ì§€í•˜ì²  ë·° -->
        <div id="view-subway" class="hidden fade-in-up">
            <div class="mb-4 fade-in-up delay-100">
                <h3 class="text-lg font-bold text-main mb-3 px-1">ì§€ì—­ ì„ íƒ</h3>
                
                <div class="flex gap-2 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1 mb-1">
                    <button onclick="selectBroadRegion('daegu')" id="broad-btn-daegu" class="toss-card region-card-selected min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-main">ëŒ€êµ¬ê¶Œ</span>
                    </button>
                    <button onclick="selectBroadRegion('busan')" id="broad-btn-busan" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ë¶€ì‚°ê¶Œ</span>
                    </button>
                    <button onclick="selectBroadRegion('chungcheong')" id="broad-btn-chungcheong" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ì¶©ì²­ê¶Œ</span>
                    </button>
                    <button onclick="selectBroadRegion('gwangju')" id="broad-btn-gwangju" class="toss-card min-w-[60px] h-[40px] px-3 flex justify-center items-center cursor-pointer transition-all whitespace-nowrap">
                        <span class="text-xs font-bold text-gray-400">ê´‘ì£¼ì „ë‚¨</span>
                    </button>
                </div>

                <div id="subway-specific-region-container" class="flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1 min-h-[90px]">
                    <!-- JS ë Œë”ë§ -->
                </div>
            </div>

            <div class="px-1 fade-in-up delay-200">
                <div class="mb-3">
                    <h3 class="text-lg font-bold text-main mb-2">ë…¸ì„  ì„ íƒ</h3>
                    <div id="subway-line-badges" class="flex flex-wrap gap-2"></div>
                    
                    <div id="subway-notice" class="hidden mt-3 bg-red-50 border border-red-100 rounded-lg overflow-hidden py-2.5">
                        <div class="whitespace-nowrap animate-marquee">
                            <span class="text-xs font-bold text-red-500 mr-8"><i class="fa-solid fa-triangle-exclamation mr-1"></i>ì²­ë„ ì—´ì°¨ ì‚¬ê³ ë¡œ ìš´í–‰ íšŸìˆ˜ 100íšŒ -> 98íšŒë¡œ 2íšŒ ê°ì†Œ ë° ì§€ì—° ë°œìƒ ê°€ëŠ¥</span>
                            <span class="text-xs font-bold text-red-500 mr-8"><i class="fa-solid fa-triangle-exclamation mr-1"></i>ì²­ë„ ì—´ì°¨ ì‚¬ê³ ë¡œ ìš´í–‰ íšŸìˆ˜ 100íšŒ -> 98íšŒë¡œ 2íšŒ ê°ì†Œ ë° ì§€ì—° ë°œìƒ ê°€ëŠ¥</span>
                        </div>
                    </div>
                </div>
                <div id="subway-station-list" class="space-y-3"></div>
            </div>
        </div>

        <div class="h-20"></div>
    </main>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="fixed bottom-8 left-0 w-full z-[60] flex justify-center pointer-events-none">
        <div class="pointer-events-auto bg-white/90 backdrop-blur-xl border border-white/50 rounded-full p-1.5 shadow-2xl shadow-black/10 flex gap-1 scale-105">
            <button onclick="switchTab('bus')" id="nav-bus" class="nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300">
                <i class="fa-solid fa-bus"></i><span>ë²„ìŠ¤</span>
            </button>
            <button onclick="switchTab('subway')" id="nav-subway" class="nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100">
                <i class="fa-solid fa-train-subway"></i><span>ì§€í•˜ì² </span>
            </button>
        </div>
    </nav>

    <!-- ê²€ìƒ‰ ëª¨ë‹¬ -->
    <div id="search-modal" class="hidden fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-5">
        <div class="bg-white w-full max-w-sm h-[85vh] sm:h-[80vh] sm:rounded-[32px] rounded-t-[32px] p-6 shadow-2xl scale-100 transition-all flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none">
                <div>
                    <h3 class="text-xl font-bold text-main">ì •ë¥˜ì¥ ì¶”ê°€</h3>
                    <p class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md inline-block mt-1" id="search-modal-region">ì•ˆë™ì‹œ</p>
                </div>
                <button onclick="closeSearchModal()" class="text-gray-400 hover:text-gray-600 bg-gray-100 w-8 h-8 rounded-full"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div id="andong-manual-guide" class="mb-4 hidden">
                <div class="bg-blue-50 p-4 rounded-2xl mb-4">
                    <p class="text-sm font-bold text-main mb-1">ê³ ì • ì‹œê°„í‘œ ëª¨ë“œ</p>
                    <p class="text-xs text-gray-500">ì•ˆë™ì‹œëŠ” ì‹œê°„í‘œ íŒŒì¼(CSV)ì— ìˆëŠ” ì •ë¥˜ì¥ì„ ìë™ìœ¼ë¡œ í‘œì‹œí•˜ê±°ë‚˜, ì§ì ‘ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <div id="api-search-box" class="flex gap-2 mb-2 flex-none">
                <input type="text" id="add-station-input" placeholder="ì •ë¥˜ì¥ëª… ê²€ìƒ‰" class="flex-1 bg-gray-100 rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.keyCode==13) doSearchStation()">
                <button onclick="doSearchStation()" class="bg-blue-500 text-white rounded-2xl px-4 py-3 text-sm font-bold whitespace-nowrap">ê²€ìƒ‰</button>
            </div>
            
            <div id="add-station-results" class="flex-1 overflow-y-auto space-y-2 border-t border-gray-100 pt-2 min-h-0">
                <p class="text-center text-gray-400 mt-10 text-sm">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>

    <!-- ì‹œê°„í‘œ ëª¨ë‹¬ -->
    <div id="timetable-modal" class="hidden fixed inset-0 z-[80] bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-5">
        <div class="bg-white w-full max-w-sm h-[85vh] sm:h-[80vh] sm:rounded-[32px] rounded-t-[32px] p-6 shadow-2xl scale-100 transition-all flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none">
                <div>
                    <h3 class="text-xl font-bold text-main" id="timetable-title">ì •ë¥˜ì¥ëª…</h3>
                    <p class="text-xs text-gray-500">ì „ì²´ ì‹œê°„í‘œ ì¡°íšŒ</p>
                </div>
                <button onclick="closeTimetableModal()" class="text-gray-400 hover:text-gray-600 bg-gray-100 w-8 h-8 rounded-full"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div class="flex p-1 bg-gray-100 rounded-2xl mb-4 flex-none">
                <button onclick="switchTimetableTab('weekday')" id="tab-weekday" class="flex-1 py-2.5 rounded-xl text-xs font-bold transition-all timetable-tab-active">í‰ì¼</button>
                <button onclick="switchTimetableTab('saturday')" id="tab-saturday" class="flex-1 py-2.5 rounded-xl text-xs font-bold transition-all timetable-tab-inactive">í† ìš”ì¼</button>
                <button onclick="switchTimetableTab('holiday')" id="tab-holiday" class="flex-1 py-2.5 rounded-xl text-xs font-bold transition-all timetable-tab-inactive">íœ´ì¼</button>
            </div>

            <div id="timetable-content" class="flex-1 overflow-y-auto space-y-6 min-h-0 pb-10 pr-1 custom-scrollbar"></div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center p-5">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl scale-95 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-main">ì„¤ì •</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-2">ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤ (êµ¬ë¯¸/ì¹ ê³¡ìš©)</label>
                <input type="text" id="api-key-input" placeholder="ì¸ì¦í‚¤ ë¶™ì—¬ë„£ê¸°" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <p id="key-source-indicator" class="text-[10px] text-blue-500 mt-1 hidden"><i class="fa-solid fa-check"></i> ì½”ë“œì— ì…ë ¥ëœ í‚¤ê°€ ìë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="flex gap-4 mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="key-type" value="decoding" checked class="w-4 h-4 text-blue-500">
                    <span class="text-sm text-gray-600">Decoding (ì¼ë°˜)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="key-type" value="encoding" class="w-4 h-4 text-blue-500">
                    <span class="text-sm text-gray-600">Encoding</span>
                </label>
            </div>

            <div class="mb-6 bg-gray-50 p-4 rounded-2xl">
                <h4 class="text-xs font-bold text-main mb-2">ğŸ“„ ì‹œê°„í‘œ íŒŒì¼ ì—°ë™ (ì•ˆë™ë²„ìŠ¤ & ëŒ€ê²½ì„ )</h4>
                <div class="text-[10px] text-gray-500 space-y-1">
                    <p>1. ë²„ìŠ¤: <b>ID, ë²ˆí˜¸, ë°©ë©´, ìš”ì¼, ì‹œê°„...</b> (ìˆ«ì ID ì‹œì‘)</p>
                    <p>2. ì§€í•˜ì² : <b>ì—­ëª…, ë…¸ì„ , ë°©ë©´, ìš”ì¼, ì‹œê°„...</b> (ë¬¸ì ì—­ëª… ì‹œì‘)</p>
                    <p>3. <b>timetable.csv</b> íŒŒì¼ì— í†µí•©í•˜ì—¬ ì €ì¥í•˜ì„¸ìš”.</p>
                </div>
            </div>

            <div class="space-y-2 mb-4">
                <button onclick="initCityCodes(false)" class="w-full bg-orange-50 text-orange-600 font-bold py-3 rounded-2xl hover:bg-orange-100 transition-colors text-sm">
                    <i class="fa-solid fa-sync"></i> ë„ì‹œ ì½”ë“œ APIë¡œ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜)
                </button>
                <button onclick="testConnection()" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-2xl hover:bg-gray-200 transition-colors text-sm">
                    <i class="fa-solid fa-stethoscope"></i> API ì—°ê²° í…ŒìŠ¤íŠ¸ (êµ¬ë¯¸/ì¹ ê³¡)
                </button>
            </div>

            <button onclick="saveSettings()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-500/20 transition-all active:scale-95">ì €ì¥í•˜ê¸°</button>
            
            <div id="test-result" class="mt-4 p-3 bg-gray-50 rounded-xl text-xs text-gray-500 hidden break-all"></div>

            <div class="mt-4 text-center border-t border-gray-100 pt-4">
                <button onclick="resetData()" class="text-[10px] text-red-400 underline">ë°ì´í„° ê°•ì œ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // [í•„ìˆ˜] API ì¸ì¦í‚¤ ì…ë ¥ë€ (ì•„ë˜ ë”°ì˜´í‘œ ì‚¬ì´ì— Decoding í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)
        // =================================================================================
        const MANUAL_API_KEY = "61a63f368537b5e5660bb073ed3d610de59c4982ec365edafebcfd749b87bc93"; 
        // =================================================================================

        const ANDONG_DEFAULT_STATIONS = [
            { name: "êµ­ë¦½ì•ˆë™ëŒ€í•™êµ", nodeId: "370000023", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" },
            { name: "CGV ê±´ë„ˆ", nodeId: "370000998", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" }, 
            { name: "ì•ˆë™í„°ë¯¸ë„(ì•ˆë™ì—­)", nodeId: "354000416", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" } 
        ];
        
        let stationConfig = JSON.parse(localStorage.getItem('my_station_config_v40')) || { 
            andong: ANDONG_DEFAULT_STATIONS, gumi: [], chilgok: [], daejeon: [], busan_city: [], daegu: [], gwangju_city: [], jinju: [], iksan: []
        };
        
        ['daegu', 'gwangju_city', 'jinju', 'iksan', 'daejeon', 'busan_city'].forEach(key => {
            if (!stationConfig[key]) stationConfig[key] = [];
        });

        if (!stationConfig.andong || stationConfig.andong.length === 0) stationConfig.andong = ANDONG_DEFAULT_STATIONS;
        
        localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig));

        let CITY_CODES = { 
            'andong': '37010', 
            'gumi': '37030', 
            'chilgok': '37380', 
            'daejeon': '25', 
            'busan_city': '21',
            'daegu': '22',
            'gwangju_city': '24',
            'jinju': '38030',
            'iksan': '35030'
        };
        
        const CITY_NAMES = { 
            'andong': 'ì•ˆë™ì‹œ', 
            'gumi': 'êµ¬ë¯¸ì‹œ', 
            'chilgok': 'ì¹ ê³¡êµ°', 
            'daegu': 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
            'busan_city': 'ë¶€ì‚°ê´‘ì—­ì‹œ',
            'daejeon': 'ëŒ€ì „ê´‘ì—­ì‹œ',
            'gwangju_city': 'ê´‘ì£¼ê´‘ì—­ì‹œ',
            'jinju': 'ì§„ì£¼ì‹œ',
            'iksan': 'ìµì‚°ì‹œ'
        };
        
        let currentRegion = 'andong';
        let currentBusBroadRegion = 'gyeongbuk'; 
        let currentSubwayRegion = 'gumi';
        let currentSubwayBroadRegion = 'daegu'; 
        let currentSubwayLine = 'daegyeong';

        const SUBWAY_LINES_META = {
            '1': { name: '1í˜¸ì„ ', color: '#D93F5C' },
            '2': { name: '2í˜¸ì„ ', color: '#00AA80' },
            '3': { name: '3í˜¸ì„ ', color: '#FFB100' },
            'daegyeong': { name: 'ëŒ€ê²½ì„ ', color: '#0054A6' },
            'busan1': { name: '1í˜¸ì„ ', color: '#F06A00' },
            'busan2': { name: '2í˜¸ì„ ', color: '#81BF48' },
            'busan3': { name: '3í˜¸ì„ ', color: '#BB8C00' },
            'busan4': { name: '4í˜¸ì„ ', color: '#217DCB' },
            'bgl': { name: 'ë¶€ì‚°ê¹€í•´ê²½ì „ì² ', color: '#8652A1' },
            'donghae': { name: 'ë™í•´ì„ ', color: '#003DA5' },
            'yangsan_line': { name: 'ì–‘ì‚°ì„ ', color: '#77C4A3' },
            'daejeon1': { name: '1í˜¸ì„ ', color: '#007448' },
            'daejeon2': { name: '2í˜¸ì„ ', color: '#55A630' },
            'chungcheong_wide': { name: 'ì¶©ì²­ê¶Œ ê´‘ì—­ì² ë„', color: '#AECC54' },
            'gwangju1': { name: '1í˜¸ì„ ', color: '#009088' },
            'gwangju2': { name: '2í˜¸ì„ ', color: '#0072C6' }
        };

        const SUBWAY_DATA = {
            'daegyeong': {
                name: 'ëŒ€ê²½ì„ ',
                color: 'badge-daegyeong',
                stations: {
                    'gumi': ['êµ¬ë¯¸ì—­', 'ì‚¬ê³¡'], 
                    'chilgok': ['ë¶ì‚¼', 'ì™œê´€ì—­'], 
                    'daegu': ['ì„œëŒ€êµ¬ì—­', 'ì›ëŒ€(ë‹¬ì„±ê³µì›)', 'ëŒ€êµ¬ì—­', 'ë™ëŒ€êµ¬ì—­'], 
                    'gyeongsan': ['ê²½ì‚°ì—­']
                }
            }
        };

        const REGION_LINES = {
            'gumi': ['daegyeong'],
            'chilgok': ['daegyeong'],
            'daegu': ['daegyeong', '1', '2', '3'],
            'gyeongsan': ['daegyeong', '1', '2'],
            'busan_city': ['busan1', 'busan2', 'busan3', 'busan4', 'bgl', 'donghae', 'yangsan_line'],
            'ulsan': ['donghae'],
            'gimhae': ['bgl'],
            'yangsan': ['yangsan_line'],
            'daejeon': ['daejeon1', 'daejeon2', 'chungcheong_wide'],
            'gwangju_city': ['gwangju1', 'gwangju2']
        };

        const BROAD_REGION_DATA_BUS = {
            'daegu': [
                { id: 'daegu', name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ', icon: 'fa-building', color: 'blue' }, 
                { id: 'gumi', name: 'êµ¬ë¯¸ì‹œ', icon: 'fa-city', color: 'orange' },
                { id: 'chilgok', name: 'ì¹ ê³¡êµ°', icon: 'fa-tree', color: 'emerald' }
            ],
            'gyeongbuk': [
                { id: 'andong', name: 'ì•ˆë™ì‹œ', icon: 'fa-location-dot', color: 'purple' }
            ],
            'busan': [
                { id: 'busan_city', name: 'ë¶€ì‚°ê´‘ì—­ì‹œ', icon: 'fa-ship', color: 'blue' }
            ],
            'chungcheong': [
                { id: 'daejeon', name: 'ëŒ€ì „ê´‘ì—­ì‹œ', icon: 'fa-flask', color: 'cyan' }
            ],
            'gwangju': [
                { id: 'gwangju_city', name: 'ê´‘ì£¼ê´‘ì—­ì‹œ', icon: 'fa-building', color: 'teal' } 
            ],
            'gyeongnam': [
                { id: 'jinju', name: 'ì§„ì£¼ì‹œ', icon: 'fa-layer-group', color: 'indigo' } 
            ],
            'jeonju': [
                { id: 'iksan', name: 'ìµì‚°ì‹œ', icon: 'fa-train', color: 'yellow' } 
            ]
        };

        const BROAD_REGION_DATA = {
            'daegu': [
                { id: 'gumi', name: 'ê²½ë¶ êµ¬ë¯¸ì‹œ', icon: 'fa-train-subway', color: 'orange' },
                { id: 'chilgok', name: 'ê²½ë¶ ì¹ ê³¡êµ°', icon: 'fa-train', color: 'emerald' },
                { id: 'daegu', name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ', icon: 'fa-subway', color: 'blue' },
                { id: 'gyeongsan', name: 'ê²½ë¶ ê²½ì‚°ì‹œ', icon: 'fa-train-tram', color: 'indigo' }
            ],
            'busan': [
                { id: 'busan_city', name: 'ë¶€ì‚°ê´‘ì—­ì‹œ', icon: 'fa-train-subway', color: 'blue' },
                { id: 'ulsan', name: 'ìš¸ì‚°ê´‘ì—­ì‹œ', icon: 'fa-train', color: 'cyan' },
                { id: 'gimhae', name: 'ê²½ë‚¨ ê¹€í•´ì‹œ', icon: 'fa-train-tram', color: 'teal' },
                { id: 'yangsan', name: 'ê²½ë‚¨ ì–‘ì‚°ì‹œ', icon: 'fa-subway', color: 'emerald' }
            ],
            'chungcheong': [
                { id: 'daejeon', name: 'ëŒ€ì „ê´‘ì—­ì‹œ', icon: 'fa-subway', color: 'green' }
            ],
            'gwangju': [
                { id: 'gwangju_city', name: 'ê´‘ì£¼ê´‘ì—­ì‹œ', icon: 'fa-subway', color: 'teal' }
            ]
        };

        let apiKey = MANUAL_API_KEY || localStorage.getItem('toss_bus_api_key') || '';
        let keyType = localStorage.getItem('toss_bus_key_type') || 'decoding'; 
        
        const TIMETABLE_FILE_NAME = "timetable.csv";
        const TIMETABLE_URL = TIMETABLE_FILE_NAME; 
        
        let GLOBAL_TIMETABLE = null; 
        
        let currentTimetableKey = null;
        let currentTimetableDay = 'weekday';
        let refreshInterval = null;

        function getEncodedKey() {
            if (!apiKey) return '';
            return keyType === 'encoding' ? apiKey : encodeURIComponent(apiKey);
        }

        function normalizeBusData(bus) {
            if (!bus) return null;
            let type = bus.routeTp || bus.routeType || bus.ROUTETP || '';
            const routeNoStr = (bus.routeno || bus.routeNo || '?').toString();
            if (!type) {
                if (routeNoStr.includes('ê¸‰í–‰')) type = 'ê¸‰í–‰';
                else if (routeNoStr.includes('ì¢Œì„')) type = 'ì¢Œì„';
                else if (routeNoStr.includes('ìˆœí™˜')) type = 'ìˆœí™˜';
                else if (routeNoStr.includes('ë§ˆì„')) type = 'ë§ˆì„';
            }
            return {
                ...bus,
                routeno: routeNoStr,
                endnodenm: bus.endnodenm || bus.endNodeNm || 'ì¢…ì ë¯¸ìƒ',
                arrtime: bus.arrtime || bus.arrTime,
                arrprevstationcnt: bus.arrprevstationcnt || bus.arrPrevStationCnt,
                routeTp: type
            };
        }

        function parseHybrid(text) {
            try { return { type: 'json', data: JSON.parse(text) }; } catch(e) { }
            if (text.includes('<OpenAPI_ServiceResponse>')) {
                if (text.includes('SERVICE_KEY')) return { type: 'error', msg: 'API í‚¤ ì˜¤ë¥˜ (ì¸ì¦ ì‹¤íŒ¨)' };
                return { type: 'error', msg: 'ê³µê³µë°ì´í„° ì„œë²„ ì˜¤ë¥˜' };
            }
            return { type: 'error', msg: 'ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ í˜•ì‹' };
        }
        
        function parseBusanXml(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const header = xmlDoc.getElementsByTagName("header")[0];
            if(header) {
                const resultCode = header.getElementsByTagName("resultCode")[0]?.textContent;
                const resultMsg = header.getElementsByTagName("resultMsg")[0]?.textContent;
                if(resultCode !== "00") return { type: 'error', msg: resultMsg || 'API Error' };
            }
            const items = xmlDoc.getElementsByTagName("item");
            const result = [];
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const obj = {};
                for (let j = 0; j < item.children.length; j++) {
                    const node = item.children[j];
                    obj[node.tagName] = node.textContent;
                }
                result.push(obj);
            }
            return result;
        }

        function renderBadge(diffSeconds, timeStr) {
            const now = Date.now();
            const targetTime = now + (diffSeconds * 1000);
            const min = Math.floor(diffSeconds / 60);
            const sec = diffSeconds % 60;
            let badgeClass = "bg-gray-100 text-gray-500 border border-gray-200";
            let timeText = `${min}ë¶„ í›„ ë„ì°©`;
            if (min < 5) { 
                badgeClass = "bg-red-50 text-red-600 border border-red-100";
                if (min === 0) { timeText = `${sec}ì´ˆ í›„ ë„ì°©`; }
            }
            const timeHtml = timeStr ? `<span class="text-[10px] text-gray-400 font-medium whitespace-nowrap">(${timeStr})</span>` : '';
            return `
                <div class="flex items-center justify-end gap-2 shrink-0 ml-auto">
                    ${timeHtml}
                    <span class="${badgeClass} live-badge px-2 py-0.5 rounded-md text-xs font-bold shadow-sm whitespace-nowrap" data-target="${targetTime}">${timeText}</span>
                </div>
            `;
        }

        function startLiveUpdates() {
            setInterval(() => {
                const now = Date.now();
                document.querySelectorAll('.live-badge').forEach(el => {
                    const target = parseInt(el.getAttribute('data-target'));
                    if (!target) return;
                    const diffMs = target - now;
                    const diffSec = Math.ceil(diffMs / 1000);
                    const baseClasses = "live-badge px-2 py-0.5 rounded-md text-xs font-bold shadow-sm whitespace-nowrap";
                    const redClasses = "bg-red-50 text-red-600 border border-red-100";
                    const grayClasses = "bg-gray-100 text-gray-500 border border-gray-200";
                    if (diffSec <= 0) {
                        el.innerText = "ê³§ ë„ì°©";
                        el.className = `${baseClasses} ${redClasses}`;
                    } else if (diffSec < 60) {
                        el.innerText = `${diffSec}ì´ˆ í›„ ë„ì°©`;
                        el.className = `${baseClasses} ${redClasses}`;
                    } else {
                        const min = Math.floor(diffSec / 60);
                        el.innerText = `${min}ë¶„ í›„ ë„ì°©`;
                        if (min < 5) {
                            el.className = `${baseClasses} ${redClasses}`;
                        } else {
                            el.className = `${baseClasses} ${grayClasses}`;
                        }
                    }
                });
            }, 1000);
        }

        window.fetchWithFallback = async function(targetUrl) {
            const timestamp = `&_=${Date.now()}`; 
            if (targetUrl === TIMETABLE_FILE_NAME) {
                try {
                    const response = await fetch(TIMETABLE_FILE_NAME);
                    if (!response.ok) throw new Error(`File load failed`);
                    return await response.text();
                } catch (e) {
                    console.error("Local file load failed:", e.message);
                    throw new Error("Local file load failed");
                }
            }
            const proxies = [
                url => `https://corsproxy.io/?${encodeURIComponent(url + timestamp)}`,
                url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url + timestamp)}`,
                url => `https://api.cors.lol/?url=${encodeURIComponent(url + timestamp)}`
            ];
            for (const makeProxyUrl of proxies) {
                try {
                    const response = await fetch(makeProxyUrl(targetUrl));
                    if (response.ok) return await response.text();
                } catch (e) { console.warn("Proxy failed, trying next...", e); }
            }
            throw new Error("All proxies failed");
        };

        window.fetchBusArrival = async function(cityCode, nodeId) {
            if (!apiKey || !nodeId) return null;
            const serviceKey = getEncodedKey();
            if (cityCode === '21' || cityCode === 'busan_city') {
                 const targetUrl = `http://apis.data.go.kr/6260000/BusanBIMS/stopArrByBstopid?serviceKey=${serviceKey}&bstopid=${nodeId}&numOfRows=100&pageNo=1`;
                 try {
                    const text = await window.fetchWithFallback(targetUrl);
                    const rawItems = parseBusanXml(text);
                    if (rawItems.type === 'error') return rawItems.msg;
                    const arrivals = [];
                    rawItems.forEach(item => {
                        const routeTp = item.bustype;
                        const routeNo = item.lineno;
                        const routeId = item.lineid;
                        if (item.min1) {
                            let arrTime = 9999;
                            if(!isNaN(item.min1)) arrTime = parseInt(item.min1) * 60;
                            else if(item.min1.includes('ê³§')) arrTime = 30;
                            else if(item.min1.includes('ëŒ€ê¸°')) arrTime = 999999;
                            if(arrTime < 999999) {
                                arrivals.push({ routeno: routeNo, routeid: routeId, arrtime: arrTime, arrprevstationcnt: item.station1, routeTp: routeTp, vehicleno: item.carno1, endnodenm: 'ë¶€ì‚°' });
                            }
                        }
                        if (item.min2) {
                            let arrTime = 9999;
                            if(!isNaN(item.min2)) arrTime = parseInt(item.min2) * 60;
                            else if(item.min2.includes('ê³§')) arrTime = 30;
                            else if(item.min2.includes('ëŒ€ê¸°')) arrTime = 999999; 
                            if(arrTime < 999999) {
                                arrivals.push({ routeno: routeNo, routeid: routeId, arrtime: arrTime, arrprevstationcnt: item.station2, routeTp: routeTp, vehicleno: item.carno2, endnodenm: 'ë¶€ì‚°' });
                            }
                        }
                    });
                    return arrivals;
                 } catch (error) { return "NETWORK_ERROR"; }
            }
            const targetUrl = `http://apis.data.go.kr/1613000/ArvlInfoInqireService/getSttnAcctoArvlPrearngeInfoList?serviceKey=${serviceKey}&cityCode=${cityCode}&nodeId=${nodeId}&numOfRows=100&pageNo=1&_type=json`;
            try {
                const text = await window.fetchWithFallback(targetUrl);
                const result = parseHybrid(text);
                if (result.type === 'error') return result.msg;
                const data = result.data;
                if (data.response?.header?.resultCode !== '00') return data.response?.header?.resultMsg || "API_ERROR";
                const items = data.response.body.items?.item;
                if (!items) return []; 
                const list = Array.isArray(items) ? items : [items];
                return list.map(normalizeBusData);
            } catch (error) { return "NETWORK_ERROR"; }
        };

        window.fetchBusLocation = async function(cityCode, routeId) {
            if (!apiKey || !routeId) return null;
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/BusLhcisonInfoInqireService/getBusPosByRoutSttnList?serviceKey=${serviceKey}&cityCode=${cityCode}&routeId=${routeId}&numOfRows=100&pageNo=1&_type=json`;
            try {
                const text = await window.fetchWithFallback(targetUrl);
                const result = parseHybrid(text);
                if (result.type === 'error') return null;
                const items = result.data.response.body.items?.item;
                if (!items) return [];
                return Array.isArray(items) ? items : [items];
            } catch (e) { return null; }
        };

        window.searchStationAPI = async function(keyword) {
            const serviceKey = getEncodedKey();
            const targetCityCode = CITY_CODES[currentRegion];
            if (currentRegion === 'busan_city') {
                const targetUrl = `http://apis.data.go.kr/6260000/BusanBIMS/busStopList?serviceKey=${serviceKey}&bstopnm=${encodeURIComponent(keyword)}&numOfRows=100&pageNo=1`;
                try {
                    const text = await window.fetchWithFallback(targetUrl);
                    const rawItems = parseBusanXml(text);
                    if (rawItems.type === 'error') return { error: rawItems.msg };
                    return rawItems.map(item => ({ nodenm: item.bstopnm, nodeid: item.bstopid, arsno: item.arsno }));
                } catch(e) { return { error: "NETWORK_ERROR" }; }
            }
            let targetUrl = `http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getSttnNoList?serviceKey=${serviceKey}&cityCode=${targetCityCode}&numOfRows=500&_type=json`;
            targetUrl += `&nodeNm=${encodeURIComponent(keyword)}`;
            try {
                const text = await window.fetchWithFallback(targetUrl);
                const result = parseHybrid(text);
                if (result.type === 'error') return { error: result.msg };
                const items = result.data.response.body.items?.item;
                if (!items) return [];
                const list = Array.isArray(items) ? items : [items];
                return list.map(normalizeBusData);
            } catch (e) { return { error: "NETWORK_ERROR" }; }
        };

        window.initCityCodes = async function(isSilent = false) {
            const resultBox = document.getElementById('test-result');
            const statusText = document.getElementById('city-code-status');
            if (!apiKey) { 
                if(!isSilent) alert("API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”."); 
                return; 
            }
            if(!isSilent) {
                resultBox.classList.remove('hidden');
                resultBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë„ì‹œ ì½”ë“œ ìŠ¤ìº” ì¤‘...';
            } else {
                if(statusText) statusText.innerText = "ë„ì‹œ ì½”ë“œ ê°±ì‹  ì¤‘...";
            }
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getCtyCodeList?serviceKey=${serviceKey}&_type=json`;
            try {
                const text = await window.fetchWithFallback(targetUrl);
                const result = parseHybrid(text);
                if (result.type === 'error') { 
                    if(!isSilent) resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ${result.msg}</span>`; 
                    if(statusText) statusText.innerText = "ì½”ë“œ ê°±ì‹  ì‹¤íŒ¨";
                    return; 
                }
                const items = result.data.response.body.items.item;
                const list = Array.isArray(items) ? items : [items];
                list.forEach(city => {
                    if (city.cityname.includes('ì•ˆë™')) CITY_CODES.andong = city.citycode;
                    if (city.cityname.includes('êµ¬ë¯¸')) CITY_CODES.gumi = city.citycode;
                    if (city.cityname.includes('ì¹ ê³¡')) CITY_CODES.chilgok = city.citycode;
                    if (city.cityname.includes('ëŒ€ì „')) CITY_CODES.daejeon = city.citycode;
                    if (city.cityname.includes('ë¶€ì‚°')) CITY_CODES.busan_city = city.citycode;
                });
                localStorage.setItem('my_city_codes', JSON.stringify(CITY_CODES));
                if(!isSilent) resultBox.innerHTML = `<span class="text-green-600 font-bold">âœ… ë„ì‹œ ì½”ë“œ ê°±ì‹  ì™„ë£Œ!</span>`;
                if(statusText) statusText.innerText = "ìµœì‹  ë„ì‹œ ì½”ë“œ ì‚¬ìš© ì¤‘";
            } catch (e) { 
                if(!isSilent) resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</span>`; 
                if(statusText) statusText.innerText = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜";
            }
        };

        window.loadTimetable = async function() {
            if (!TIMETABLE_URL) return;
            try {
                const response = await fetch(TIMETABLE_URL);
                if (!response.ok) {
                    console.warn(`[File Load Warning] File load failed with status: ${response.status}`);
                    GLOBAL_TIMETABLE = "ERROR";
                    return;
                }
                const text = await response.text();
                window.parseTimetable(text);
                console.log("í†µí•© ì‹œê°„í‘œ ë¡œë“œ ì™„ë£Œ");
            } catch (e) {
                console.warn("ì‹œê°„í‘œ ë¡œë“œ ì‹¤íŒ¨:", e.message || e);
                GLOBAL_TIMETABLE = "ERROR";
            }
            // ì•ˆì „í•˜ê²Œ í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ í˜¸ì¶œ
            if(typeof window.renderList === 'function' && currentRegion === 'andong' && !document.getElementById('view-bus').classList.contains('hidden')) {
                window.renderList();
            }
            if(typeof window.renderSubwayStations === 'function' && !document.getElementById('view-subway').classList.contains('hidden')) {
                window.renderSubwayStations();
            }
        };

        window.parseTimetable = function(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const table = {};
            lines.forEach((line, index) => {
                if (index === 0) return; 
                const cols = line.split(',').map(c => c.trim());
                if (cols.length < 5) return; 
                const key = cols[0]; const routeName = cols[1]; const dest = cols[2]; let dayType = cols[3]; 
                const dayMap = { 'í‰ì¼': ['weekday'], 'í† ìš”ì¼': ['saturday'], 'ì¼ìš”ì¼': ['holiday'], 'ê³µíœ´ì¼': ['holiday'], 'ë§¤ì¼': ['weekday', 'saturday', 'holiday'], 'ì£¼ë§': ['saturday', 'holiday'] };
                const targetDays = dayMap[dayType] || ['weekday'];
                const times = []; for(let i=4; i<cols.length; i++) { if(cols[i] && cols[i].includes(':')) times.push(cols[i]); }
                if (!table[key]) table[key] = [];
                let existing = table[key].find(r => r.routeNo === routeName && r.dest === dest);
                if (!existing) { existing = { routeNo: routeName, dest: dest, times: { weekday: [], saturday: [], holiday: [] } }; table[key].push(existing); }
                targetDays.forEach(d => { existing.times[d] = [...existing.times[d], ...times]; });
            });
            for (let k in table) {
                table[k].forEach(route => {
                    const timeSort = (a, b) => { const [h1, m1] = a.split(':').map(Number); const [h2, m2] = b.split(':').map(Number); return (h1*60 + m1) - (h2*60 + m2); };
                    route.times.weekday.sort(timeSort); route.times.saturday.sort(timeSort); route.times.holiday.sort(timeSort);
                });
            }
            GLOBAL_TIMETABLE = table;
        };

        window.getNextTimeFromFile = function(stationKey, destFilters, dayKey) {
            if (!GLOBAL_TIMETABLE || GLOBAL_TIMETABLE === "ERROR") return { diff: 999999, html: `<span class="text-gray-400 text-xs">ì •ë³´ ì—†ìŒ</span>` };
            const stationData = GLOBAL_TIMETABLE[stationKey];
            if (!stationData) return { diff: 999999, html: `<span class="text-gray-400 text-xs">ì •ë³´ ì—†ìŒ</span>` };
            const now = new Date();
            const nowTotalSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            let targetRoutes = stationData.filter(r => destFilters.some(filter => r.dest.includes(filter)));
            if (targetRoutes.length === 0) return { diff: 999999, html: `<span class="text-gray-400 text-xs">ìš´í–‰ ì¢…ë£Œ</span>` };
            let bestDiff = 999999; let bestTime = null;
            targetRoutes.forEach(route => {
                const times = route.times[dayKey] || [];
                times.forEach(time => {
                    const [h, m, s=0] = time.split(':').map(Number); const timeSec = h * 3600 + m * 60 + s;
                    if (timeSec > nowTotalSec) { const diff = timeSec - nowTotalSec; if (diff < bestDiff) { bestDiff = diff; bestTime = time; } }
                });
            });
            if (!bestTime) return { diff: 999999, html: `<span class="text-gray-400 text-xs">ìš´í–‰ ì¢…ë£Œ</span>` };
            return { diff: bestDiff, html: renderBadge(bestDiff, bestTime) };
        };

        window.renderStaticCard = function(index, station) {
            const container = document.getElementById('dynamic-list-container');
            if (GLOBAL_TIMETABLE === "ERROR") { 
                container.innerHTML = `<div class="p-4 bg-red-50 text-red-500 text-center text-xs rounded-xl">ì‹œê°„í‘œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`; 
                return; 
            }
            const day = new Date().getDay(); const dayKey = (day === 0) ? 'holiday' : (day === 6 ? 'saturday' : 'weekday');
            const stationData = GLOBAL_TIMETABLE ? GLOBAL_TIMETABLE[station.nodeId] : null;
            let iconClass = "fa-solid fa-bus"; if (station.name.includes("ëŒ€í•™êµ")) iconClass = "fa-solid fa-school"; if (station.name.includes("CGV")) iconClass = "fa-solid fa-film";
            let contentHtml = '';
            
            if (stationData) {
                const now = new Date();
                const nowTotalSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

                const routes = stationData.map(r => { 
                    const times = r.times[dayKey] || [];
                    let bestDiff = 999999; 
                    let bestTime = null;
                    times.forEach(time => {
                        const [h, m, s=0] = time.split(':').map(Number); 
                        const timeSec = h * 3600 + m * 60 + s;
                        if (timeSec > nowTotalSec) { 
                            const diff = timeSec - nowTotalSec; 
                            if (diff < bestDiff) { bestDiff = diff; bestTime = time; } 
                        }
                    });
                    let html = '';
                    if (!bestTime) html = `<span class="text-gray-400 text-xs">ìš´í–‰ ì¢…ë£Œ</span>`;
                    else html = renderBadge(bestDiff, bestTime);
                    
                    let typeBadge = '';
                    if(r.routeNo.includes('ê¸‰í–‰')) typeBadge = `<span class="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded min-w-[30px] text-center ml-1 shadow-sm">ê¸‰í–‰</span>`;
                    return { ...r, diff: bestDiff, html: html, typeBadge: typeBadge };
                }).filter(r => r.diff !== 999999).sort((a, b) => a.diff - b.diff);

                if (routes.length === 0) { contentHtml = `<div class="text-center text-gray-400 text-xs py-2">ìš´í–‰ ì¢…ë£Œ</div>`; } 
                else { 
                    routes.forEach(r => { 
                        contentHtml += `
                        <div class="glass-item p-3 mb-2 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-50 text-blue-600 text-[11px] font-bold px-2 py-1 rounded-lg min-w-[40px] text-center shadow-sm border border-blue-100">${r.routeNo}</span>
                                ${r.typeBadge}
                                <div>
                                    <div class="text-[12px] font-bold text-gray-700 ml-1 flex items-center gap-1">
                                        <i class="fa-solid fa-arrow-right text-[10px] text-gray-400"></i>
                                        ${r.dest}
                                    </div>
                                </div>
                            </div>
                            ${r.html}
                        </div>`; 
                    }); 
                }
            } else { contentHtml = `<div class="text-center text-gray-400 text-xs py-2">ë°ì´í„° ë¡œë”©ì¤‘...</div>`; }
            
            const cardHtml = `
            <div class="toss-card p-5 mb-4 !bg-white/70 animate-[fadeInUp_0.4s_ease-out] relative">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2.5">
                        <div class="w-10 h-10 rounded-[16px] bg-gray-100 flex items-center justify-center text-gray-500 text-lg shadow-sm"><i class="${iconClass}"></i></div>
                        <div><h4 class="text-base font-bold text-main">${station.name}</h4><p class="text-xs text-sub text-[10px]">ID: ${station.nodeId}</p></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="openTimetable('${station.nodeId}', '${station.name}')" class="text-gray-400 hover:text-blue-500 transition-colors"><i class="fa-regular fa-calendar-days"></i></button>
                        <button onclick="removeStation('${currentRegion}', ${index})" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
                <div class="space-y-1">${contentHtml}</div>
            </div>`;
            container.insertAdjacentHTML('beforeend', cardHtml);
        };

        window.loadStationData = async function(index, cityCode, station) {
            const cardId = `station-card-${index}`; const card = document.getElementById(cardId); if (!card) return;
            let arrivals = [];
            let errorMsg = null;
            try {
                if (cityCode === '37380') {
                    const resGumi = await window.fetchBusArrival('37030', station.nodeId);
                    if (Array.isArray(resGumi)) { arrivals = [...resGumi]; }
                    const resChilgok = await window.fetchBusArrival('37380', station.nodeId);
                    if (Array.isArray(resChilgok)) {
                        const existingKeys = new Set(arrivals.map(b => `${b.routeno}_${b.arrtime}`));
                        resChilgok.forEach(b => {
                            const key = `${b.routeno}_${b.arrtime}`;
                            if (!existingKeys.has(key)) { arrivals.push(b); }
                        });
                    }
                    if (arrivals.length === 0 && typeof resGumi === 'string') { errorMsg = resGumi; }
                } else {
                    const res = await window.fetchBusArrival(cityCode, station.nodeId);
                    if (Array.isArray(res)) { arrivals = res; } else if (typeof res === 'string') { errorMsg = res; }
                }
            } catch(e) { console.error(e); errorMsg = "JS_ERROR"; }

            if (errorMsg && arrivals.length === 0) { 
                card.innerHTML = `<div class="p-4 text-center bg-red-50 rounded-2xl border border-red-100"><p class="text-red-500 text-xs font-bold mb-1">ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p><p class="text-red-400 text-[10px]">${errorMsg}</p></div><div class="text-center mt-2"><button onclick="removeStation('${currentRegion}', ${index})" class="text-xs text-gray-400 underline">ì‚­ì œ</button></div>`; 
                card.classList.remove('animate-pulse'); 
                return; 
            }
            if (arrivals.length === 0) { 
                card.innerHTML = `<div class="p-5 flex justify-between items-center"><div class="flex items-center gap-2.5"><div class="w-10 h-10 rounded-[16px] bg-gray-100 flex items-center justify-center text-gray-400 text-lg"><i class="fa-solid fa-ban"></i></div><div><h4 class="text-base font-bold text-main">${station.name}</h4><p class="text-[10px] text-sub">ì •ë³´ ì—†ìŒ (ìš´í–‰ì¢…ë£Œ ë˜ëŠ” í‚¤ í™•ì¸)</p></div></div><button onclick="removeStation('${currentRegion}', ${index})" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></div>`; 
                card.classList.remove('animate-pulse'); 
                return; 
            }

            arrivals = arrivals.filter(b => b.arrtime && !isNaN(parseInt(b.arrtime)));
            arrivals.sort((a, b) => parseInt(a.arrtime) - parseInt(b.arrtime));
            
            let contentHtml = ''; 
            const now = new Date();
            arrivals.forEach(bus => {
                const arrSeconds = parseInt(bus.arrtime);
                const arrivalDate = new Date(now.getTime() + arrSeconds * 1000);
                const timeStr = `${arrivalDate.getHours()}:${arrivalDate.getMinutes().toString().padStart(2,'0')}`;
                
                let typeBadge = '';
                let type = bus.routeTp;
                if (!type) {
                     if (bus.routeno.includes('ê¸‰í–‰')) type = 'ê¸‰í–‰';
                     else if (bus.routeno.includes('ì¢Œì„')) type = 'ì¢Œì„';
                }
                if (type) {
                    let badgeColor = 'bg-gray-500';
                    if (type.includes('ê¸‰í–‰') || type.includes('ì¢Œì„')) badgeColor = 'bg-red-500';
                    else if (type.includes('ê°„ì„ ')) badgeColor = 'bg-blue-500';
                    else if (type.includes('ì§€ì„ ') || type.includes('ë§ˆì„') || type.includes('ìˆœí™˜')) badgeColor = 'bg-emerald-500';
                    typeBadge = `<span class="${badgeColor} text-white text-[10px] font-bold px-1.5 py-0.5 rounded min-w-[30px] text-center ml-1 shadow-sm">${type}</span>`;
                }

                let currentLocBadge = '';
                if (bus.nowStationNm) {
                    currentLocBadge = `<div class="text-[11px] text-[#191F28] bg-gray-50 mt-1.5 px-2 py-1 rounded-lg flex items-center w-fit border border-gray-100">
                        <div class="w-1.5 h-1.5 rounded-full bg-red-500 mr-1.5 animate-pulse"></div>
                        <span class="text-gray-400 mr-1 text-[10px]">í˜„ì¬</span>
                        <span class="font-bold text-indigo-600">${bus.nowStationNm}</span>
                    </div>`;
                }
                contentHtml += `
                <div class="glass-item p-3 mb-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="bg-blue-50 text-blue-600 text-[11px] font-bold px-2 py-1 rounded-lg min-w-[40px] text-center shadow-sm border border-blue-100">${bus.routeno}</span>
                        ${typeBadge}
                        <div class="flex flex-col">
                            <div class="text-[12px] font-bold text-gray-700 ml-1 flex items-center gap-1">
                                <i class="fa-solid fa-arrow-right text-[10px] text-gray-400"></i>
                                ${bus.endnodenm}
                                ${bus.arrprevstationcnt ? `<span class="text-[10px] text-gray-400 font-normal">(${bus.arrprevstationcnt}ë²ˆì§¸ ì „)</span>` : ''}
                            </div>
                            ${currentLocBadge}
                        </div>
                    </div>
                    ${renderBadge(arrSeconds, timeStr)}
                </div>`;
            });
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2.5">
                        <div class="w-10 h-10 rounded-[16px] bg-blue-100 flex items-center justify-center text-blue-600 text-lg shadow-sm"><i class="fa-solid fa-bus-simple"></i></div>
                        <div><h4 class="text-base font-bold text-main">${station.name}</h4><p class="text-xs text-sub text-[10px]">ID: ${station.nodeId}</p></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="openTimetable('${station.nodeId}', '${station.name}')" class="text-gray-400 hover:text-blue-500 transition-colors"><i class="fa-regular fa-calendar-days"></i></button>
                        <button onclick="removeStation('${currentRegion}', ${index})" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>
                <div class="space-y-1">${contentHtml}</div>
            `;
            card.classList.remove('animate-pulse'); card.classList.add('!bg-white/70');
        };

        window.renderSubwayLineBadges = function() {
            const container = document.getElementById('subway-line-badges');
            container.innerHTML = '';
            const lines = REGION_LINES[currentSubwayRegion] || ['daegyeong'];
            lines.forEach(lineKey => {
                const meta = SUBWAY_LINES_META[lineKey];
                if(!meta) return;
                const isActive = (currentSubwayLine === lineKey);
                const btn = document.createElement('button');
                let classes = "px-3 py-1.5 rounded-full text-xs font-bold transition-all border shadow-sm ";
                if(isActive) {
                    classes += "text-white transform scale-105 border-transparent";
                    btn.style.backgroundColor = meta.color;
                } else {
                    classes += "bg-white text-gray-400 border-gray-100 hover:bg-gray-50";
                }
                btn.className = classes;
                btn.innerText = meta.name;
                btn.onclick = () => {
                    currentSubwayLine = lineKey;
                    window.renderSubwayLineBadges();
                    window.renderSubwayStations();
                };
                container.appendChild(btn);
            });
            const noticeEl = document.getElementById('subway-notice');
            if (currentSubwayBroadRegion === 'daegu' && currentSubwayLine === 'daegyeong') {
                noticeEl.classList.remove('hidden');
            } else {
                noticeEl.classList.add('hidden');
            }
        };

        window.renderSubwayStations = function() {
            const listContainer = document.getElementById('subway-station-list'); listContainer.innerHTML = '';
            
            if (currentSubwayLine === 'yangsan_line') {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs flex flex-col items-center gap-2"><i class="fa-solid fa-person-digging text-2xl mb-1"></i><p>2026ë…„ ê°œí†µ ì˜ˆì •ì…ë‹ˆë‹¤.</p></div>`;
                return;
            }
            if (currentSubwayLine === 'gwangju2') {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs flex flex-col items-center gap-2"><i class="fa-solid fa-person-digging text-2xl mb-1"></i><p>2027ë…„ 12ì›” ì´í›„ ì–¸ì  ê°„ ê°œí†µ ì˜ˆì •ì…ë‹ˆë‹¤.</p></div>`;
                return;
            }
            if (currentSubwayLine === 'daejeon2') {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs flex flex-col items-center gap-2"><i class="fa-solid fa-person-digging text-2xl mb-1"></i><p>ê³µì‚¬ ì§„í–‰ì¤‘, 2028ë…„ í•˜ë°˜ê¸° ê°œí†µ ì˜ˆì •ì…ë‹ˆë‹¤.</p></div>`;
                return;
            }
            if (currentSubwayLine === 'chungcheong_wide') {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs flex flex-col items-center gap-2"><i class="fa-solid fa-person-digging text-2xl mb-1"></i><p>ê³µì‚¬ ì§„í–‰ì¤‘, 2027ë…„ 6ì›” ë¶€í„° ìˆœì°¨ì  ê°œí†µ ì˜ˆì •ì…ë‹ˆë‹¤.</p></div>`;
                return;
            }
            if (currentSubwayBroadRegion !== 'daegu') {
                 listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs flex flex-col items-center gap-2"><i class="fa-solid fa-person-digging text-2xl mb-1"></i><p>ì§€ì› ì˜ˆì •ì…ë‹ˆë‹¤.</p></div>`; 
                 return;
            }
            if (currentSubwayLine !== 'daegyeong') { 
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs flex flex-col items-center gap-2"><i class="fa-solid fa-person-digging text-2xl mb-1"></i><p>ì§€ì› ì˜ˆì •ì…ë‹ˆë‹¤.</p></div>`; 
                return; 
            }
            
            const userStations = JSON.parse(localStorage.getItem('my_subway_stations_v1')) || {};
            const userAdded = userStations[currentSubwayRegion] || [];
            const defaultStations = SUBWAY_DATA['daegyeong'].stations[currentSubwayRegion] || [];
            const allStations = [...new Set([...defaultStations, ...userAdded])];
            const day = new Date().getDay(); const dayKey = (day === 0) ? 'holiday' : (day === 6 ? 'saturday' : 'weekday');
            
            allStations.forEach((stationName, index) => {
                let cardContent = '';
                let transferBadge = '';
                if (stationName === 'ì›ëŒ€(ë‹¬ì„±ê³µì›)') {
                    transferBadge = `<span class="w-5 h-5 flex items-center justify-center rounded-full text-white font-bold ml-1 shadow-sm text-[10px]" style="background-color: #FFB100;">3</span>`;
                } else if (stationName === 'ëŒ€êµ¬ì—­' || stationName === 'ë™ëŒ€êµ¬ì—­') {
                    transferBadge = `<span class="w-5 h-5 flex items-center justify-center rounded-full text-white font-bold ml-1 shadow-sm text-[10px]" style="background-color: #D93F5C;">1</span>`;
                }
                const isUserAdded = userAdded.includes(stationName) && !defaultStations.includes(stationName);
                const deleteBtn = isUserAdded ? `<button onclick="removeSubwayStation('${currentSubwayRegion}', '${stationName}')" class="absolute top-5 right-5 text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>` : '';
                const timetableBtn = `<button onclick="openTimetable('${stationName}', '${stationName}')" class="text-gray-400 hover:text-blue-500 transition-colors"><i class="fa-regular fa-calendar-days"></i></button>`;

                if (stationName === 'ë¶ì‚¼' || stationName === 'ì›ëŒ€(ë‹¬ì„±ê³µì›)') {
                    const status = stationName === 'ë¶ì‚¼' ? '2026ë…„ 2ì›” ê°œí†µ ì˜ˆì •' : 'ì°©ê³µ ì˜ˆì •'; 
                    const icon = stationName === 'ë¶ì‚¼' ? 'ğŸš§' : 'ğŸ—ï¸';
                    cardContent = `<div class="toss-card p-5 !bg-[#E6F0FA]/90 border border-blue-100 relative">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2.5">
                                <span class="badge-daegyeong text-[10px] px-2 py-1 rounded-full text-white font-bold">ëŒ€ê²½ì„ </span>
                                <h4 class="text-base font-bold text-main">${stationName}</h4>
                                ${transferBadge}
                                <span class="bg-gray-100 text-gray-500 text-[10px] font-bold px-1.5 py-0.5 rounded ml-auto">${status}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                ${timetableBtn}
                                ${deleteBtn}
                            </div>
                        </div>
                        <div class="text-center p-4"><div class="text-2xl mb-1">${icon}</div><p class="text-sm font-bold text-main">í˜„ì¬ ${status} ë‹¨ê³„ì…ë‹ˆë‹¤</p></div>
                    </div>`;
                } else {
                    const upData = window.getNextTimeFromFile(stationName, ['êµ¬ë¯¸'], dayKey);
                    const downDataKyong = window.getNextTimeFromFile(stationName, ['ê²½ì‚°'], dayKey);
                    const downDataDong = window.getNextTimeFromFile(stationName, ['ë™ëŒ€êµ¬'], dayKey);
                    let upHtml = (stationName !== 'êµ¬ë¯¸ì—­') ? `<div class="glass-item p-3 flex items-center justify-between mb-2"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">ìƒí–‰</div><span class="text-sm font-bold text-main">êµ¬ë¯¸ ë°©ë©´</span></div>${upData.html}</div>` : '';
                    let downHtml = '';
                    if (stationName !== 'ê²½ì‚°ì—­') {
                        downHtml += `<div class="glass-item p-3 flex items-center justify-between mb-2"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">í•˜í–‰</div><span class="text-sm font-bold text-main">ê²½ì‚° ë°©ë©´</span></div>${downDataKyong.html}</div>`;
                        if (stationName !== 'ë™ëŒ€êµ¬ì—­') downHtml += `<div class="glass-item p-3 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">í•˜í–‰</div><span class="text-sm font-bold text-main">ë™ëŒ€êµ¬ ë°©ë©´</span></div>${downDataDong.html}</div>`;
                    }
                    cardContent = `
                    <div class="toss-card p-5 !bg-[#E6F0FA]/90 relative border border-blue-100">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2.5">
                                <span class="badge-daegyeong text-[10px] px-2 py-1 rounded-full text-white font-bold shadow-sm">ëŒ€ê²½ì„ </span>
                                <h4 class="text-base font-bold text-main">${stationName}</h4>
                                ${transferBadge}
                            </div>
                            <div class="flex items-center gap-3">
                                ${timetableBtn}
                                ${deleteBtn}
                            </div>
                        </div>
                        <div class="space-y-1">${upHtml}${downHtml}</div>
                    </div>`;
                }
                listContainer.insertAdjacentHTML('beforeend', cardContent);
            });
        };

        window.openTimetable = function(stationKey, stationName) {
            currentTimetableKey = stationKey;
            document.getElementById('timetable-title').innerText = stationName;
            document.getElementById('timetable-modal').classList.remove('hidden');
            const day = new Date().getDay();
            const dayType = (day === 0) ? 'holiday' : (day === 6 ? 'saturday' : 'weekday');
            window.switchTimetableTab(dayType);
        };

        window.closeTimetableModal = function() {
            document.getElementById('timetable-modal').classList.add('hidden');
        };

        window.switchTimetableTab = function(dayKey) {
            currentTimetableDay = dayKey;
            ['weekday', 'saturday', 'holiday'].forEach(k => {
                const btn = document.getElementById('tab-' + k);
                if (k === dayKey) {
                    btn.classList.add('timetable-tab-active');
                    btn.classList.remove('timetable-tab-inactive');
                } else {
                    btn.classList.remove('timetable-tab-active');
                    btn.classList.add('timetable-tab-inactive');
                }
            });
            window.renderTimetableContent();
        };

        window.renderTimetableContent = function() {
            const container = document.getElementById('timetable-content');
            container.innerHTML = '';
            if (!GLOBAL_TIMETABLE || GLOBAL_TIMETABLE === "ERROR") {
                container.innerHTML = '<div class="p-4 bg-red-50 text-red-500 text-center text-xs rounded-xl">ì‹œê°„í‘œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
                return;
            }
            const stationData = GLOBAL_TIMETABLE[currentTimetableKey];
            if (!stationData || stationData.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400 text-xs">ì‹œê°„í‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            const todayDay = now.getDay();
            const todayKey = (todayDay === 0) ? 'holiday' : (todayDay === 6 ? 'saturday' : 'weekday');
            const isToday = (todayKey === currentTimetableDay);
            stationData.forEach(route => {
                const times = route.times[currentTimetableDay] || [];
                if (times.length === 0) return;
                let timeChips = '';
                times.forEach(t => {
                    const [h, m] = t.split(':').map(Number);
                    const tMinutes = h * 60 + m;
                    let chipClass = 'time-chip';
                    if (isToday) {
                        if (tMinutes < nowMinutes) chipClass += ' past';
                        else if (tMinutes >= nowMinutes && !timeChips.includes('future')) chipClass += ' future'; 
                    }
                    if (isToday && tMinutes >= nowMinutes) chipClass = 'time-chip future'; 
                    else if (isToday && tMinutes < nowMinutes) chipClass = 'time-chip past';
                    timeChips += `<div class="${chipClass}">${t}</div>`;
                });
                const isExpress = route.routeNo && route.routeNo.includes('ê¸‰í–‰');
                const badge = isExpress ? '<span class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded ml-2">ê¸‰í–‰</span>' : '';
                const routeNameDisplay = route.routeNo || 'ë…¸ì„ ';
                const html = `
                <div class="mb-4">
                    <div class="flex items-center mb-2 px-1">
                        <span class="text-sm font-bold text-main mr-1">${routeNameDisplay}</span>
                        <span class="text-xs text-gray-500 flex items-center"><i class="fa-solid fa-arrow-right mx-1 text-[10px]"></i> ${route.dest}</span>
                        ${badge}
                    </div>
                    <div class="timetable-grid">
                        ${timeChips}
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        };

        window.renderList = function() {
            const container = document.getElementById('dynamic-list-container'); 
            const empty = document.getElementById('empty-state');
            container.innerHTML = ''; 
            empty.classList.add('hidden');
            if (!apiKey && currentRegion !== 'andong') { 
                empty.classList.remove('hidden'); 
                return; 
            }
            const regions = BROAD_REGION_DATA_BUS[currentBusBroadRegion];
            const currentRegionData = regions ? regions.find(r => r.id === currentRegion) : null;
            if (currentRegionData && currentRegionData.isPlanned) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center py-10 text-gray-400 gap-3">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center text-2xl text-gray-300">
                        <i class="fa-solid fa-person-digging"></i>
                    </div>
                    <div class="text-center">
                        <p class="text-sm font-bold text-gray-500">ì„œë¹„ìŠ¤ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤</p>
                        <p class="text-xs text-gray-400 mt-1">ê³§ ì§€ì›ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                    </div>
                </div>`;
                return;
            }
            const cityCode = CITY_CODES[currentRegion]; 
            const targets = stationConfig[currentRegion];
            if (!targets || targets.length === 0) { 
                if (!BROAD_REGION_DATA_BUS[currentBusBroadRegion]) {
                    container.innerHTML = `<div class="text-center py-10 text-gray-400">ì§€ì› ì˜ˆì • ì§€ì—­ì…ë‹ˆë‹¤.</div>`;
                } else {
                    container.innerHTML = `<div class="text-center py-10 text-gray-400">ë“±ë¡ëœ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒë‹¨ '+ ì •ë¥˜ì¥ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</div>`; 
                }
                return; 
            }
            targets.forEach((station, index) => {
                if(currentRegion === 'andong') { 
                    window.renderStaticCard(index, station); 
                } else {
                    const skeletonHtml = `<div id="station-card-${index}" class="toss-card p-5 mb-4 !bg-white/50 animate-pulse relative"><div class="flex justify-between items-start mb-4"><div class="flex items-center gap-2.5"><div class="w-10 h-10 rounded-[16px] bg-gray-200"></div><div><div class="h-4 w-32 bg-gray-200 rounded mb-1.5"></div><div class="h-3 w-20 bg-gray-200 rounded"></div></div></div></div><div class="space-y-2"><div class="h-12 bg-gray-200 rounded-xl"></div></div></div>`;
                    container.insertAdjacentHTML('beforeend', skeletonHtml); 
                    window.loadStationData(index, cityCode, station);
                }
            });
        };

        window.selectBroadRegion = function(broadId) {
            currentSubwayBroadRegion = broadId;
            const broadIds = ['daegu', 'busan', 'chungcheong', 'gwangju'];
            broadIds.forEach(id => {
                const btn = document.getElementById('broad-btn-' + id);
                if (!btn) return;
                const span = btn.querySelector('span');
                if (id === broadId) {
                    btn.classList.add('region-card-selected');
                    span.classList.remove('text-gray-400');
                    span.classList.add('text-main');
                } else {
                    btn.classList.remove('region-card-selected');
                    span.classList.add('text-gray-400');
                    span.classList.remove('text-main');
                }
            });
            window.renderSubwaySpecificRegions();
            const regions = BROAD_REGION_DATA[broadId];
            if (regions && regions.length > 0) {
                const currentInList = regions.find(r => r.id === currentSubwayRegion);
                if (!currentInList) {
                    window.selectSubwayRegion(regions[0].id);
                    return; 
                }
            }
            window.renderSubwayLineBadges();
            window.renderSubwayStations();
        };

        window.renderSubwaySpecificRegions = function() {
            const container = document.getElementById('subway-specific-region-container');
            container.innerHTML = '';
            const regions = BROAD_REGION_DATA[currentSubwayBroadRegion];
            if (regions) {
                regions.forEach(r => {
                    const isSelected = (currentSubwayRegion === r.id);
                    const selectedClass = isSelected ? 'region-card-selected' : '';
                    const statusText = isSelected ? 'ì„ íƒë¨' : 'ì„ íƒí•˜ê¸°';
                    const html = `
                    <div id="sub-btn-${r.id}" onclick="selectSubwayRegion('${r.id}')" class="toss-card ${selectedClass} min-w-[80px] h-[80px] p-3 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-8 h-8 rounded-full bg-${r.color}-50 flex items-center justify-center text-${r.color}-500 text-sm"><i class="fa-solid ${r.icon}"></i></div>
                        <div><p class="text-xs font-bold text-main">${r.name}</p><p class="text-[10px] text-sub status-text">${statusText}</p></div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            } else {
                container.innerHTML = `<div class="w-full text-center text-gray-400 text-xs py-8 flex flex-col items-center justify-center h-[80px]"><p>ì•„ì§ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì§€ì—­ì…ë‹ˆë‹¤.</p></div>`;
            }
        };

        window.selectSubwayRegion = function(region) {
            currentSubwayRegion = region;
            const regions = BROAD_REGION_DATA[currentSubwayBroadRegion];
            if (regions) {
                regions.forEach(r => {
                    const el = document.getElementById('sub-btn-' + r.id);
                    if (!el) return;
                    if (r.id === region) { 
                        el.classList.add('region-card-selected'); 
                        el.querySelector('.status-text').innerText = 'ì„ íƒë¨'; 
                    } else { 
                        el.classList.remove('region-card-selected'); 
                        el.querySelector('.status-text').innerText = 'ì„ íƒí•˜ê¸°'; 
                    }
                });
            }
            const allowed = REGION_LINES[region] || ['daegyeong'];
            if(!allowed.includes(currentSubwayLine)) currentSubwayLine = allowed[0]; 
            window.renderSubwayLineBadges();
            window.renderSubwayStations();
        };

        window.switchTab = function(mode) {
            if (mode === 'bus') {
                document.getElementById('view-bus').classList.remove('hidden'); document.getElementById('view-subway').classList.add('hidden');
                document.getElementById('nav-bus').className = 'nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300';
                document.getElementById('nav-subway').className = 'nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100';
                window.renderBusSpecificRegions();
                window.renderList();
                window.startAutoRefresh(); 
            } else {
                document.getElementById('view-bus').classList.add('hidden'); document.getElementById('view-subway').classList.remove('hidden');
                document.getElementById('nav-subway').className = 'nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300';
                document.getElementById('nav-bus').className = 'nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100';
                window.renderBusSpecificRegions(); 
                window.renderSubwaySpecificRegions(); 
                window.renderSubwayLineBadges();
                window.renderSubwayStations();
                if(refreshInterval) clearInterval(refreshInterval); 
            }
        };

        window.selectBusBroadRegion = function(broadId) {
            currentBusBroadRegion = broadId;
            const broadIds = ['daegu', 'busan', 'chungcheong', 'gwangju', 'gyeongbuk', 'gyeongnam', 'jeonju'];
            broadIds.forEach(id => {
                const btn = document.getElementById('bus-broad-btn-' + id);
                if(!btn) return;
                const span = btn.querySelector('span');
                if (id === broadId) {
                    btn.classList.add('region-card-selected');
                    span.classList.remove('text-gray-400');
                    span.classList.add('text-main');
                } else {
                    btn.classList.remove('region-card-selected');
                    span.classList.add('text-gray-400');
                    span.classList.remove('text-main');
                }
            });
            window.renderBusSpecificRegions();
            const regions = BROAD_REGION_DATA_BUS[broadId];
            if (regions && regions.length > 0) {
                const currentInNewList = regions.find(r => r.id === currentRegion);
                if (!currentInNewList) {
                    const firstAvailable = regions.find(r => !r.isPlanned);
                    if (firstAvailable) {
                        window.selectRegion(firstAvailable.id);
                    } else {
                        window.selectRegion(regions[0].id);
                    }
                } else {
                    window.renderList(); 
                }
            } else {
                window.renderList(); 
            }
            window.startAutoRefresh();
        };

        window.renderBusSpecificRegions = function() {
            const container = document.getElementById('bus-specific-region-container');
            container.innerHTML = '';
            const regions = BROAD_REGION_DATA_BUS[currentBusBroadRegion];
            if (regions) {
                regions.forEach(r => {
                    const isSelected = (currentRegion === r.id);
                    const selectedClass = isSelected ? 'region-card-selected' : '';
                    let statusText = isSelected ? 'ì„ íƒë¨' : 'ì„ íƒí•˜ê¸°';
                    if (r.isPlanned) statusText = 'ì¤€ë¹„ì¤‘';
                    const html = `
                    <div id="btn-${r.id}" onclick="selectRegion('${r.id}')" class="toss-card ${selectedClass} min-w-[80px] h-[80px] p-3 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-8 h-8 rounded-full bg-${r.color}-50 flex items-center justify-center text-${r.color}-500 text-sm"><i class="fa-solid ${r.icon}"></i></div>
                        <div><p class="text-xs font-bold text-main">${r.name}</p><p class="text-[10px] text-sub status-text" id="status-${r.id}">${statusText}</p></div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
            } else {
                container.innerHTML = `<div class="w-full text-center text-gray-400 text-xs py-8 flex flex-col items-center justify-center h-[80px]"><p>ì•„ì§ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì§€ì—­ì…ë‹ˆë‹¤.</p></div>`;
            }
        };

        window.selectRegion = function(region) {
            currentRegion = region;
            const label = document.getElementById('region-status-label');
            if (label && CITY_NAMES[region]) {
                label.innerText = CITY_NAMES[region];
            }
            const allRegionIds = [];
            for (const key in BROAD_REGION_DATA_BUS) {
                BROAD_REGION_DATA_BUS[key].forEach(r => allRegionIds.push(r.id));
            }
            allRegionIds.forEach(id => {
                const el = document.getElementById('btn-' + id);
                if (!el) return;
                let isPlanned = false;
                for(const key in BROAD_REGION_DATA_BUS) {
                    const found = BROAD_REGION_DATA_BUS[key].find(item => item.id === id);
                    if(found && found.isPlanned) isPlanned = true;
                }
                if (id === region) { 
                    el.classList.add('region-card-selected'); 
                    el.querySelector('.status-text').innerText = isPlanned ? 'ì¤€ë¹„ì¤‘' : 'ì„ íƒë¨'; 
                } else { 
                    el.classList.remove('region-card-selected'); 
                    el.querySelector('.status-text').innerText = isPlanned ? 'ì¤€ë¹„ì¤‘' : 'ì„ íƒí•˜ê¸°'; 
                }
            });
            window.renderList();
            window.startAutoRefresh();
        };
        
        window.startAutoRefresh = function() {
            if (refreshInterval) clearInterval(refreshInterval);
            if (currentRegion === 'andong' && document.getElementById('view-bus').classList.contains('hidden') === false) return;
            refreshInterval = setInterval(() => {
                if (!document.getElementById('view-bus').classList.contains('hidden') && currentRegion !== 'andong') {
                    const targets = stationConfig[currentRegion];
                    const cityCode = CITY_CODES[currentRegion];
                    if (targets && targets.length > 0) {
                        targets.forEach((station, index) => {
                            window.loadStationData(index, cityCode, station);
                        });
                    }
                }
            }, 20000); 
        };

        // [ìˆ˜ì •] ëˆ„ë½ëœ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ ë³µêµ¬ ë° window í• ë‹¹
        window.openSearchModal = function() {
            const modal = document.getElementById('search-modal');
            const regionLabel = document.getElementById('search-modal-region');
            const isSubway = !document.getElementById('view-subway').classList.contains('hidden');
            
            if (isSubway) {
                const subRegionNames = { 'gumi': 'ê²½ë¶ êµ¬ë¯¸ì‹œ', 'chilgok': 'ê²½ë¶ ì¹ ê³¡êµ°', 'daegu': 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'gyeongsan': 'ê²½ë¶ ê²½ì‚°ì‹œ' };
                regionLabel.innerText = subRegionNames[currentSubwayRegion] || currentSubwayRegion;
                regionLabel.className = "text-xs font-bold text-orange-500 bg-orange-50 px-2 py-0.5 rounded-md inline-block mt-1";
            } else {
                regionLabel.innerText = CITY_NAMES[currentRegion];
                regionLabel.className = "text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md inline-block mt-1";
            }
            
            document.getElementById('add-station-input').value = '';
            document.getElementById('add-station-results').innerHTML = '<p class="text-center text-gray-400 mt-10 text-sm">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
            modal.classList.remove('hidden');
        };

        window.closeSearchModal = function() {
            document.getElementById('search-modal').classList.add('hidden');
        };

        window.openSettings = function() {
            document.getElementById('settings-modal').classList.remove('hidden');
        };

        window.closeSettings = function() {
            document.getElementById('settings-modal').classList.add('hidden');
        };

        window.doSearchStation = async () => {
            const query = document.getElementById('add-station-input').value; if(!query) return;
            const resBox = document.getElementById('add-station-results'); 
            const isSubway = !document.getElementById('view-subway').classList.contains('hidden');

            if (isSubway) {
                if (!GLOBAL_TIMETABLE || GLOBAL_TIMETABLE === "ERROR") {
                    resBox.innerHTML = '<div class="p-4 text-center text-red-500 text-xs rounded-xl">ì‹œê°„í‘œ íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>'; return;
                }
                const results = Object.keys(GLOBAL_TIMETABLE).filter(key => key.includes(query) && isNaN(key)); 
                
                if (results.length === 0) {
                    resBox.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">ê²°ê³¼ ì—†ìŒ</p>'; return;
                }
                
                resBox.innerHTML = results.map(name => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl mb-2">
                        <div><p class="text-sm font-bold text-main">${name}</p><p class="text-[10px] text-gray-400">ì§€í•˜ì² /ê¸°ì°¨</p></div>
                        <button onclick="addSubwayStation('${name}')" class="text-xs bg-orange-100 text-orange-600 font-bold px-3 py-1.5 rounded-lg">ì¶”ê°€</button>
                    </div>
                `).join('');
                return;
            }

            resBox.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-blue-500"></i></div>';
            const results = await window.searchStationAPI(query);
            if(results.error) { resBox.innerHTML = `<p class="text-center text-red-500 text-xs py-4">${results.error}</p>`; return; }
            if(!results || results.length === 0) { resBox.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">ê²°ê³¼ ì—†ìŒ</p>'; return; }
            
            resBox.innerHTML = results.map(item => {
                const nodeNm = item.nodenm || item.nodeNm || item.nodeNM || item.NODE_NM;
                const nodeId = item.nodeid || item.nodeId || item.nodeID || item.NODE_ID;
                if (!nodeId) return '';
                return `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl mb-2"><div><p class="text-sm font-bold text-main">${nodeNm}</p><p class="text-[10px] text-gray-400">ID: ${nodeId}</p></div><button onclick="addStation('${nodeNm}', '${nodeId}')" class="text-xs bg-blue-100 text-blue-600 font-bold px-3 py-1.5 rounded-lg">ì¶”ê°€</button></div>`;
            }).join('');
        };

        window.addStation = function(name, id) { 
            if (!id || id === 'undefined') { alert('ì˜ëª»ëœ ì •ë¥˜ì¥ IDì…ë‹ˆë‹¤.'); return; }
            const cleanId = String(id).trim(); 
            const cleanName = String(name).trim();
            if(!stationConfig[currentRegion]) stationConfig[currentRegion] = [];
            stationConfig[currentRegion].push({ name: cleanName, nodeId: cleanId, sub: 'ì‚¬ìš©ì ì¶”ê°€' }); 
            localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig)); 
            alert('ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
            window.closeSearchModal(); 
            window.renderList(); 
        };
        
        window.addSubwayStation = function(name) {
            const userStations = JSON.parse(localStorage.getItem('my_subway_stations_v1')) || {};
            if (!userStations[currentSubwayRegion]) userStations[currentSubwayRegion] = [];
            if (userStations[currentSubwayRegion].includes(name)) { alert('ì´ë¯¸ ì¶”ê°€ëœ ì—­ì…ë‹ˆë‹¤.'); return; }
            userStations[currentSubwayRegion].push(name);
            localStorage.setItem('my_subway_stations_v1', JSON.stringify(userStations));
            alert('ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'); window.closeSearchModal(); window.renderSubwayStations();
        };

        window.removeSubwayStation = function(region, name) {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const userStations = JSON.parse(localStorage.getItem('my_subway_stations_v1')) || {};
            if (userStations[region]) {
                userStations[region] = userStations[region].filter(s => s !== name);
                localStorage.setItem('my_subway_stations_v1', JSON.stringify(userStations));
                window.renderSubwayStations();
            }
        };

        window.removeStation = function(region, idx) { 
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
                stationConfig[region].splice(idx, 1); 
                localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig)); 
                window.renderList(); 
            } 
        };

        window.saveSettings = function() { 
            const key = document.getElementById('api-key-input').value; 
            const type = document.querySelector('input[name="key-type"]:checked').value; 
            if(key) { 
                apiKey = key; 
                keyType = type; 
                localStorage.setItem('toss_bus_api_key', key); 
                localStorage.setItem('toss_bus_key_type', type); 
                alert('ì €ì¥ë¨'); 
                window.closeSettings(); 
                window.renderList(); 
            } 
        };

        window.resetData = function() { 
            if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
                localStorage.removeItem('my_station_config_v40'); 
                localStorage.removeItem('my_subway_stations_v1'); 
                location.reload(); 
            } 
        };

        window.testConnection = async function() { 
            alert("í…ŒìŠ¤íŠ¸ ì‹œì‘: ê²°ê³¼ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”..."); 
            const res = await window.fetchBusArrival('37010', 'DJB8001793'); 
            document.getElementById('test-result').innerHTML = (typeof res === 'string') ? `<span class='text-red-500'>ì‹¤íŒ¨: ${res}</span>` : "<span class='text-green-500'>ì„±ê³µ!</span>"; 
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (MANUAL_API_KEY) {
                apiKey = MANUAL_API_KEY;
                keyType = 'decoding'; 
                localStorage.setItem('toss_bus_api_key', apiKey);
                localStorage.setItem('toss_bus_key_type', keyType);
                const indicator = document.getElementById('key-source-indicator');
                if(indicator) indicator.classList.remove('hidden');
            }
            if(apiKey) document.getElementById('api-key-input').value = apiKey;
            window.loadTimetable();
            window.selectRegion('andong');
            window.renderBusSpecificRegions();
            window.renderSubwaySpecificRegions();
            startLiveUpdates();
            window.initCityCodes(true);
            window.startAutoRefresh();
            console.log("Script loaded successfully");
        });

        const mainContent = document.getElementById('main-content');
        const island = document.getElementById('dynamic-island');
        mainContent.addEventListener('scroll', () => { island.classList.toggle('island-active', mainContent.scrollTop > 20); });
    </script>
</body>
</html>