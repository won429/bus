<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Realtime Bus - Final Native Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Pretendard', sans-serif;
            background-color: #F2F4F6;
            color: #191F28;
            touch-action: pan-y;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-toss-gradient { background: linear-gradient(to bottom right, #F2F4F6, #E8ECF2, #DEE2E6); }
        .toss-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04); 
            transition: transform 0.1s;
            overflow: hidden;
        }
        .toss-card:active { transform: scale(0.98); }
        .glass-item {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
        }
        .text-main { color: #191F28; }
        .text-sub { color: #6B7684; }
        .pt-safe { padding-top: max(10px, env(safe-area-inset-top)); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .region-card-selected { background-color: rgba(255, 255, 255, 0.9) !important; border-color: #3182F6 !important; box-shadow: 0 4px 12px rgba(49, 130, 246, 0.15) !important; }
        
        #dynamic-island { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .island-active {
            width: 140px !important; background-color: #191F28 !important; border-radius: 9999px !important;
            margin-top: 10px; padding: 8px 16px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
        }
        .island-active .header-title { width: 0; opacity: 0; margin: 0; overflow: hidden; transform: scale(0.8); }
        .island-active .icon-container { width: 100%; justify-content: center; gap: 24px !important; }
        .island-active .icon-bg { background-color: transparent !important; width: auto !important; height: auto !important; box-shadow: none !important; color: white !important; }
        
        @keyframes pulse-custom { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse-custom { animation: pulse-custom 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-kakao { background-color: #FAE100; color: #3C1E1E; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
        .toss-card:hover .delete-btn { opacity: 1; }
        
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="w-full h-[100dvh] flex flex-col overflow-hidden bg-toss-gradient">

    <!-- í—¤ë” -->
    <header class="fixed top-0 left-0 w-full z-50 flex justify-center pt-safe pointer-events-none">
        <div id="dynamic-island" class="pointer-events-auto w-full max-w-md px-5 py-2 flex items-center justify-between bg-transparent mx-auto origin-top mt-2">
            <h1 class="header-title text-xl font-bold text-main whitespace-nowrap transition-all duration-300 origin-left">ëŒ€ì¤‘êµí†µ</h1>
            <div class="icon-container flex gap-2 transition-all duration-300">
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="openSearchModal()">
                    <i class="fa-solid fa-magnifying-glass text-sm"></i>
                </div>
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="openSettings()">
                    <i class="fa-solid fa-gear text-sm"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main id="main-content" class="flex-1 overflow-y-auto scrollbar-hide px-5 pb-24 w-full max-w-md mx-auto relative pt-16">
        
        <!-- ì§€ì—­ ì„ íƒ -->
        <div class="mb-6 fade-in-up delay-100">
            <h3 class="text-lg font-bold text-main mb-3 px-1">ì§€ì—­ ì„ íƒ</h3>
            <div class="flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1">
                <div id="btn-andong" onclick="selectRegion('andong')" class="toss-card region-card-selected min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                    <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 text-lg"><i class="fa-solid fa-location-dot"></i></div>
                    <div><p class="text-sm font-bold text-main">ì•ˆë™ì‹œ</p><p class="text-xs text-sub status-text" id="status-andong">ì—°ê²° ëŒ€ê¸°</p></div>
                </div>
                <div id="btn-gumi" onclick="selectRegion('gumi')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                    <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 text-lg"><i class="fa-solid fa-city"></i></div>
                    <div><p class="text-sm font-bold text-main">êµ¬ë¯¸ì‹œ</p><p class="text-xs text-sub status-text" id="status-gumi">ì—°ê²° ëŒ€ê¸°</p></div>
                </div>
                <div id="btn-chilgok" onclick="selectRegion('chilgok')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                    <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500 text-lg"><i class="fa-solid fa-tree"></i></div>
                    <div><p class="text-sm font-bold text-main">ì¹ ê³¡êµ°</p><p class="text-xs text-sub status-text" id="status-chilgok">ì—°ê²° ëŒ€ê¸°</p></div>
                </div>
            </div>
            <p id="city-code-status" class="text-[10px] text-gray-400 mt-2 px-1 text-right">ë„ì‹œ ì½”ë“œ ì¡°íšŒ ëŒ€ê¸°ì¤‘...</p>
        </div>

        <!-- ë²„ìŠ¤ ëª©ë¡ -->
        <div class="mb-4 fade-in-up delay-200">
            <div class="flex justify-between items-end mb-3 px-1">
                <div>
                    <h3 class="text-lg font-bold text-main">ë„ì°© ì •ë³´</h3>
                    <span class="text-xs font-medium text-sub" id="region-status-label">ì•ˆë™ì‹œ</span>
                </div>
                <button id="add-btn-main" onclick="openSearchModal()" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors shadow-sm">
                    + ì •ë¥˜ì¥ ì¶”ê°€
                </button>
            </div>
            
            <div id="loading-spinner" class="hidden text-center py-20 animate-pulse-custom">
                <i class="fa-solid fa-satellite-dish text-3xl text-blue-500 mb-2"></i>
                <p class="text-sm font-bold text-main" id="loading-text">ë°ì´í„° ì—°ê²° ì¤‘...</p>
            </div>

            <!-- ì—ëŸ¬ ë©”ì‹œì§€ íŒ¨ë„ -->
            <div id="error-diagnosis" class="hidden mx-1 mb-4 p-4 bg-red-50 rounded-2xl border border-red-100">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
                    <p class="text-sm text-red-600 font-bold" id="error-title">ì˜¤ë¥˜ ë°œìƒ</p>
                </div>
                <p class="text-xs text-red-500 mb-3 leading-relaxed break-all" id="error-desc">ë‚´ìš©</p>
                <a href="https://corsproxy.io/" target="_blank" class="block w-full bg-red-100 text-red-600 text-center py-2 rounded-xl text-xs font-bold hover:bg-red-200 transition-colors shadow-sm">
                    CORS í”„ë¡ì‹œ í™•ì¸ í•„ìš” (ìë™ ì ìš©ë¨)
                </a>
            </div>

            <div id="dynamic-list-container" class="space-y-4"></div>
            
            <div id="empty-state" class="hidden text-center py-10 bg-white/40 rounded-3xl border border-white/60">
                <i class="fa-solid fa-key text-3xl text-gray-300 mb-2"></i>
                <p class="text-sm font-bold text-gray-500">API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
                <p class="text-xs text-gray-400 mt-1">
                    <span class="text-blue-500 font-bold">ì•ˆë™ì‹œ</span>ëŠ” í‚¤ ì—†ì´ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                    ë‹¤ë¥¸ ì§€ì—­ì€ ì„¤ì •ì—ì„œ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                </p>
            </div>
            
            <div class="h-40"></div>
        </div>
    </main>

    <!-- ê²€ìƒ‰ ëª¨ë‹¬ (ìˆ˜ë™ ë“±ë¡ ìœ„ì£¼) -->
    <div id="search-modal" class="hidden fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-5">
        <div class="bg-white w-full max-w-sm h-[85vh] sm:h-[80vh] sm:rounded-[32px] rounded-t-[32px] p-6 shadow-2xl scale-100 transition-all flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none">
                <div>
                    <h3 class="text-xl font-bold text-main">ì •ë¥˜ì¥ ì¶”ê°€</h3>
                    <p class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md inline-block mt-1" id="search-modal-region">ì•ˆë™ì‹œ</p>
                </div>
                <button onclick="closeSearchModal()" class="text-gray-400 hover:text-gray-600 bg-gray-100 w-8 h-8 rounded-full"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <!-- ì•ˆë™ì‹œëŠ” ìˆ˜ë™ ë“±ë¡ ê¶Œì¥ -->
            <div id="andong-manual-guide" class="mb-4 hidden">
                <div class="bg-blue-50 p-4 rounded-2xl mb-4">
                    <p class="text-sm font-bold text-main mb-1">ê³ ì • ì‹œê°„í‘œ ëª¨ë“œ</p>
                    <p class="text-xs text-gray-500">ì•ˆë™ì‹œëŠ” ì§€ì •ëœ 3ê°œ ì •ë¥˜ì¥ë§Œ í‘œì‹œë©ë‹ˆë‹¤.<br>ì¶”ê°€í•˜ë ¤ë©´ ì½”ë“œ ë‚´ ì‹œê°„í‘œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.</p>
                </div>
            </div>

            <!-- íƒ€ ì§€ì—­ ê²€ìƒ‰ì°½ -->
            <div id="api-search-box" class="flex gap-2 mb-2 flex-none">
                <input type="text" id="add-station-input" placeholder="ì •ë¥˜ì¥ëª… ê²€ìƒ‰" class="flex-1 bg-gray-100 rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.keyCode==13) doSearchStation()">
                <button onclick="doSearchStation()" class="bg-blue-500 text-white rounded-2xl px-4 py-3 text-sm font-bold whitespace-nowrap">ê²€ìƒ‰</button>
            </div>
            
            <div id="add-station-results" class="flex-1 overflow-y-auto space-y-2 border-t border-gray-100 pt-2 min-h-0">
                <p class="text-center text-gray-400 mt-10 text-sm">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center p-5">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl scale-95 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-main">ì„¤ì •</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-2">ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤ (êµ¬ë¯¸/ì¹ ê³¡ìš©)</label>
                <input type="text" id="api-key-input" placeholder="ì¸ì¦í‚¤ ë¶™ì—¬ë„£ê¸°" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <p class="text-[10px] text-blue-500 mt-1">* ì•ˆë™ì‹œëŠ” í‚¤ ì—†ì´ë„ ì‘ë™í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="flex gap-4 mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="key-type" value="decoding" checked class="w-4 h-4 text-blue-500">
                    <span class="text-sm text-gray-600">Decoding</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="key-type" value="encoding" class="w-4 h-4 text-blue-500">
                    <span class="text-sm text-gray-600">Encoding</span>
                </label>
            </div>

            <!-- CSV ë„ì›€ë§ (ì—…ë°ì´íŠ¸) -->
            <div class="mb-6 bg-gray-50 p-4 rounded-2xl">
                <h4 class="text-xs font-bold text-main mb-2">ğŸ“„ ì‹œê°„í‘œ íŒŒì¼ ì‘ì„±ë²• (ì•ˆë™ì‹œ)</h4>
                <div class="text-[10px] text-gray-500 space-y-1">
                    <p>1. ì—‘ì…€ ìˆœì„œ: <b>ID | ë²ˆí˜¸ | ë°©ë©´ | ìš”ì¼ | ì‹œê°„...</b></p>
                    <p class="font-mono bg-white p-1 rounded border border-gray-200">370000023, ê¸‰í–‰1, ë„ì²­í–‰, í‰ì¼, 08:00...</p>
                    <p>2. ìš”ì¼(Dì—´)ì— <b>í‰ì¼/í† ìš”ì¼/ì¼ìš”ì¼/ë§¤ì¼</b> ì…ë ¥</p>
                    <p>3. <b>CSV(ì‰¼í‘œë¡œ ë¶„ë¦¬)</b> í˜•ì‹ìœ¼ë¡œ ì €ì¥</p>
                </div>
            </div>

            <!-- í”„ë¡ì‹œ ì„ íƒ ì¶”ê°€ -->
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-2">í”„ë¡ì‹œ ì„œë²„</label>
                <select id="proxy-select" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                    <option value="corsproxy">CorsProxy.io (ê¸°ë³¸)</option>
                    <option value="codetabs">CodeTabs</option>
                    <option value="direct">ì§ì ‘ ì—°ê²°</option>
                </select>
            </div>

            <div class="space-y-2 mb-4">
                <button onclick="initCityCodes()" class="w-full bg-orange-50 text-orange-600 font-bold py-3 rounded-2xl hover:bg-orange-100 transition-colors text-sm">
                    <i class="fa-solid fa-sync"></i> ë„ì‹œ ì½”ë“œ APIë¡œ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜)
                </button>
                <button onclick="testConnection()" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-2xl hover:bg-gray-200 transition-colors text-sm">
                    <i class="fa-solid fa-stethoscope"></i> ì•± ë‚´ë¶€ ì—°ê²° í…ŒìŠ¤íŠ¸
                </button>
            </div>

            <button onclick="saveSettings()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-500/20 transition-all active:scale-95">ì €ì¥í•˜ê¸°</button>
            
            <div id="test-result" class="mt-4 p-3 bg-gray-50 rounded-xl text-xs text-gray-500 hidden break-all"></div>

            <div class="mt-4 text-center border-t border-gray-100 pt-4">
                <button onclick="resetData()" class="text-[10px] text-red-400 underline">ë°ì´í„° ê°•ì œ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <script>
        // [ì¤‘ìš”] ì•ˆë™ì‹œ ê³ ì • ì •ë¥˜ì¥ (ê¸°ë³¸ê°’)
        const ANDONG_DEFAULT_STATIONS = [
            { name: "êµ­ë¦½ì•ˆë™ëŒ€í•™êµ", nodeId: "370000023", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" },
            { name: "CGV ê±´ë„ˆ", nodeId: "370000998", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" }, // ì„ì˜ ID
            { name: "ì•ˆë™í„°ë¯¸ë„(ì•ˆë™ì—­)", nodeId: "354000416", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" } // ì„ì˜ ID
        ];

        // ì´ˆê¸° ë°ì´í„°
        const defaultStationConfig = { 
            andong: ANDONG_DEFAULT_STATIONS, 
            gumi: [], 
            chilgok: [] 
        };

        // ë„ì‹œ ì½”ë“œ
        let CITY_CODES = { 'andong': '37010', 'gumi': '37030', 'chilgok': '37380' };
        const CITY_NAMES = { 'andong': 'ì•ˆë™ì‹œ', 'gumi': 'êµ¬ë¯¸ì‹œ', 'chilgok': 'ì¹ ê³¡êµ°' };
        
        let currentRegion = 'andong';
        let apiKey = localStorage.getItem('toss_bus_api_key') || '';
        let keyType = localStorage.getItem('toss_bus_key_type') || 'decoding'; 
        let selectedProxy = localStorage.getItem('toss_bus_proxy') || 'corsproxy';
        
        // ì´ˆê¸° ë¡œë“œ ì‹œ ì•ˆë™ì‹œ ë°ì´í„°ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì±„ì›€ + ê°•ì œ ì—…ë°ì´íŠ¸
        let stationConfig = JSON.parse(localStorage.getItem('my_station_config_v40')) || JSON.parse(JSON.stringify(defaultStationConfig));
        if(!stationConfig.andong || stationConfig.andong.length === 0) {
            stationConfig.andong = ANDONG_DEFAULT_STATIONS;
        }
        
        // [ê°•ì œ ì—…ë°ì´íŠ¸] ì‚¬ìš©ìê°€ ê¸°ì¡´ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìˆì–´ë„ ì•ˆë™ì‹œ ë§Œí¼ì€ ê³ ì • ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•¨
        stationConfig.andong = ANDONG_DEFAULT_STATIONS;
        localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig));

        let routeDestCache = JSON.parse(localStorage.getItem('route_dest_cache')) || {};

        // -----------------------------------------------------------------------------------------
        // [ì•ˆë™ì‹œ ì‹œê°„í‘œ ë°ì´í„° ì…ë ¥ êµ¬ì—­]
        // -----------------------------------------------------------------------------------------
        const TIMETABLE_URL = ""; 
        
        let ANDONG_TIMETABLE = {
            // êµ­ë¦½ì•ˆë™ëŒ€í•™êµ (370000023)
            "370000023": [
                { 
                    routeNo: "110", dest: "í„°ë¯¸ë„í–‰", 
                    times: { weekday: ["08:10", "09:30", "12:00", "15:00", "18:00"], saturday: ["08:10", "18:00"], holiday: ["08:10", "18:00"] }
                },
                { 
                    routeNo: "212", dest: "ë„ì²­í–‰", 
                    times: { weekday: ["08:20", "09:40", "12:10", "15:10", "18:10"], saturday: ["08:20", "18:10"], holiday: ["08:20", "18:10"] }
                },
                { 
                    routeNo: "ê¸‰í–‰1", dest: "ë„ì²­í–‰", 
                    times: {
                        weekday: ["08:00", "09:00", "12:00", "15:00", "18:00"], 
                        saturday: ["08:30", "10:30", "13:30", "16:30"],        
                        holiday: ["09:00", "11:00", "14:00", "17:00"]          
                    }
                }
            ],
            // CGV ê±´ë„ˆ (370000998)
            "370000998": [
                { routeNo: "110", dest: "ì•ˆë™ëŒ€í–‰", times: { weekday: ["09:00", "11:00", "14:00"], saturday: ["09:00"], holiday: ["09:00"] } },
                { routeNo: "212", dest: "ì•ˆë™ëŒ€í–‰", times: { weekday: ["09:15", "11:15", "14:15"], saturday: ["09:15"], holiday: ["09:15"] } }
            ],
            // ì•ˆë™í„°ë¯¸ë„ (354000416)
            "354000416": [
                { routeNo: "110", dest: "ì•ˆë™ëŒ€", times: { weekday: ["07:50", "08:50", "11:50"], saturday: ["07:50"], holiday: ["07:50"] } },
                { routeNo: "212", dest: "ì•ˆë™ëŒ€", times: { weekday: ["08:30", "09:30", "10:30"], saturday: ["08:30"], holiday: ["08:30"] } },
                { 
                    routeNo: "ê¸‰í–‰1", dest: "ì•ˆë™ëŒ€", 
                    times: {
                         weekday: ["08:10", "09:10", "12:10"],
                         saturday: ["08:40", "10:40"],
                         holiday: ["09:10", "11:10"]
                    }
                }
            ]
        };
        // -----------------------------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            if(apiKey) {
                document.getElementById('api-key-input').value = apiKey;
                const radios = document.getElementsByName('key-type');
                for(const r of radios) { if(r.value === keyType) r.checked = true; }
            }
            const proxySelect = document.getElementById('proxy-select');
            if(proxySelect) proxySelect.value = selectedProxy;

            const savedCityCodes = localStorage.getItem('my_city_codes');
            if (savedCityCodes) {
                CITY_CODES = JSON.parse(savedCityCodes);
                updateCityStatus();
            }
            
            // ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° (ì™¸ë¶€ íŒŒì¼ ìˆìœ¼ë©´)
            loadTimetable();
            
            selectRegion('andong');
        });

        // ì‹œê°„í‘œ íŒŒì¼(CSV) ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
        async function loadTimetable() {
            if (!TIMETABLE_URL) return; 

            try {
                const response = await fetchWithProxy(TIMETABLE_URL);
                if (!response.ok) throw new Error("File not found");
                
                const text = await response.text();
                parseAndongCSV(text); // CSV íŒŒì‹±
                
                if(currentRegion === 'andong') {
                    renderList();
                }
                console.log("ì‹œê°„í‘œ ë¡œë“œ ì„±ê³µ");

            } catch (e) {
                console.error("ì‹œê°„í‘œ ë¡œë“œ ì‹¤íŒ¨:", e);
            }
        }

        // CSV í…ìŠ¤íŠ¸ë¥¼ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ë³€í™˜ (ID,ë²ˆí˜¸,ë°©ë©´,ì‹œê°„ ìˆœì„œ ê°€ì •)
        function parseAndongCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const table = {};
            
            lines.forEach((line, index) => {
                // ì²« ì¤„ì´ í—¤ë”ì¼ ê²½ìš° ê±´ë„ˆë›°ê¸° (ìˆ«ìê°€ ì•„ë‹ˆë©´ í—¤ë”ë¡œ ê°„ì£¼)
                if (index === 0 && isNaN(line.trim().charAt(0))) return;

                const cols = line.split(',').map(c => c.trim());
                if (cols.length < 5) return; // ìµœì†Œ 5ì—´ í•„ìš” (ID,ë²ˆí˜¸,ë°©ë©´,ìš”ì¼,ì‹œê°„1)

                const stationId = cols[0];
                const routeNo = cols[1];
                const dest = cols[2];
                let dayType = cols[3]; // ìš”ì¼ (í‰ì¼/í† ìš”ì¼/ì¼ìš”ì¼/ë§¤ì¼)
                
                // ìš”ì¼ ì½”ë“œ ë³€í™˜
                if(dayType === 'í‰ì¼') dayType = 'weekday';
                else if(dayType === 'í† ìš”ì¼') dayType = 'saturday';
                else if(dayType === 'ì¼ìš”ì¼' || dayType === 'ê³µíœ´ì¼') dayType = 'holiday';
                else dayType = 'all'; // ë§¤ì¼

                // 5ë²ˆì§¸(Eì—´)ë¶€í„° ëê¹Œì§€ ì‹œê°„ìœ¼ë¡œ ì¸ì‹
                const times = [];
                for(let i=4; i<cols.length; i++) {
                    if(cols[i]) times.push(cols[i]);
                }

                if (!table[stationId]) table[stationId] = [];
                
                // ê¸°ì¡´ ë…¸ì„  ì°¾ê¸° (ê°™ì€ ë…¸ì„ , ê°™ì€ ë°©ë©´ì´ë©´ ì‹œê°„ë§Œ ì¶”ê°€)
                let existing = table[stationId].find(r => r.routeNo === routeNo && r.dest === dest);
                
                if (existing) {
                    // ì´ë¯¸ ìˆìœ¼ë©´ times ê°ì²´ì— í•´ë‹¹ ìš”ì¼ ì¶”ê°€
                    if(dayType === 'all') {
                         existing.times.weekday = [...(existing.times.weekday || []), ...times];
                         existing.times.saturday = [...(existing.times.saturday || []), ...times];
                         existing.times.holiday = [...(existing.times.holiday || []), ...times];
                    } else {
                         existing.times[dayType] = [...(existing.times[dayType] || []), ...times];
                    }
                } else {
                    // ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    let timesObj = {};
                    if(dayType === 'all') {
                        timesObj = { weekday: times, saturday: times, holiday: times };
                    } else {
                        timesObj[dayType] = times;
                    }
                    
                    table[stationId].push({
                        routeNo: routeNo,
                        dest: dest,
                        times: timesObj
                    });
                }
            });
            
            // ì‹œê°„ìˆœ ì •ë ¬ (ì„ íƒì‚¬í•­)
            for (let id in table) {
                table[id].forEach(route => {
                    if(route.times.weekday) route.times.weekday.sort();
                    if(route.times.saturday) route.times.saturday.sort();
                    if(route.times.holiday) route.times.holiday.sort();
                });
            }

            ANDONG_TIMETABLE = table;
        }

        function getEncodedKey() {
            if (!apiKey) return '';
            return keyType === 'encoding' ? apiKey : encodeURIComponent(apiKey);
        }

        // í”„ë¡ì‹œ URL ìƒì„± (AllOriginsëŠ” CSV í…ìŠ¤íŠ¸ë„ ì˜ ë°›ì•„ì˜´)
        function fetchWithProxy(url) {
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
            return fetch(proxyUrl);
        }
        
        // ê¸°ì¡´ í”„ë¡ì‹œ í•¨ìˆ˜ (API í˜¸ì¶œìš©)
        function getProxyUrl(url) {
             if (selectedProxy === 'direct') return url;
             if (selectedProxy === 'codetabs') return 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url);
             return 'https://corsproxy.io/?' + encodeURIComponent(url);
        }

        // [ë°ì´í„° ì •ê·œí™”]
        function normalizeBusData(bus) {
            if (!bus) return null;
            return {
                ...bus,
                routeno: (bus.routeno || bus.routeNo || '?').toString(),
                routeid: bus.routeid || bus.routeId || '',
                routetp: bus.routetp || bus.routeTp || '',
                endnodenm: bus.endnodenm || bus.endNodeNm || '',
                nodenm: bus.nodenm || bus.nodeNm || '',
                arrtime: bus.arrtime || bus.arrTime,
                arrprevstationcnt: bus.arrprevstationcnt || bus.arrPrevStationCnt,
                citycode: bus.citycode || bus.cityCode || null 
            };
        }

        function parseHybrid(text) {
            try { return { type: 'json', data: JSON.parse(text) }; } catch(e) { }
            if (text.includes('<OpenAPI_ServiceResponse>')) {
                if (text.includes('SERVICE_KEY_IS_NOT_REGISTERED_ERROR')) return { type: 'error', msg: 'SERVICE_KEY_IS_NOT_REGISTERED_ERROR' };
                if (text.includes('SERVICE_KEY_ERROR')) return { type: 'error', msg: 'SERVICE_KEY_ERROR' };
                return { type: 'error', msg: 'SERVER_ERROR (XML)' };
            }
            return { type: 'error', msg: 'UNKNOWN_FORMAT' };
        }

        function updateCityStatus() {
            document.getElementById('status-andong').innerText = "ì‹œê°„í‘œ ëª¨ë“œ"; // ì•ˆë™ì€ ì‹œê°„í‘œ ëª¨ë“œ
            document.getElementById('status-gumi').innerText = CITY_CODES.gumi ? "ì¤€ë¹„ì™„ë£Œ" : "ë¯¸í™•ì¸";
            document.getElementById('status-chilgok').innerText = CITY_CODES.chilgok ? "ì¤€ë¹„ì™„ë£Œ" : "ë¯¸í™•ì¸";
            document.getElementById('city-code-status').innerText = "ë„ì‹œ ì½”ë“œ ì—°ë™ ì™„ë£Œ";
        }

        // --- APIs ---
        async function initCityCodes() {
            if (!apiKey) { alert("API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”."); return; }
            const resultBox = document.getElementById('test-result');
            resultBox.classList.remove('hidden');
            resultBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë„ì‹œ ì½”ë“œ ìŠ¤ìº” ì¤‘...';
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getCtyCodeList?serviceKey=${serviceKey}&_type=json`;

            try {
                const response = await fetch(getProxyUrl(targetUrl));
                const text = await response.text();
                const result = parseHybrid(text);
                if (result.type === 'error') { resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ${result.msg}</span>`; return; }
                const items = result.data.response.body.items.item;
                const list = Array.isArray(items) ? items : [items];
                let found = 0;
                list.forEach(city => {
                    // ì•ˆë™ì€ ìˆ˜ë™ì´ë¯€ë¡œ ì½”ë“œ ê°±ì‹  ì•ˆí•´ë„ ë¨, í•˜ì§€ë§Œ ì €ì¥ì€ í•´ë‘ 
                    if (city.cityname.includes('ì•ˆë™')) { CITY_CODES.andong = city.citycode; found++; }
                    if (city.cityname.includes('êµ¬ë¯¸')) { CITY_CODES.gumi = city.citycode; found++; }
                    if (city.cityname.includes('ì¹ ê³¡')) { CITY_CODES.chilgok = city.citycode; found++; }
                });
                localStorage.setItem('my_city_codes', JSON.stringify(CITY_CODES));
                updateCityStatus();
                resultBox.innerHTML = `<span class="text-green-600 font-bold">âœ… ë„ì‹œ ì½”ë“œ ${found}ê°œ ê°±ì‹  ì™„ë£Œ!</span>`;
            } catch (e) { resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</span>`; }
        }

        async function fetchBusArrival(cityCode, nodeId) {
            if (!apiKey || !nodeId) return null;
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/ArvlInfoInqireService/getSttnAcctoArvlPrearngeInfoList?serviceKey=${serviceKey}&cityCode=${cityCode}&nodeId=${nodeId}&numOfRows=100&pageNo=1&_type=json`;
            try {
                const response = await fetch(getProxyUrl(targetUrl));
                if (!response.ok) return "NETWORK_ERROR";
                const text = await response.text();
                const result = parseHybrid(text);
                if (result.type === 'error') return result.msg;
                const data = result.data;
                if (data.response?.header?.resultCode !== '00') return data.response?.header?.resultMsg || "API_ERROR";
                const items = data.response.body.items?.item;
                if (!items) return [];
                const list = Array.isArray(items) ? items : [items];
                return list.map(normalizeBusData);
            } catch (error) { return "NETWORK_ERROR"; }
        }
        
        async function fetchRouteInfo(cityCode, routeId) {
            if (!apiKey || !routeId) return null;
            if (routeDestCache[routeId]) return routeDestCache[routeId]; 
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/BusRouteInfoInqireService/getRouteInfoIem?serviceKey=${serviceKey}&cityCode=${cityCode}&routeId=${routeId}&_type=json`;
            try {
                const response = await fetch(getProxyUrl(targetUrl));
                const text = await response.text();
                const result = parseHybrid(text);
                if (result.type === 'json' && result.data.response?.header?.resultCode === '00') {
                    const item = result.data.response.body.items.item;
                    if (item && item.endnodenm) {
                        routeDestCache[routeId] = item.endnodenm;
                        localStorage.setItem('route_dest_cache', JSON.stringify(routeDestCache));
                        return item.endnodenm;
                    }
                }
            } catch (e) { }
            return null;
        }

        async function searchStationAPI(keyword) {
            const serviceKey = getEncodedKey();
            const targetCityCode = CITY_CODES[currentRegion];
            let targetUrl = `http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getSttnNoList?serviceKey=${serviceKey}&cityCode=${targetCityCode}&numOfRows=500&_type=json`;
            targetUrl += `&nodeNm=${encodeURIComponent(keyword)}`;
            try {
                const response = await fetch(getProxyUrl(targetUrl));
                const text = await response.text();
                const result = parseHybrid(text);
                if (result.type === 'error') return { error: result.msg };
                const data = result.data;
                if (data.response?.header?.resultCode !== '00') return { error: data.response.header.resultMsg };
                const items = data.response.body.items?.item;
                if (!items) return [];
                const list = Array.isArray(items) ? items : [items];
                return list.map(normalizeBusData);
            } catch (e) { return { error: "NETWORK_ERROR" }; }
        }

        // --- Main Render Logic ---
        function renderList() {
            const container = document.getElementById('dynamic-list-container');
            const empty = document.getElementById('empty-state');
            container.innerHTML = '';
            empty.classList.add('hidden');
            
            // ì•ˆë™ì‹œëŠ” í‚¤ ì—†ì–´ë„ ë¨
            if (!apiKey && currentRegion !== 'andong') { empty.classList.remove('hidden'); return; }

            const cityCode = CITY_CODES[currentRegion];
            const targets = stationConfig[currentRegion];

            if (!targets || targets.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400">ë“±ë¡ëœ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒë‹¨ '+ ì •ë¥˜ì¥ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</div>`;
                return;
            }
            
            // ì•ˆë™ì‹œëŠ” ì¶”ê°€ ë²„íŠ¼ ìˆ¨ê¹€ (ê³ ì • ëª¨ë“œ)
            const addBtn = document.getElementById('add-btn-main');
            if(addBtn) {
                if(currentRegion === 'andong') addBtn.classList.add('hidden');
                else addBtn.classList.remove('hidden');
            }

            targets.forEach((station, index) => {
                if(currentRegion === 'andong') {
                    // ì•ˆë™: ì •ì  ì‹œê°„í‘œ ë¡œì§
                    renderStaticCard(index, station);
                } else {
                    // íƒ€ ì§€ì—­: ê¸°ì¡´ API ë¡œì§ (Skeleton -> Load)
                    const skeletonHtml = `
                        <div id="station-card-${index}" class="toss-card p-5 mb-4 !bg-white/50 animate-pulse relative">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center gap-2.5">
                                    <div class="w-10 h-10 rounded-[16px] bg-gray-200"></div>
                                    <div>
                                        <div class="h-4 w-32 bg-gray-200 rounded mb-1.5"></div>
                                        <div class="h-3 w-20 bg-gray-200 rounded"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="h-12 bg-gray-200 rounded-xl"></div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', skeletonHtml);
                    loadStationData(index, cityCode, station);
                }
            });
        }

        // [NEW] ì•ˆë™ì‹œ ì •ì  ì‹œê°„í‘œ ë Œë”ë§ í•¨ìˆ˜ (CSV ì§€ì› + ì•„ì´ì½˜/ë°°ì§€ ì ìš©)
        function renderStaticCard(index, station) {
            const container = document.getElementById('dynamic-list-container');
            
            // ANDONG_TIMETABLEì´ ë¹„ì–´ìˆìœ¼ë©´(ë¡œë”© ì „ or ì‹¤íŒ¨) ë¹ˆ ê°ì²´ ì²˜ë¦¬
            const timetable = ANDONG_TIMETABLE[station.nodeId]; 
            
            // ì •ë¥˜ì¥ ì´ë¦„ì— ë”°ë¥¸ ì•„ì´ì½˜/ìƒ‰ìƒ ê²°ì •
            let iconClass = "fa-solid fa-map-pin";
            let iconBgClass = "bg-gray-100";
            let iconTextClass = "text-gray-500";

            if (station.name.includes("ëŒ€í•™êµ") || station.name.includes("ì•ˆë™ëŒ€")) {
                iconClass = "fa-solid fa-school";
                iconBgClass = "bg-green-100";
                iconTextClass = "text-green-600";
            } else if (station.name.includes("CGV")) {
                iconClass = "fa-solid fa-film";
                iconBgClass = "bg-red-100";
                iconTextClass = "text-red-500";
            } else if (station.name.includes("í„°ë¯¸ë„") || station.name.includes("ì—­")) {
                iconClass = "fa-solid fa-bus";
                iconBgClass = "bg-blue-100";
                iconTextClass = "text-blue-600";
            }
            
            // í˜„ì¬ ì‹œê°„ ë° ìš”ì¼ êµ¬í•˜ê¸°
            const now = new Date();
            const nowTotalMin = now.getHours() * 60 + now.getMinutes();
            const day = now.getDay(); // 0:ì¼, 6:í† 
            
            let dayKey = 'weekday';
            let dayLabel = "í‰ì¼";
            if(day === 0) { dayKey = 'holiday'; dayLabel = "ì¼/ê³µíœ´ì¼"; }
            else if(day === 6) { dayKey = 'saturday'; dayLabel = "í† ìš”ì¼"; }

            let contentHtml = '';
            if (!timetable || Object.keys(timetable).length === 0) {
                let msg = "ë“±ë¡ëœ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤";
                let subMsg = "ì‹œê°„í‘œ ë°ì´í„°ê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤.";
                
                contentHtml = `
                    <div class="p-4 bg-gray-50/50 rounded-xl text-center border border-gray-100">
                        <i class="fa-regular fa-calendar-xmark text-gray-300 text-lg mb-1"></i>
                        <p class="text-xs text-gray-500 font-bold">${msg}</p>
                        <p class="text-[10px] text-gray-400">${subMsg}</p>
                    </div>`;
            } else {
                let hasRoutes = false;
                // timetableì´ ë°°ì—´ì¸ì§€ ì²´í¬ (CSV íŒŒì‹± ë°©ì‹ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
                // ë§Œì•½ timetableì´ ë°°ì—´ì´ë©´ ë°”ë¡œ loop, ì•„ë‹ˆë©´ keysë¡œ loop?
                // í˜„ì¬ ë¡œì§ìƒ timetableì€ ë°°ì—´ [{routeNo, dest, times}, ...] í˜•íƒœì—¬ì•¼ í•¨.
                // í•˜ì§€ë§Œ CSV íŒŒì‹± ë¡œì§ì—ì„œ dayë³„ ë¶„ë¦¬í–ˆìœ¼ë¯€ë¡œ timetable êµ¬ì¡°ê°€ ì¡°ê¸ˆ ë³µì¡í•´ì§?
                // ì•„ë‹ˆ, parseAndongCSVì—ì„œ ì´ë¯¸ { times: { weekday: [], ... } } í˜•íƒœë¡œ ë§Œë“¦.
                // timetable ìì²´ê°€ ë°°ì—´ì„.

                if(Array.isArray(timetable)) {
                    timetable.forEach(route => {
                        // ì‹œê°„í‘œ ê°€ì ¸ì˜¤ê¸°
                        let timeList = [];
                        if(Array.isArray(route.times)) {
                            timeList = route.times; // êµ¬ë²„ì „ ë°ì´í„° í˜¸í™˜
                        } else if(typeof route.times === 'object') {
                            timeList = route.times[dayKey] || route.times['weekday'] || [];
                        }

                        if(!timeList || timeList.length === 0) return;
                        hasRoutes = true;

                        // ë¯¸ë˜ì˜ ì‹œê°„ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ê²ƒ ì°¾ê¸°
                        let nextTimeStr = null;
                        let minDiff = 9999;
                        let isNextDay = false;

                        // ì˜¤ëŠ˜ ë‚¨ì€ ì‹œê°„ ì°¾ê¸°
                        for(let time of timeList) {
                            const [h, m] = time.split(':').map(Number);
                            const busTotalMin = h * 60 + m;
                            if (busTotalMin > nowTotalMin) {
                                if (busTotalMin - nowTotalMin < minDiff) {
                                    minDiff = busTotalMin - nowTotalMin;
                                    nextTimeStr = time;
                                }
                            }
                        }

                        // ì˜¤ëŠ˜ ë‚¨ì€ê²Œ ì—†ìœ¼ë©´ ë‚´ì¼ ì²«ì°¨ ì°¾ê¸°
                        if (!nextTimeStr && timeList.length > 0) {
                             nextTimeStr = timeList[0];
                             const [h, m] = nextTimeStr.split(':').map(Number);
                             const busTotalMin = h * 60 + m;
                             // í•˜ë£¨ëŠ” 1440ë¶„
                             minDiff = (1440 - nowTotalMin) + busTotalMin;
                             isNextDay = true;
                    }

                        let timeDisplay = "ìš´í–‰ì¢…ë£Œ";
                        let colorClass = "text-gray-400 text-xs";
                        
                        if (nextTimeStr) {
                            if(isNextDay) {
                                 const hours = Math.floor(minDiff / 60);
                                 const mins = minDiff % 60;
                                 timeDisplay = `${hours}ì‹œê°„ ${mins}ë¶„ í›„ ì¶œë°œ (ìµì¼ ${nextTimeStr})`;
                                 colorClass = "text-gray-500 font-medium";
                            } else {
                                if (minDiff < 60) timeDisplay = `${minDiff}ë¶„ í›„ (${nextTimeStr})`;
                                else timeDisplay = `${nextTimeStr} ì¶œë°œ`;
                                
                                colorClass = minDiff < 10 ? "text-red-500 font-bold" : "text-main";
                            }
                        }

                        // ê¸‰í–‰ ë²„ìŠ¤ ì²˜ë¦¬ (ë°°ì§€ ìƒ‰ìƒ)
                        const isExpress = route.routeNo.includes("ê¸‰í–‰");
                        const badgeText = isExpress ? "ê¸‰í–‰" : "ì¼ë°˜";
                        const badgeColor = isExpress ? "bg-red-500" : "bg-blue-500";

                        contentHtml += `
                        <div class="glass-item p-3 flex items-center justify-between active:scale-[0.98] transition-transform">
                            <div class="flex items-center gap-3">
                                <span class="${badgeColor} text-white text-[10px] font-bold px-1.5 py-0.5 rounded min-w-[36px] text-center">${badgeText}</span>
                                <div>
                                    <span class="text-sm font-bold text-main">${route.routeNo}</span>
                                    <span class="text-[10px] text-sub block">${route.dest} ë°©ë©´</span>
                                </div>
                            </div>
                            <span class="text-sm ${colorClass}">${timeDisplay}</span>
                        </div>`;
                    });
                }
                
                if(!hasRoutes) {
                     contentHtml = `
                    <div class="p-4 bg-gray-50/50 rounded-xl text-center border border-gray-100">
                        <p class="text-xs text-gray-500 font-bold">ì˜¤ëŠ˜ì€ ìš´í–‰í•˜ëŠ” ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-[10px] text-gray-400">(${dayLabel} ê¸°ì¤€)</p>
                    </div>`;
                }
            }

            const kakaoSearchQuery = `${CITY_NAMES[currentRegion]} ${station.name}`;
            const kakaoMapUrl = `https://map.kakao.com/link/search/${encodeURIComponent(kakaoSearchQuery)}`;

            const cardHtml = `
                <div class="toss-card p-5 mb-4 !bg-white/70 animate-[fadeInUp_0.4s_ease-out] relative group">
                    <div class="absolute top-4 right-4 flex gap-1">
                        <span class="text-[10px] text-blue-500 bg-blue-50 px-2 py-1 rounded-md font-bold">ğŸ“… ${dayLabel}</span>
                        <a href="${kakaoMapUrl}" target="_blank" class="text-xs btn-kakao px-2 py-1 rounded-md font-bold hover:opacity-80 transition-opacity flex items-center gap-1 shadow-sm">
                            <i class="fa-solid fa-map-location-dot"></i> ì¹´ì¹´ì˜¤ë§µ
                        </a>
                        <button onclick="removeStation('${currentRegion}', ${index})" class="delete-btn text-gray-300 hover:text-red-500 p-1 hidden">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2.5">
                            <div class="w-10 h-10 rounded-[16px] ${iconBgClass} flex items-center justify-center ${iconTextClass} text-lg shadow-sm">
                                <i class="${iconClass}"></i>
                            </div>
                            <div>
                                <h4 class="text-base font-bold text-main">${station.name}</h4>
                                <p class="text-xs text-sub text-[10px]">ID: ${station.nodeId} (ì‹œê°„í‘œ ëª¨ë“œ)</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">${contentHtml}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHtml);
        }

        async function loadStationData(index, cityCode, station) {
            try {
                // 1ë‹¨ê³„: ë„ì°© ì •ë³´ ì¡°íšŒ
                const arrivalPromise = fetchBusArrival(cityCode, station.nodeId);
                const promises = [arrivalPromise];
                
                // ì•ˆë™ ì™¸ ì§€ì—­ë§Œ ê²½ìœ  ë…¸ì„  ì¡°íšŒ
                if (currentRegion !== 'andong') {
                    // promises.push(getStationRoutes(cityCode, station.nodeId)); // í•„ìš”ì‹œ ì¶”ê°€
                }

                const results = await Promise.allSettled(promises);
                const arrivalResult = results[0];
                const routeResult = results[1];

                let safeArrivals = [];
                let errorMessage = null;

                if (arrivalResult.status === 'fulfilled') {
                    if (typeof arrivalResult.value === 'string') errorMessage = arrivalResult.value;
                    else if (Array.isArray(arrivalResult.value)) safeArrivals = arrivalResult.value;
                }

                let allRoutes = [];
                if (routeResult && routeResult.status === 'fulfilled' && Array.isArray(routeResult.value)) {
                    allRoutes = routeResult.value;
                }

                if (errorMessage) {
                    renderErrorCard(index, station, errorMessage);
                    return;
                }

                let finalDisplayList = [];

                if (allRoutes.length > 0) {
                    const arrivalMap = new Map();
                    safeArrivals.forEach(a => {
                        arrivalMap.set(String(a.routeno), a);
                        if(a.routeid) arrivalMap.set(String(a.routeid), a); 
                    });

                    finalDisplayList = allRoutes.map(route => {
                        let arrival = null;
                        if(route.routeid) arrival = arrivalMap.get(String(route.routeid));
                        if(!arrival && route.routeno) arrival = arrivalMap.get(String(route.routeno));

                        if (arrival) return { ...route, ...arrival, hasInfo: true };
                        else return { ...route, hasInfo: false };
                    });
                } else {
                    finalDisplayList = safeArrivals.map(a => ({ ...a, hasInfo: true }));
                }

                finalDisplayList = finalDisplayList.filter(item => {
                    if(!item.routeno) return false;
                    if(item.routeno === '?') return false;
                    return true;
                });

                finalDisplayList.sort((a, b) => {
                    if (a.hasInfo && !b.hasInfo) return -1;
                    if (!a.hasInfo && b.hasInfo) return 1;
                    if (a.hasInfo && b.hasInfo) {
                        return (parseInt(a.arrtime) || 0) - (parseInt(b.arrtime) || 0);
                    }
                    return String(a.routeno).localeCompare(String(b.routeno), undefined, { numeric: true, sensitivity: 'base' });
                });

                // í–‰ì„ ì§€ ë³´ê°•
                for (let j = 0; j < Math.min(finalDisplayList.length, 5); j++) {
                    const bus = finalDisplayList[j];
                    if (bus.hasInfo && !bus.endnodenm && bus.routeid) {
                        const destName = await fetchRouteInfo(cityCode, bus.routeid);
                        if (destName) bus.endnodenm = destName;
                    }
                }

                renderCard(index, station, finalDisplayList);

            } catch (e) {
                console.error(e);
                renderErrorCard(index, station, "ì•± ì˜¤ë¥˜: " + (e.message || "ì•Œ ìˆ˜ ì—†ìŒ"));
            }
        }

        // [ìˆ˜ì •] í—¬í¼ í•¨ìˆ˜: ì‹œê°„ í¬ë§· (HH:mm)
        function formatTime(date) {
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            return `${h}:${m}`;
        }

        function renderCard(index, station, list) {
            const skeletonCard = document.getElementById(`station-card-${index}`);
            if (!skeletonCard) return;

            let contentHtml = '';
            if (list.length > 0) {
                list.forEach(bus => {
                    let timeStr, colorClass, badgeColor, destText;
                    const routeType = bus.routetp || '';
                    const routeNo = bus.routeno || '?';

                    if (bus.hasInfo) {
                        const min = Math.floor(parseInt(bus.arrtime) / 60);
                        
                        // [NEW] ë„ì°© ì˜ˆì • ì‹œê°„ ê³„ì‚°
                        const now = new Date();
                        const arrivalDate = new Date(now.getTime() + (parseInt(bus.arrtime) * 1000));
                        const arrivalTimeStr = formatTime(arrivalDate);

                        timeStr = min < 2 ? `ê³§ ë„ì°© (${arrivalTimeStr})` : `${min}ë¶„ (${arrivalTimeStr})`;
                        colorClass = min < 5 ? "text-red-500 font-bold" : "text-main";
                        badgeColor = routeType.includes('ê¸‰í–‰') ? 'bg-red-500' : 'bg-blue-500';
                        destText = bus.endnodenm ? `${bus.endnodenm} ë°©ë©´` : (bus.nodenm ? `${bus.nodenm} ê²½ìœ ` : 'ìš´í–‰ì¤‘');
                    } else {
                        timeStr = "ë„ì°© ì •ë³´ ì—†ìŒ";
                        colorClass = "text-gray-400 text-xs";
                        badgeColor = "bg-gray-400";
                        destText = bus.endnodenm ? `${bus.endnodenm} ë°©ë©´` : "ìš´í–‰ì¢…ë£Œ/ëŒ€ê¸°";
                    }

                    contentHtml += `
                    <div class="glass-item p-3 flex items-center justify-between active:scale-[0.98] transition-transform">
                        <div class="flex items-center gap-3">
                            <span class="${badgeColor} text-white text-[10px] font-bold px-1.5 py-0.5 rounded min-w-[36px] text-center">${routeType || 'ì¼ë°˜'}</span>
                            <div>
                                <span class="text-sm font-bold text-main">${routeNo}</span>
                                <span class="text-[10px] text-sub block">
                                    ${destText} ${bus.arrprevstationcnt ? `Â· ${bus.arrprevstationcnt}ë²ˆì§¸ ì „` : ''}
                                </span>
                            </div>
                        </div>
                        <span class="text-sm ${colorClass}">${timeStr}</span>
                    </div>`;
                });
            } else {
                contentHtml = `
                    <div class="p-4 bg-gray-50/50 rounded-xl text-center border border-gray-100">
                        <i class="fa-solid fa-moon text-gray-300 text-lg mb-1"></i>
                        <p class="text-xs text-gray-500 font-bold">ìš´í–‰ì¤‘ì¸ ë²„ìŠ¤ ì—†ìŒ</p>
                    </div>`;
            }

            const cardHtml = `
                <div class="toss-card p-5 mb-4 !bg-white/70 animate-[fadeInUp_0.4s_ease-out] relative group">
                    <button onclick="removeStation('${currentRegion}', ${index})" class="delete-btn absolute top-4 right-4 text-gray-300 hover:text-red-500 p-1">
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2.5">
                            <div class="w-10 h-10 rounded-[16px] bg-blue-100 flex items-center justify-center text-blue-600 text-lg shadow-sm">
                                <i class="fa-solid fa-bus"></i>
                            </div>
                            <div>
                                <h4 class="text-base font-bold text-main">${station.name}</h4>
                                <p class="text-xs text-sub text-[10px]">ARS: ${station.arsNo || '-'} | Node: ${station.nodeId}</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">${contentHtml}</div>
                </div>
            `;
            skeletonCard.outerHTML = cardHtml;
        }

        function renderErrorCard(index, station, msg) {
            const skeletonCard = document.getElementById(`station-card-${index}`);
            if (!skeletonCard) return;
            
            let displayMsg = msg;
            if (msg.includes('KEY_NOT_REGISTERED') || msg.includes('KEY_ERROR')) displayMsg = "ì¸ì¦í‚¤ ì—ëŸ¬: í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
            else if (msg === 'NETWORK_ERROR') displayMsg = "ë„¤íŠ¸ì›Œí¬/í”„ë¡ì‹œ ì—°ê²° ì‹¤íŒ¨";

            const kakaoSearchQuery = `${CITY_NAMES[currentRegion]} ${station.name}`;
            const kakaoMapUrl = `https://map.kakao.com/link/search/${encodeURIComponent(kakaoSearchQuery)}`;

            const html = `
                <div class="toss-card p-5 mb-4 !bg-red-50 border-red-100 relative">
                     <div class="absolute top-4 right-4 flex gap-1">
                        <a href="${kakaoMapUrl}" target="_blank" class="text-xs btn-kakao px-2 py-1 rounded-md font-bold hover:opacity-80 transition-opacity flex items-center gap-1 shadow-sm">
                            <i class="fa-solid fa-map-location-dot"></i> ì¹´ì¹´ì˜¤ë§µ
                        </a>
                        <button onclick="removeStation('${currentRegion}', ${index})" class="text-red-300 hover:text-red-500 p-1">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
                        <h4 class="text-base font-bold text-red-600">${station.name}</h4>
                    </div>
                    <p class="text-xs text-red-500 break-all">${displayMsg}</p>
                </div>
            `;
            skeletonCard.outerHTML = html;
        }

        // --- Event Handlers (ë™ì¼) ---
        function openSearchModal() {
            // ì•ˆë™ì‹œëŠ” ì‹œê°„í‘œ ëª¨ë“œë¼ ê²€ìƒ‰ API ì˜ë¯¸ ì—†ìŒ -> ìˆ˜ë™ ë“±ë¡ ìœ ë„
            if(currentRegion === 'andong') { 
                document.getElementById('search-modal').classList.remove('hidden');
                document.getElementById('search-modal-region').innerText = "ì•ˆë™ì‹œ (ì‹œê°„í‘œ ëª¨ë“œ)";
                document.getElementById('api-search-box').classList.add('hidden');
                document.getElementById('andong-manual-guide').classList.remove('hidden');
                document.getElementById('add-station-results').innerHTML = '';
                return;
            }

            if(!apiKey) { alert("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); openSettings(); return; }
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('search-modal-region').innerText = `${CITY_NAMES[currentRegion]}ì—ì„œ ê²€ìƒ‰`;
            document.getElementById('api-search-box').classList.remove('hidden');
            document.getElementById('andong-manual-guide').classList.add('hidden');
            document.getElementById('add-station-input').placeholder = `ì˜ˆ: ${CITY_NAMES[currentRegion]} ì •ë¥˜ì¥ ì´ë¦„`;
            document.getElementById('add-station-input').value = '';
            document.getElementById('add-station-results').innerHTML = '<p class="text-center text-gray-400 mt-10 text-sm">ì •ë¥˜ì¥ ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>';
            document.getElementById('add-station-input').focus();
        }
        function closeSearchModal() { document.getElementById('search-modal').classList.add('hidden'); }
        async function doSearchStation() {
            const keyword = document.getElementById('add-station-input').value.trim();
            if(!keyword) return;
            const resultArea = document.getElementById('add-station-results');
            resultArea.innerHTML = '<p class="text-center mt-4"><i class="fa-solid fa-spinner fa-spin"></i> ê²€ìƒ‰ì¤‘...</p>';
            const result = await searchStationAPI(keyword);
            if (result.error) { resultArea.innerHTML = `<p class="text-center mt-4 text-red-400 text-xs">ì˜¤ë¥˜: ${result.error}</p>`; return; }
            if (result.length === 0) { resultArea.innerHTML = '<p class="text-center mt-4 text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            result.sort((a, b) => (a.nodenm || "").length - (b.nodenm || "").length);
            let html = '';
            result.forEach(item => {
                const arsNo = item.nodeno || '-';
                html += `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-2xl border border-gray-100">
                    <div class="flex-1 min-w-0 mr-2">
                        <p class="font-bold text-main text-sm truncate">${item.nodenm}</p>
                        <p class="text-xs text-gray-400 truncate">ë²ˆí˜¸: <span class="text-blue-500 font-bold">${arsNo}</span> | ID: ${item.nodeid}</p>
                    </div>
                    <button onclick="addStation('${(item.nodenm || "").replace(/'/g, "\\'")}', '${item.nodeid}', '${arsNo}')" class="flex-none text-xs bg-blue-500 text-white px-3 py-2 rounded-xl font-bold hover:bg-blue-600 transition-colors">ì¶”ê°€</button>
                </div>`;
            });
            resultArea.innerHTML = html;
        }
        function addStation(name, nodeId, arsNo) {
            stationConfig[currentRegion].push({ name: name, sub: "ì‚¬ìš©ì ì¶”ê°€", nodeId: nodeId, arsNo: arsNo, tags: [] });
            localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig));
            alert(`'${name}' ì •ë¥˜ì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeSearchModal();
            renderList();
        }
        function removeStation(region, index) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                stationConfig[region].splice(index, 1);
                localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig));
                renderList();
            }
        }
        function selectRegion(region) {
            currentRegion = region;
            ['andong', 'gumi', 'chilgok'].forEach(id => {
                const el = document.getElementById('btn-' + id);
                const txt = el.querySelector('.status-text');
                if (id === region) { el.classList.add('region-card-selected'); txt.innerText = 'ì„ íƒë¨'; } 
                else { el.classList.remove('region-card-selected'); txt.innerText = 'ì„ íƒí•˜ê¸°'; }
            });
            document.getElementById('region-status-label').innerText = CITY_NAMES[region];
            renderList();
        }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const type = document.querySelector('input[name="key-type"]:checked').value;
            const proxy = document.getElementById('proxy-select').value;
            if(key) {
                apiKey = key; keyType = type; selectedProxy = proxy;
                localStorage.setItem('toss_bus_api_key', key);
                localStorage.setItem('toss_bus_key_type', type);
                localStorage.setItem('toss_bus_proxy', proxy);
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeSettings();
                renderList();
            } else { alert('í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
        }
        function resetData() {
            if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('my_station_config_v40');
                localStorage.removeItem('station_routes_cache_v1');
                stationConfig = JSON.parse(JSON.stringify(defaultStationConfig));
                renderList();
                alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeSettings();
            }
        }
        async function testConnection() {
            const inputKey = document.getElementById('api-key-input').value.trim();
            const resultBox = document.getElementById('test-result');
            const selectedType = document.querySelector('input[name="key-type"]:checked').value;
            const currentProxy = document.getElementById('proxy-select').value;
            
            // ì„ì‹œ ì „ì—­ ë³€ìˆ˜ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)
            const originalProxy = selectedProxy;
            selectedProxy = currentProxy;
            
            if(!inputKey) { alert("í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
            resultBox.classList.remove('hidden');
            resultBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> í…ŒìŠ¤íŠ¸ ì¤‘...';
            apiKey = inputKey; keyType = selectedType;
            
            // ì•ˆë™ëŒ€ (ìˆ«ìID)ë¡œ í…ŒìŠ¤íŠ¸
            const result = await fetchBusArrival('37010', 'DJB8001793'); 
            
            // ì „ì—­ ë³€ìˆ˜ ë³µêµ¬
            selectedProxy = originalProxy;

            if (Array.isArray(result)) {
                resultBox.innerHTML = '<span class="text-green-600 font-bold">âœ… ì—°ê²° ì„±ê³µ!</span><br>ëª¨ë“  ì„¤ì •ì´ ì •ìƒì…ë‹ˆë‹¤.';
            } else {
                resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ${result}</span>`;
            }
        }

        // [NEW] ìˆ˜ë™ ì¶”ê°€ í•¨ìˆ˜ (ë²„íŠ¼ í•¸ë“¤ëŸ¬)
        function manualAddStation() {
            const id = document.getElementById('manual-station-id').value;
            const name = document.getElementById('manual-station-name').value;
            if(!id || !name) { alert("ì´ë¦„ê³¼ IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            addStation(name, id, "ì§ì ‘ì¶”ê°€");
        }
        
        // ê¸°ì¡´ prompt ë°©ì‹ ìˆ˜ë™ ì¶”ê°€ (íƒ€ ì§€ì—­ìš©)
        function addManualStation() {
            const name = document.getElementById('manual-station-name').value;
            const id = document.getElementById('manual-station-id').value;
            if(!name || !id) { alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
            addStation(name, id, "ì§ì ‘ì¶”ê°€");
        }

        const mainContent = document.getElementById('main-content');
        const island = document.getElementById('dynamic-island');
        mainContent.addEventListener('scroll', () => { island.classList.toggle('island-active', mainContent.scrollTop > 20); });
    </script>
</body>
</html>