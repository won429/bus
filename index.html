<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Realtime Bus - Final Native Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Pretendard', sans-serif;
            background-color: #F2F4F6;
            color: #191F28;
            touch-action: pan-y;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-toss-gradient { background: linear-gradient(to bottom right, #F2F4F6, #E8ECF2, #DEE2E6); }
        .toss-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04); 
            transition: transform 0.1s;
            overflow: hidden;
        }
        .toss-card:active { transform: scale(0.98); }
        .glass-item {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
        }
        .text-main { color: #191F28; }
        .text-sub { color: #6B7684; }
        .pt-safe { padding-top: max(10px, env(safe-area-inset-top)); }
        .pb-safe-nav { padding-bottom: max(80px, env(safe-area-inset-bottom)); } /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ì—¬ë°± */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .region-card-selected { background-color: rgba(255, 255, 255, 0.9) !important; border-color: #3182F6 !important; box-shadow: 0 4px 12px rgba(49, 130, 246, 0.15) !important; }
        
        #dynamic-island { transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .island-active {
            width: 140px !important; background-color: #191F28 !important; border-radius: 9999px !important;
            margin-top: 10px; padding: 8px 16px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
        }
        .island-active .header-title { width: 0; opacity: 0; margin: 0; overflow: hidden; transform: scale(0.8); }
        .island-active .icon-container { width: 100%; justify-content: center; gap: 24px !important; }
        .island-active .icon-bg { background-color: transparent !important; width: auto !important; height: auto !important; box-shadow: none !important; color: white !important; }
        
        @keyframes pulse-custom { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse-custom { animation: pulse-custom 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-kakao { background-color: #FAE100; color: #3C1E1E; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
        .toss-card:hover .delete-btn { opacity: 1; }
        
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ì• ë‹ˆë©”ì´ì…˜ */
        .nav-pill-active { background-color: #191F28; color: white; }
        .nav-pill-inactive { background-color: transparent; color: #6B7684; }
        
        /* ì§€í•˜ì²  ë…¸ì„  ë°°ì§€ ìƒ‰ìƒ - ì½”ë ˆì¼ ë¸”ë£¨ */
        .badge-daegyeong { background-color: #0054A6; color: white; }
        
        /* ë…¸ì„  ì„ íƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .line-badge { transition: all 0.2s; border: 1px solid transparent; }
        .line-badge-active { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: rgba(0,0,0,0.05); }
        .line-badge-inactive { opacity: 0.5; background-color: #F2F4F6; color: #8B95A1; border-color: #E5E8EB; }
    </style>
</head>
<body class="w-full h-[100dvh] flex flex-col overflow-hidden bg-toss-gradient">

    <!-- í—¤ë” -->
    <header class="fixed top-0 left-0 w-full z-50 flex justify-center pt-safe pointer-events-none">
        <div id="dynamic-island" class="pointer-events-auto w-full max-w-md px-5 py-2 flex items-center justify-between bg-transparent mx-auto origin-top mt-2">
            <h1 class="header-title text-xl font-bold text-main whitespace-nowrap transition-all duration-300 origin-left">ëŒ€ì¤‘êµí†µ</h1>
            <div class="icon-container flex gap-2 transition-all duration-300">
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="openSearchModal()">
                    <i class="fa-solid fa-magnifying-glass text-sm"></i>
                </div>
                <div class="icon-bg w-9 h-9 rounded-full bg-white/50 flex items-center justify-center text-main shadow-sm backdrop-blur-sm cursor-pointer hover:bg-white/80 transition-colors" onclick="openSettings()">
                    <i class="fa-solid fa-gear text-sm"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main id="main-content" class="flex-1 overflow-y-auto scrollbar-hide px-5 pb-safe-nav w-full max-w-md mx-auto relative pt-16">
        
        <!-- [1] ë²„ìŠ¤ ë·° -->
        <div id="view-bus" class="fade-in-up">
            <!-- ì§€ì—­ ì„ íƒ (ë²„ìŠ¤) -->
            <div class="mb-6 fade-in-up delay-100">
                <h3 class="text-lg font-bold text-main mb-3 px-1">ì§€ì—­ ì„ íƒ</h3>
                <div class="flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1">
                    <div id="btn-andong" onclick="selectRegion('andong')" class="toss-card region-card-selected min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 text-lg"><i class="fa-solid fa-location-dot"></i></div>
                        <div><p class="text-sm font-bold text-main">ì•ˆë™ì‹œ</p><p class="text-xs text-sub status-text" id="status-andong">ì—°ê²° ëŒ€ê¸°</p></div>
                    </div>
                    <div id="btn-gumi" onclick="selectRegion('gumi')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 text-lg"><i class="fa-solid fa-city"></i></div>
                        <div><p class="text-sm font-bold text-main">êµ¬ë¯¸ì‹œ</p><p class="text-xs text-sub status-text" id="status-gumi">ì—°ê²° ëŒ€ê¸°</p></div>
                    </div>
                    <div id="btn-chilgok" onclick="selectRegion('chilgok')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500 text-lg"><i class="fa-solid fa-tree"></i></div>
                        <div><p class="text-sm font-bold text-main">ì¹ ê³¡êµ°</p><p class="text-xs text-sub status-text" id="status-chilgok">ì—°ê²° ëŒ€ê¸°</p></div>
                    </div>
                </div>
                <p id="city-code-status" class="text-[10px] text-gray-400 mt-2 px-1 text-right">ë„ì‹œ ì½”ë“œ ì¡°íšŒ ëŒ€ê¸°ì¤‘...</p>
            </div>

            <!-- ë²„ìŠ¤ ëª©ë¡ -->
            <div class="mb-4 fade-in-up delay-200">
                <div class="flex justify-between items-end mb-3 px-1">
                    <div>
                        <h3 class="text-lg font-bold text-main">ë„ì°© ì •ë³´</h3>
                        <span class="text-xs font-medium text-sub" id="region-status-label">ì•ˆë™ì‹œ</span>
                    </div>
                    <button id="add-btn-main" onclick="openSearchModal()" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors shadow-sm">
                        + ì •ë¥˜ì¥ ì¶”ê°€
                    </button>
                </div>
                
                <div id="loading-spinner" class="hidden text-center py-20 animate-pulse-custom">
                    <i class="fa-solid fa-satellite-dish text-3xl text-blue-500 mb-2"></i>
                    <p class="text-sm font-bold text-main" id="loading-text">ë°ì´í„° ì—°ê²° ì¤‘...</p>
                </div>

                <!-- ì—ëŸ¬ ë©”ì‹œì§€ íŒ¨ë„ -->
                <div id="error-diagnosis" class="hidden mx-1 mb-4 p-4 bg-red-50 rounded-2xl border border-red-100">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
                        <p class="text-sm text-red-600 font-bold" id="error-title">ì˜¤ë¥˜ ë°œìƒ</p>
                    </div>
                    <p class="text-xs text-red-500 mb-3 leading-relaxed break-all" id="error-desc">ë‚´ìš©</p>
                    <a href="https://corsproxy.io/" target="_blank" class="block w-full bg-red-100 text-red-600 text-center py-2 rounded-xl text-xs font-bold hover:bg-red-200 transition-colors shadow-sm">
                        CORS í”„ë¡ì‹œ í™•ì¸ í•„ìš” (ìë™ ì ìš©ë¨)
                    </a>
                </div>

                <div id="dynamic-list-container" class="space-y-4"></div>
                
                <div id="empty-state" class="hidden text-center py-10 bg-white/40 rounded-3xl border border-white/60">
                    <i class="fa-solid fa-key text-3xl text-gray-300 mb-2"></i>
                    <p class="text-sm font-bold text-gray-500">API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
                    <p class="text-xs text-gray-400 mt-1">
                        <span class="text-blue-500 font-bold">ì•ˆë™ì‹œ</span>ëŠ” í‚¤ ì—†ì´ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                        ë‹¤ë¥¸ ì§€ì—­ì€ ì„¤ì •ì—ì„œ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                    </p>
                </div>
            </div>
        </div>

        <!-- [2] ì§€í•˜ì²  ë·° -->
        <div id="view-subway" class="hidden fade-in-up">
            <!-- ì§€ì—­ ì„ íƒ (ì§€í•˜ì² ) -->
            <div class="mb-4 fade-in-up delay-100">
                <h3 class="text-lg font-bold text-main mb-3 px-1">ì§€ì—­ ì„ íƒ</h3>
                <div class="flex gap-3 overflow-x-auto scrollbar-hide pb-2 -mx-1 px-1">
                    <!-- êµ¬ë¯¸ì‹œ -->
                    <div id="sub-btn-gumi" onclick="selectSubwayRegion('gumi')" class="toss-card region-card-selected min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 text-lg"><i class="fa-solid fa-train-subway"></i></div>
                        <div><p class="text-sm font-bold text-main">ê²½ë¶ êµ¬ë¯¸ì‹œ</p><p class="text-xs text-sub status-text">ì„ íƒë¨</p></div>
                    </div>
                    <!-- ì¹ ê³¡êµ° -->
                    <div id="sub-btn-chilgok" onclick="selectSubwayRegion('chilgok')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500 text-lg"><i class="fa-solid fa-train"></i></div>
                        <div><p class="text-sm font-bold text-main">ê²½ë¶ ì¹ ê³¡êµ°</p><p class="text-xs text-sub status-text">ì„ íƒí•˜ê¸°</p></div>
                    </div>
                    <!-- ëŒ€êµ¬ê´‘ì—­ì‹œ -->
                    <div id="sub-btn-daegu" onclick="selectSubwayRegion('daegu')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 text-lg"><i class="fa-solid fa-subway"></i></div>
                        <div><p class="text-sm font-bold text-main">ëŒ€êµ¬ê´‘ì—­ì‹œ</p><p class="text-xs text-sub status-text">ì„ íƒí•˜ê¸°</p></div>
                    </div>
                    <!-- ê²½ì‚°ì‹œ -->
                    <div id="sub-btn-gyeongsan" onclick="selectSubwayRegion('gyeongsan')" class="toss-card min-w-[100px] h-[100px] p-4 flex flex-col justify-between items-start cursor-pointer transition-all">
                        <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 text-lg"><i class="fa-solid fa-train-tram"></i></div>
                        <div><p class="text-sm font-bold text-main">ê²½ë¶ ê²½ì‚°ì‹œ</p><p class="text-xs text-sub status-text">ì„ íƒí•˜ê¸°</p></div>
                    </div>
                </div>
            </div>

            <!-- ë…¸ì„  ë° ì—­ ì •ë³´ -->
            <div class="px-1 fade-in-up delay-200">
                <div class="mb-3">
                    <h3 class="text-lg font-bold text-main mb-2">ë…¸ì„  ì„ íƒ</h3>
                    <!-- ë…¸ì„  ì„ íƒ ë°°ì§€ ì»¨í…Œì´ë„ˆ -->
                    <div id="subway-line-badges" class="flex flex-wrap gap-2">
                        <!-- JSë¡œ ë°°ì§€ ì£¼ì… -->
                    </div>
                </div>
                
                <!-- ì—­ ëª©ë¡ ì»¨í…Œì´ë„ˆ -->
                <div id="subway-station-list" class="space-y-3">
                    <!-- JSë¡œ ì¹´ë“œ ì£¼ì… -->
                </div>
            </div>
        </div>

        <div class="h-20"></div>
    </main>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (ì•Œì•½ ëª¨ì–‘) -->
    <nav class="fixed bottom-8 left-0 w-full z-[60] flex justify-center pointer-events-none">
        <div class="pointer-events-auto bg-white/90 backdrop-blur-xl border border-white/50 rounded-full p-1.5 shadow-2xl shadow-black/10 flex gap-1 scale-105">
            <button onclick="switchTab('bus')" id="nav-bus" class="nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300">
                <i class="fa-solid fa-bus"></i>
                <span>ë²„ìŠ¤</span>
            </button>
            <button onclick="switchTab('subway')" id="nav-subway" class="nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100">
                <i class="fa-solid fa-train-subway"></i>
                <span>ì§€í•˜ì² </span>
            </button>
        </div>
    </nav>

    <!-- ê²€ìƒ‰ ëª¨ë‹¬ (ìˆ˜ë™ ë“±ë¡ ìœ„ì£¼) -->
    <div id="search-modal" class="hidden fixed inset-0 z-[70] bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-5">
        <div class="bg-white w-full max-w-sm h-[85vh] sm:h-[80vh] sm:rounded-[32px] rounded-t-[32px] p-6 shadow-2xl scale-100 transition-all flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none">
                <div>
                    <h3 class="text-xl font-bold text-main">ì •ë¥˜ì¥ ì¶”ê°€</h3>
                    <p class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md inline-block mt-1" id="search-modal-region">ì•ˆë™ì‹œ</p>
                </div>
                <button onclick="closeSearchModal()" class="text-gray-400 hover:text-gray-600 bg-gray-100 w-8 h-8 rounded-full"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <!-- ì•ˆë™ì‹œëŠ” ìˆ˜ë™ ë“±ë¡ ê¶Œì¥ -->
            <div id="andong-manual-guide" class="mb-4 hidden">
                <div class="bg-blue-50 p-4 rounded-2xl mb-4">
                    <p class="text-sm font-bold text-main mb-1">ê³ ì • ì‹œê°„í‘œ ëª¨ë“œ</p>
                    <p class="text-xs text-gray-500">ì•ˆë™ì‹œëŠ” ì§€ì •ëœ 3ê°œ ì •ë¥˜ì¥ë§Œ í‘œì‹œë©ë‹ˆë‹¤.<br>ì¶”ê°€í•˜ë ¤ë©´ ì½”ë“œ ë‚´ ì‹œê°„í‘œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.</p>
                </div>
            </div>

            <!-- íƒ€ ì§€ì—­ ê²€ìƒ‰ì°½ -->
            <div id="api-search-box" class="flex gap-2 mb-2 flex-none">
                <input type="text" id="add-station-input" placeholder="ì •ë¥˜ì¥ëª… ê²€ìƒ‰" class="flex-1 bg-gray-100 rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeypress="if(event.keyCode==13) doSearchStation()">
                <button onclick="doSearchStation()" class="bg-blue-500 text-white rounded-2xl px-4 py-3 text-sm font-bold whitespace-nowrap">ê²€ìƒ‰</button>
            </div>
            
            <div id="add-station-results" class="flex-1 overflow-y-auto space-y-2 border-t border-gray-100 pt-2 min-h-0">
                <p class="text-center text-gray-400 mt-10 text-sm">
                    ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
                </p>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center p-5">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl scale-95 transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-main">ì„¤ì •</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-2">ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤ (êµ¬ë¯¸/ì¹ ê³¡ìš©)</label>
                <input type="text" id="api-key-input" placeholder="ì¸ì¦í‚¤ ë¶™ì—¬ë„£ê¸°" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <p class="text-[10px] text-blue-500 mt-1">* ì•ˆë™ì‹œëŠ” í‚¤ ì—†ì´ë„ ì‘ë™í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="flex gap-4 mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="key-type" value="decoding" checked class="w-4 h-4 text-blue-500">
                    <span class="text-sm text-gray-600">Decoding</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="key-type" value="encoding" class="w-4 h-4 text-blue-500">
                    <span class="text-sm text-gray-600">Encoding</span>
                </label>
            </div>

            <!-- CSV ë„ì›€ë§ (ì—…ë°ì´íŠ¸) -->
            <div class="mb-6 bg-gray-50 p-4 rounded-2xl">
                <h4 class="text-xs font-bold text-main mb-2">ğŸ“„ ì‹œê°„í‘œ íŒŒì¼ ì‘ì„±ë²• (ì•ˆë™ì‹œ)</h4>
                <div class="text-[10px] text-gray-500 space-y-1">
                    <p>1. ì—‘ì…€ ìˆœì„œ: <b>ID | ë²ˆí˜¸ | ë°©ë©´ | ìš”ì¼ | ì‹œê°„...</b></p>
                    <p class="font-mono bg-white p-1 rounded border border-gray-200">370000023, ê¸‰í–‰1, ë„ì²­í–‰, í‰ì¼, 08:00...</p>
                    <p>2. ìš”ì¼(Dì—´)ì— <b>í‰ì¼/í† ìš”ì¼/ì¼ìš”ì¼/ë§¤ì¼</b> ì…ë ¥</p>
                    <p>3. <b>CSV(ì‰¼í‘œë¡œ ë¶„ë¦¬)</b> í˜•ì‹ìœ¼ë¡œ ì €ì¥</p>
                </div>
            </div>

            <!-- í”„ë¡ì‹œ ì„ íƒ ì¶”ê°€ -->
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-2">í”„ë¡ì‹œ ì„œë²„</label>
                <select id="proxy-select" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                    <option value="corsproxy">CorsProxy.io (ê¸°ë³¸)</option>
                    <option value="codetabs">CodeTabs</option>
                    <option value="direct">ì§ì ‘ ì—°ê²°</option>
                </select>
            </div>

            <div class="space-y-2 mb-4">
                <button onclick="initCityCodes()" class="w-full bg-orange-50 text-orange-600 font-bold py-3 rounded-2xl hover:bg-orange-100 transition-colors text-sm">
                    <i class="fa-solid fa-sync"></i> ë„ì‹œ ì½”ë“œ APIë¡œ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜)
                </button>
                <button onclick="testConnection()" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-2xl hover:bg-gray-200 transition-colors text-sm">
                    <i class="fa-solid fa-stethoscope"></i> ì•± ë‚´ë¶€ ì—°ê²° í…ŒìŠ¤íŠ¸
                </button>
            </div>

            <button onclick="saveSettings()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-500/20 transition-all active:scale-95">ì €ì¥í•˜ê¸°</button>
            
            <div id="test-result" class="mt-4 p-3 bg-gray-50 rounded-xl text-xs text-gray-500 hidden break-all"></div>

            <div class="mt-4 text-center border-t border-gray-100 pt-4">
                <button onclick="resetData()" class="text-[10px] text-red-400 underline">ë°ì´í„° ê°•ì œ ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <script>
        // [ì‚¬ìš©ì ì„¤ì •] êµ¬ë¯¸/ì¹ ê³¡ ë²„ìŠ¤ API ì¸ì¦í‚¤ (ê³µê³µë°ì´í„°í¬í„¸)
        // ì½”ë“œë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ì—¬ í‚¤ë¥¼ ë„£ìœ¼ë ¤ë©´ ì•„ë˜ ë”°ì˜´í‘œ ì•ˆì— í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const MANUAL_API_KEY = ""; 

        // [ì¤‘ìš”] ì•ˆë™ì‹œ ê³ ì • ì •ë¥˜ì¥ (ê¸°ë³¸ê°’)
        const ANDONG_DEFAULT_STATIONS = [
            { name: "êµ­ë¦½ì•ˆë™ëŒ€í•™êµ", nodeId: "370000023", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" },
            { name: "CGV ê±´ë„ˆ", nodeId: "370000998", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" }, 
            { name: "ì•ˆë™í„°ë¯¸ë„(ì•ˆë™ì—­)", nodeId: "354000416", arsNo: "-", sub: "ì£¼ìš” ì •ë¥˜ì¥" } 
        ];

        // ì´ˆê¸° ë°ì´í„°
        const defaultStationConfig = { 
            andong: ANDONG_DEFAULT_STATIONS, 
            gumi: [], 
            chilgok: [] 
        };

        // ë„ì‹œ ì½”ë“œ
        let CITY_CODES = { 'andong': '37010', 'gumi': '37030', 'chilgok': '37380' };
        const CITY_NAMES = { 'andong': 'ì•ˆë™ì‹œ', 'gumi': 'êµ¬ë¯¸ì‹œ', 'chilgok': 'ì¹ ê³¡êµ°' };
        
        let currentRegion = 'andong';
        let currentSubwayRegion = 'gumi'; // ì´ˆê¸°ê°’ êµ¬ë¯¸
        let currentSubwayLine = 'daegyeong'; // ì´ˆê¸°ê°’ ëŒ€ê²½ì„ 

        const SUBWAY_REGION_NAMES = { 'gumi': 'ê²½ë¶ êµ¬ë¯¸ì‹œ', 'chilgok': 'ê²½ë¶ ì¹ ê³¡êµ°', 'daegu': 'ëŒ€êµ¬ê´‘ì—­ì‹œ', 'gyeongsan': 'ê²½ë¶ ê²½ì‚°ì‹œ' };

        // [NEW] ì§€í•˜ì²  ë°ì´í„° (ëŒ€ê²½ì„ ) + ë…¸ì„  ë©”íƒ€ë°ì´í„°
        const SUBWAY_LINES_META = {
            '1': { name: '1í˜¸ì„ ', color: '#D93F5C' },
            '2': { name: '2í˜¸ì„ ', color: '#00AA80' },
            '3': { name: '3í˜¸ì„ ', color: '#FFB100' },
            'daegyeong': { name: 'ëŒ€ê²½ì„ ', color: '#0054A6' }
        };

        const SUBWAY_DATA = {
            'daegyeong': {
                name: 'ëŒ€ê²½ì„ ',
                color: 'badge-daegyeong',
                stations: {
                    'gumi': ['êµ¬ë¯¸ì—­', 'ì‚¬ê³¡'], 
                    'chilgok': ['ë¶ì‚¼', 'ì™œê´€ì—­'], 
                    'daegu': ['ì„œëŒ€êµ¬ì—­', 'ì›ëŒ€(ë‹¬ì„±ê³µì›)', 'ëŒ€êµ¬ì—­', 'ë™ëŒ€êµ¬ì—­'], 
                    'gyeongsan': ['ê²½ì‚°ì—­']
                }
            }
            // 1, 2, 3í˜¸ì„  ë°ì´í„°ëŠ” ì•„ì§ ì—†ìŒ (ì¤€ë¹„ì¤‘ ì²˜ë¦¬)
        };

        // [ìˆ˜ì •] ì½”ë“œ ë‚´ ì…ë ¥ëœ MANUAL_API_KEY ìš°ì„  ì‚¬ìš©
        let apiKey = MANUAL_API_KEY || localStorage.getItem('toss_bus_api_key') || '';
        let keyType = localStorage.getItem('toss_bus_key_type') || 'decoding'; 
        let selectedProxy = localStorage.getItem('toss_bus_proxy') || 'corsproxy';
        
        let stationConfig = JSON.parse(localStorage.getItem('my_station_config_v40')) || JSON.parse(JSON.stringify(defaultStationConfig));
        if(!stationConfig.andong || stationConfig.andong.length === 0) {
            stationConfig.andong = ANDONG_DEFAULT_STATIONS;
        }
        stationConfig.andong = ANDONG_DEFAULT_STATIONS;
        localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig));

        let routeDestCache = JSON.parse(localStorage.getItem('route_dest_cache')) || {};

        const TIMETABLE_URL = "./timetable.csv"; 
        
        let ANDONG_TIMETABLE = null; // ì´ˆê¸°ê°’ null (ë¡œë”© ì „)

        document.addEventListener('DOMContentLoaded', () => {
            if(apiKey) {
                document.getElementById('api-key-input').value = apiKey;
                const radios = document.getElementsByName('key-type');
                for(const r of radios) { if(r.value === keyType) r.checked = true; }
            }
            const proxySelect = document.getElementById('proxy-select');
            if(proxySelect) proxySelect.value = selectedProxy;

            const savedCityCodes = localStorage.getItem('my_city_codes');
            if (savedCityCodes) {
                CITY_CODES = JSON.parse(savedCityCodes);
                updateCityStatus();
            }
            
            // ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸° (ì™¸ë¶€ íŒŒì¼ ìˆìœ¼ë©´)
            loadTimetable();
            
            selectRegion('andong');
        });

        // --- íƒ­ ì „í™˜ ë¡œì§ ---
        function switchTab(mode) {
            const btnBus = document.getElementById('nav-bus');
            const btnSubway = document.getElementById('nav-subway');
            const viewBus = document.getElementById('view-bus');
            const viewSubway = document.getElementById('view-subway');

            if (mode === 'bus') {
                btnBus.className = 'nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300';
                btnSubway.className = 'nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100';
                
                viewBus.classList.remove('hidden');
                viewSubway.classList.add('hidden');
            } else {
                btnSubway.className = 'nav-pill-active rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300';
                btnBus.className = 'nav-pill-inactive rounded-full px-6 py-2.5 text-sm font-bold flex items-center gap-2 transition-all duration-300 hover:bg-gray-100';
                
                viewSubway.classList.remove('hidden');
                viewBus.classList.add('hidden');
                
                // ì§€í•˜ì²  UI ì´ˆê¸°í™”
                selectSubwayRegion(currentSubwayRegion);
            }
        }

        // --- ì§€í•˜ì²  ë¡œì§ ---
        function selectSubwayRegion(region) {
            currentSubwayRegion = region;
            ['gumi', 'chilgok', 'daegu', 'gyeongsan'].forEach(id => {
                const el = document.getElementById('sub-btn-' + id);
                const txt = el.querySelector('.status-text');
                if (id === region) { 
                    el.classList.add('region-card-selected'); 
                    txt.innerText = 'ì„ íƒë¨'; 
                } else { 
                    el.classList.remove('region-card-selected'); 
                    txt.innerText = 'ì„ íƒí•˜ê¸°'; 
                }
            });
            
            // ì§€ì—­ ë³€ê²½ ì‹œ ê¸°ë³¸ ë…¸ì„  ì„ íƒ (ëŒ€ê²½ì„ )
            currentSubwayLine = 'daegyeong';
            renderSubwayLineBadges(region);
            renderSubwayStations();
        }

        function renderSubwayLineBadges(region) {
            const container = document.getElementById('subway-line-badges');
            container.innerHTML = '';
            
            // ì§€ì—­ë³„ í‘œì‹œí•  ë…¸ì„  ì •ì˜
            let linesToShow = [];
            if (region === 'daegu') linesToShow = ['1', '2', '3', 'daegyeong'];
            else if (region === 'gyeongsan') linesToShow = ['1', '2', 'daegyeong'];
            else linesToShow = ['daegyeong']; // êµ¬ë¯¸, ì¹ ê³¡

            linesToShow.forEach(lineKey => {
                const meta = SUBWAY_LINES_META[lineKey];
                const isActive = (lineKey === currentSubwayLine);
                
                const btn = document.createElement('button');
                btn.className = `line-badge px-3 py-1.5 rounded-full text-xs font-bold transition-all duration-200 ${isActive ? 'line-badge-active text-white' : 'line-badge-inactive'}`;
                
                if (isActive) {
                    btn.style.backgroundColor = meta.color;
                    btn.style.borderColor = meta.color;
                }
                
                btn.innerText = meta.name;
                btn.onclick = () => selectSubwayLine(lineKey);
                
                container.appendChild(btn);
            });
        }

        function selectSubwayLine(lineKey) {
            currentSubwayLine = lineKey;
            renderSubwayLineBadges(currentSubwayRegion); // ë°°ì§€ ìŠ¤íƒ€ì¼ ê°±ì‹ 
            renderSubwayStations(); // ëª©ë¡ ê°±ì‹ 
        }

        function renderSubwayStations() {
            const region = currentSubwayRegion;
            const lineKey = currentSubwayLine;
            const listContainer = document.getElementById('subway-station-list');
            listContainer.innerHTML = '';

            // [NEW] ì¤€ë¹„ì¤‘ í™”ë©´ ì²˜ë¦¬ (ëŒ€ê²½ì„  ì™¸ ë…¸ì„ )
            if (lineKey !== 'daegyeong') {
                const meta = SUBWAY_LINES_META[lineKey];
                listContainer.innerHTML = `
                    <div class="p-8 bg-white/50 rounded-3xl border border-white/60 text-center mt-4">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 text-2xl">
                            <i class="fa-solid fa-person-digging"></i>
                        </div>
                        <p class="text-main font-bold text-sm mb-1" style="color:${meta.color}">${meta.name} ì¤€ë¹„ì¤‘</p>
                        <p class="text-sub text-xs">í•´ë‹¹ ë…¸ì„ ì˜ ì •ë³´ëŠ” ì¶”í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                    </div>`;
                return;
            }

            if(!SUBWAY_DATA[lineKey]) {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs">ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            const lineData = SUBWAY_DATA[lineKey];
            const stations = lineData.stations[region] || [];

            if(stations.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-400 text-xs">ë“±ë¡ëœ ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            // [NEW] í˜„ì¬ ì‹œê°„ ê³„ì‚°ìš©
            const now = new Date();
            const nowTotalSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const day = now.getDay(); 
            let dayKey = 'weekday';
            if(day === 0) dayKey = 'holiday'; 
            else if(day === 6) dayKey = 'saturday'; 

            stations.forEach(stationName => {
                let cardContent = '';
                
                let transferHtml = '';
                if (stationName === 'ëŒ€êµ¬ì—­' || stationName === 'ë™ëŒ€êµ¬ì—­') {
                    transferHtml = `<span class="ml-1.5 w-4 h-4 rounded-full bg-[#D93F5C] text-white text-[9px] flex items-center justify-center font-bold shadow-sm" title="1í˜¸ì„  í™˜ìŠ¹">1</span>`;
                } else if (stationName === 'ì›ëŒ€(ë‹¬ì„±ê³µì›)') {
                    transferHtml = `<span class="ml-1.5 w-4 h-4 rounded-full bg-[#FFB100] text-white text-[9px] flex items-center justify-center font-bold shadow-sm" title="3í˜¸ì„  í™˜ìŠ¹">3</span>`;
                }

                // [NEW] ì‹œê°„í‘œ ì¡°íšŒ ë° ê³„ì‚° í•¨ìˆ˜ (ì´ˆ ë‹¨ìœ„)
                const getNextTime = (destFilter) => {
                    if (!ANDONG_TIMETABLE || ANDONG_TIMETABLE === "ERROR") return "ì‹œê°„í‘œ ì—†ìŒ";
                    
                    // ì—­ ì´ë¦„ìœ¼ë¡œ ì‹œê°„í‘œ ì°¾ê¸°
                    const stationData = ANDONG_TIMETABLE[stationName];
                    if (!stationData) return "ì •ë³´ ì—†ìŒ";

                    let targetRoutes = [];
                    // ë°©ë©´ í•„í„°ë§
                    stationData.forEach(r => {
                        if (destFilter.includes(r.dest)) targetRoutes.push(r);
                    });

                    if (targetRoutes.length === 0) return "ìš´í–‰ ì¢…ë£Œ";

                    let minDiff = 9999;
                    let nextTimeStr = null;

                    targetRoutes.forEach(route => {
                        let timeList = [];
                        if(Array.isArray(route.times)) timeList = route.times;
                        else if(typeof route.times === 'object') timeList = route.times[dayKey] || route.times['weekday'] || [];

                        timeList.forEach(time => {
                            const [h, m, s = 0] = time.split(':').map(Number);
                            const trainTotalSec = h * 3600 + m * 60 + s;
                            
                            if (trainTotalSec > nowTotalSec) {
                                const diffSec = trainTotalSec - nowTotalSec;
                                if (diffSec < minDiff * 60) {
                                    minDiff = Math.floor(diffSec / 60);
                                    nextTimeStr = time;
                                }
                            }
                        });
                    });
                    
                    if (!nextTimeStr) {
                         return "ìš´í–‰ ì¢…ë£Œ"; 
                    }

                    if (minDiff < 60) return `<span class="text-red-500 font-bold">${minDiff}ë¶„ í›„</span> (${nextTimeStr})`;
                    else return `${nextTimeStr} ì¶œë°œ`;
                };

                if (stationName === 'ë¶ì‚¼') {
                    cardContent = `
                    <div class="toss-card p-5 !bg-[#E6F0FA]/90 animate-[fadeInUp_0.4s_ease-out] relative border border-blue-100">
                        <div class="flex items-center gap-2.5 mb-4">
                            <span class="${lineData.color} text-[10px] px-2 py-1 rounded-full font-bold shadow-sm">${lineData.name}</span>
                            <h4 class="text-base font-bold text-main flex items-center">${stationName}${transferHtml}</h4>
                            <span class="bg-amber-100 text-amber-600 text-[10px] font-bold px-1.5 py-0.5 rounded ml-auto">ë¯¸ê°œí†µ</span>
                        </div>
                        <div class="p-4 bg-white/60 rounded-xl text-center border border-blue-50">
                            <div class="mb-2 text-2xl">ğŸš§</div>
                            <p class="text-sm font-bold text-main mb-1">í˜„ì¬ ì‹œìš´ì „ ì¤‘ì…ë‹ˆë‹¤</p>
                            <p class="text-xs text-blue-500 font-bold">2026ë…„ 2ì›” ê°œí†µ ì˜ˆì •</p>
                        </div>
                    </div>`;
                } else {
                    let upHtml = '';
                    if (stationName !== 'êµ¬ë¯¸ì—­') {
                        const timeDisplay = getNextTime(['êµ¬ë¯¸']); 
                        upHtml = `
                        <div class="glass-item p-3 flex items-center justify-between !bg-white/60 mb-2"> <!-- [ìˆ˜ì •] mb-1 -> mb-2 for spacing -->
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">ìƒí–‰</div>
                                <div>
                                    <span class="text-sm font-bold text-main">êµ¬ë¯¸ ë°©ë©´</span>
                                </div>
                            </div>
                            <span class="text-xs text-main font-medium">${timeDisplay}</span>
                        </div>`;
                    }

                    let downHtml = '';
                    if (stationName !== 'ê²½ì‚°ì—­') {
                        if (stationName !== 'ë™ëŒ€êµ¬ì—­') {
                            const timeDisplay = getNextTime(['ë™ëŒ€êµ¬']);
                            downHtml += `
                            <div class="glass-item p-3 flex items-center justify-between !bg-white/60 mb-2"> <!-- [ìˆ˜ì •] mb-1 -> mb-2 for spacing -->
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">í•˜í–‰</div>
                                    <div>
                                        <span class="text-sm font-bold text-main">ë™ëŒ€êµ¬ ë°©ë©´</span>
                                    </div>
                                </div>
                                <span class="text-xs text-main font-medium">${timeDisplay}</span>
                            </div>`;
                        }
                        
                        const timeDisplay = getNextTime(['ê²½ì‚°']);
                        downHtml += `
                        <div class="glass-item p-3 flex items-center justify-between !bg-white/60">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs font-bold">í•˜í–‰</div>
                                <div>
                                    <span class="text-sm font-bold text-main">ê²½ì‚° ë°©ë©´</span>
                                </div>
                            </div>
                            <span class="text-xs text-main font-medium">${timeDisplay}</span>
                        </div>`;
                    }

                    cardContent = `
                    <div class="toss-card p-5 !bg-[#E6F0FA]/90 animate-[fadeInUp_0.4s_ease-out] relative border border-blue-100">
                        <div class="flex items-center gap-2.5 mb-4">
                            <span class="${lineData.color} text-[10px] px-2 py-1 rounded-full font-bold shadow-sm">${lineData.name}</span>
                            <h4 class="text-base font-bold text-main flex items-center">${stationName}${transferHtml}</h4>
                        </div>
                        
                        <div class="space-y-0"> <!-- Removed space-y-2 since we handle spacing inside items -->
                            ${upHtml}
                            ${downHtml}
                        </div>
                    </div>`;
                }
                
                listContainer.insertAdjacentHTML('beforeend', cardContent);
            });
        }

        // [ìˆ˜ì •] ì‹œê°„í‘œ íŒŒì¼(CSV) ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
        async function loadTimetable() {
            if (!TIMETABLE_URL) return; 

            try {
                const response = await fetch(TIMETABLE_URL);
                if (!response.ok) throw new Error("File not found or Network Error");
                
                const text = await response.text();
                parseAndongCSV(text); // CSV íŒŒì‹±
                console.log("ì‹œê°„í‘œ ë¡œë“œ ì„±ê³µ");
            } catch (e) {
                console.warn("ì‹œê°„í‘œ ë¡œë“œ ì‹¤íŒ¨:", e); // error ëŒ€ì‹  warn ì‚¬ìš©
                ANDONG_TIMETABLE = "ERROR"; // ì—ëŸ¬ ìƒíƒœ í”Œë˜ê·¸ ì„¤ì •
            }
            
            // ë¡œë“œ ì™„ë£Œ ë˜ëŠ” ì‹¤íŒ¨ í›„ ì•ˆë™ í™”ë©´ì´ë©´ ë¦¬ë Œë”ë§
            if(currentRegion === 'andong') {
                renderList();
            }
        }

        // CSV í…ìŠ¤íŠ¸ë¥¼ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ë³€í™˜ (ID,ë²ˆí˜¸,ë°©ë©´,ì‹œê°„ ìˆœì„œ ê°€ì •)
        function parseAndongCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            const table = {};
            
            lines.forEach((line, index) => {
                if (index === 0 && isNaN(line.trim().charAt(0))) return;

                const cols = line.split(',').map(c => c.trim());
                if (cols.length < 5) return; 

                const stationId = cols[0];
                const routeNo = cols[1];
                const dest = cols[2];
                let dayType = cols[3]; 
                
                if(dayType === 'í‰ì¼') dayType = 'weekday';
                else if(dayType === 'í† ìš”ì¼') dayType = 'saturday';
                else if(dayType === 'ì¼ìš”ì¼' || dayType === 'ê³µíœ´ì¼') dayType = 'holiday';
                else dayType = 'all'; 

                const times = [];
                for(let i=4; i<cols.length; i++) {
                    if(cols[i]) times.push(cols[i]);
                }

                if (!table[stationId]) table[stationId] = [];
                
                let existing = table[stationId].find(r => r.routeNo === routeNo && r.dest === dest);
                
                if (existing) {
                    if(dayType === 'all') {
                         existing.times.weekday = [...(existing.times.weekday || []), ...times];
                         existing.times.saturday = [...(existing.times.saturday || []), ...times];
                         existing.times.holiday = [...(existing.times.holiday || []), ...times];
                    } else {
                         existing.times[dayType] = [...(existing.times[dayType] || []), ...times];
                    }
                } else {
                    let timesObj = {};
                    if(dayType === 'all') {
                        timesObj = { weekday: times, saturday: times, holiday: times };
                    } else {
                        timesObj[dayType] = times;
                    }
                    
                    table[stationId].push({
                        routeNo: routeNo,
                        dest: dest,
                        times: timesObj
                    });
                }
            });
            
            // [ìˆ˜ì •] ì‹œê°„ìˆœ ì •ë ¬ (ì´ˆ ë‹¨ìœ„ê¹Œì§€ ê³ ë ¤í•˜ì—¬ ì •ë ¬)
            for (let id in table) {
                table[id].forEach(route => {
                    const timeSort = (a, b) => {
                        const [h1, m1, s1 = 0] = a.split(':').map(Number);
                        const [h2, m2, s2 = 0] = b.split(':').map(Number);
                        return (h1 * 3600 + m1 * 60 + s1) - (h2 * 3600 + m2 * 60 + s2);
                    };
                    if(route.times.weekday) route.times.weekday.sort(timeSort);
                    if(route.times.saturday) route.times.saturday.sort(timeSort);
                    if(route.times.holiday) route.times.holiday.sort(timeSort);
                });
            }

            ANDONG_TIMETABLE = table;
        }

        function getEncodedKey() {
            if (!apiKey) return '';
            return keyType === 'encoding' ? apiKey : encodeURIComponent(apiKey);
        }

        // [ìˆ˜ì •] ì•ˆë™ì‹œ ì •ì  ì‹œê°„í‘œ (ì´ˆ ë‹¨ìœ„ ê³„ì‚° ì ìš©)
        function renderStaticCard(index, station) {
            const container = document.getElementById('dynamic-list-container');
            
            if (!ANDONG_TIMETABLE || ANDONG_TIMETABLE === "ERROR") return; 

            const timetable = ANDONG_TIMETABLE[station.nodeId]; 
            
            let iconClass = "fa-solid fa-map-pin";
            let iconBgClass = "bg-gray-100";
            let iconTextClass = "text-gray-500";

            if (station.name.includes("ëŒ€í•™êµ") || station.name.includes("ì•ˆë™ëŒ€")) {
                iconClass = "fa-solid fa-school";
                iconBgClass = "bg-green-100";
                iconTextClass = "text-green-600";
            } else if (station.name.includes("CGV")) {
                iconClass = "fa-solid fa-film";
                iconBgClass = "bg-red-100";
                iconTextClass = "text-red-500";
            } else if (station.name.includes("í„°ë¯¸ë„") || station.name.includes("ì—­")) {
                iconClass = "fa-solid fa-bus";
                iconBgClass = "bg-blue-100";
                iconTextClass = "text-blue-600";
            }
            
            // [ìˆ˜ì •] í˜„ì¬ ì‹œê°„ì„ ì´ˆ ë‹¨ìœ„ê¹Œì§€ ê³„ì‚°
            const now = new Date();
            const nowTotalSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const day = now.getDay(); 
            
            let dayKey = 'weekday';
            let dayLabel = "í‰ì¼";
            if(day === 0) { dayKey = 'holiday'; dayLabel = "ì¼/ê³µíœ´ì¼"; }
            else if(day === 6) { dayKey = 'saturday'; dayLabel = "í† ìš”ì¼"; }

            let contentHtml = '';
            let allArrivals = [];

            if (!timetable || Object.keys(timetable).length === 0) {
                 // No data
            } else {
                if(Array.isArray(timetable)) {
                    timetable.forEach(route => {
                        let timeList = [];
                        if(Array.isArray(route.times)) timeList = route.times; 
                        else if(typeof route.times === 'object') timeList = route.times[dayKey] || route.times['weekday'] || [];

                        if(!timeList || timeList.length === 0) return;

                        let nextTimeStr = null;
                        let minDiff = 9999; // ë¶„ ë‹¨ìœ„ ì°¨ì´ ì €ì¥ (í‘œì‹œìš©)
                        let isNextDay = false;

                        for(let time of timeList) {
                            const [h, m, s = 0] = time.split(':').map(Number);
                            const busTotalSec = h * 3600 + m * 60 + s;
                            
                            if (busTotalSec > nowTotalSec) {
                                const diffSec = busTotalSec - nowTotalSec;
                                if (diffSec < minDiff * 60) { // ë” ê°€ê¹Œìš´ ì‹œê°„ ë°œê²¬
                                    minDiff = Math.floor(diffSec / 60);
                                    nextTimeStr = time;
                                }
                            }
                        }

                        if (!nextTimeStr && timeList.length > 0) {
                             nextTimeStr = timeList[0];
                             const [h, m, s = 0] = nextTimeStr.split(':').map(Number);
                             const busTotalSec = h * 3600 + m * 60 + s;
                             // í•˜ë£¨ëŠ” 86400ì´ˆ
                             const diffSec = (86400 - nowTotalSec) + busTotalSec;
                             minDiff = Math.floor(diffSec / 60);
                             isNextDay = true;
                        }

                        if (nextTimeStr) {
                             const isExpress = route.routeNo.includes("ê¸‰í–‰");
                             allArrivals.push({
                                 routeNo: route.routeNo,
                                 dest: route.dest,
                                 minDiff: minDiff,
                                 timeStr: nextTimeStr,
                                 isNextDay: isNextDay,
                                 isExpress: isExpress
                             });
                        }
                    });
                }
            }
            
            if(allArrivals.length === 0) {
                 contentHtml = `
                    <div class="p-4 bg-gray-50/50 rounded-xl text-center border border-gray-100">
                        <p class="text-xs text-gray-500 font-bold">ì˜¤ëŠ˜ì€ ìš´í–‰í•˜ëŠ” ë²„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-[10px] text-gray-400">(${dayLabel} ê¸°ì¤€)</p>
                    </div>`;
            } else {
                const grouped = {};
                allArrivals.forEach(item => {
                    if (!grouped[item.routeNo]) grouped[item.routeNo] = [];
                    grouped[item.routeNo].push(item);
                });

                for (let r in grouped) {
                    grouped[r].sort((a, b) => a.minDiff - b.minDiff);
                }

                const sortedRoutes = Object.keys(grouped).sort((a, b) => {
                    return grouped[a][0].minDiff - grouped[b][0].minDiff;
                });

                sortedRoutes.forEach(r => {
                    const groupItems = grouped[r];
                    const first = groupItems[0];
                    const badgeText = first.isExpress ? "ê¸‰í–‰" : "ì¼ë°˜";
                    const badgeColor = first.isExpress ? "bg-red-500" : "bg-blue-500";
                    
                    const firstTimeDisplay = formatMinDiff(first.minDiff, first.timeStr, first.isNextDay);
                    const firstColor = first.minDiff < 10 && !first.isNextDay ? "text-red-500 font-bold" : "text-main";

                    contentHtml += `
                    <div class="glass-item p-3 mb-2 flex flex-col gap-2 active:scale-[0.98] transition-transform">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="${badgeColor} text-white text-[10px] font-bold px-1.5 py-0.5 rounded min-w-[36px] text-center">${badgeText}</span>
                                <div>
                                    <span class="text-sm font-bold text-main">${r}</span>
                                    <span class="text-[10px] text-sub ml-1">${first.dest} ë°©ë©´</span>
                                </div>
                            </div>
                            <span class="text-sm ${firstColor}">${firstTimeDisplay}</span>
                        </div>
                    `;

                    if (groupItems.length > 1) {
                        contentHtml += `<div class="pl-2 border-t border-gray-100/50 pt-2 space-y-1">`;
                        for(let i=1; i<groupItems.length; i++) {
                            const sub = groupItems[i];
                            const subTimeDisplay = formatMinDiff(sub.minDiff, sub.timeStr, sub.isNextDay);
                            const subColor = sub.minDiff < 10 && !sub.isNextDay ? "text-red-500 font-bold" : "text-gray-600";
                            
                            contentHtml += `
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-sub pl-9">${sub.dest} ë°©ë©´</span>
                                <span class="text-xs ${subColor}">${subTimeDisplay}</span>
                            </div>`;
                        }
                        contentHtml += `</div>`;
                    }
                    contentHtml += `</div>`;
                });
            }

            const kakaoSearchQuery = `${CITY_NAMES[currentRegion]} ${station.name}`;
            const kakaoMapUrl = `https://map.kakao.com/link/search/${encodeURIComponent(kakaoSearchQuery)}`;

            const cardHtml = `
                <div class="toss-card p-5 mb-4 !bg-white/70 animate-[fadeInUp_0.4s_ease-out] relative group">
                    <div class="absolute top-4 right-4 flex gap-1">
                        <span class="text-[10px] text-blue-500 bg-blue-50 px-2 py-1 rounded-md font-bold">ğŸ“… ${dayLabel}</span>
                        <a href="${kakaoMapUrl}" target="_blank" class="text-xs btn-kakao px-2 py-1 rounded-md font-bold hover:opacity-80 transition-opacity flex items-center gap-1 shadow-sm">
                            <i class="fa-solid fa-map-location-dot"></i> ì¹´ì¹´ì˜¤ë§µ
                        </a>
                        <button onclick="removeStation('${currentRegion}', ${index})" class="delete-btn text-gray-300 hover:text-red-500 p-1 hidden">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2.5">
                            <div class="w-10 h-10 rounded-[16px] ${iconBgClass} flex items-center justify-center ${iconTextClass} text-lg shadow-sm">
                                <i class="${iconClass}"></i>
                            </div>
                            <div>
                                <h4 class="text-base font-bold text-main">${station.name}</h4>
                                <p class="text-xs text-sub text-[10px]">ID: ${station.nodeId} (ì‹œê°„í‘œ ëª¨ë“œ)</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1">${contentHtml}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHtml);
        }

        function fetchWithProxy(url) {
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
            return fetch(proxyUrl);
        }
        
        function getProxyUrl(url) {
             if (selectedProxy === 'direct') return url;
             if (selectedProxy === 'codetabs') return 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url);
             return 'https://corsproxy.io/?' + encodeURIComponent(url);
        }

        function normalizeBusData(bus) {
            if (!bus) return null;
            return {
                ...bus,
                routeno: (bus.routeno || bus.routeNo || '?').toString(),
                routeid: bus.routeid || bus.routeId || '',
                routetp: bus.routetp || bus.routeTp || '',
                endnodenm: bus.endnodenm || bus.endNodeNm || '',
                nodenm: bus.nodenm || bus.nodeNm || '',
                arrtime: bus.arrtime || bus.arrTime,
                arrprevstationcnt: bus.arrprevstationcnt || bus.arrPrevStationCnt,
                citycode: bus.citycode || bus.cityCode || null 
            };
        }

        function parseHybrid(text) {
            try { return { type: 'json', data: JSON.parse(text) }; } catch(e) { }
            if (text.includes('<OpenAPI_ServiceResponse>')) {
                if (text.includes('SERVICE_KEY_IS_NOT_REGISTERED_ERROR')) return { type: 'error', msg: 'SERVICE_KEY_IS_NOT_REGISTERED_ERROR' };
                if (text.includes('SERVICE_KEY_ERROR')) return { type: 'error', msg: 'SERVICE_KEY_ERROR' };
                return { type: 'error', msg: 'SERVER_ERROR (XML)' };
            }
            return { type: 'error', msg: 'UNKNOWN_FORMAT' };
        }

        function updateCityStatus() {
            document.getElementById('status-andong').innerText = "ì‹œê°„í‘œ ëª¨ë“œ"; 
            document.getElementById('status-gumi').innerText = CITY_CODES.gumi ? "ì¤€ë¹„ì™„ë£Œ" : "ë¯¸í™•ì¸";
            document.getElementById('status-chilgok').innerText = CITY_CODES.chilgok ? "ì¤€ë¹„ì™„ë£Œ" : "ë¯¸í™•ì¸";
            document.getElementById('city-code-status').innerText = "ë„ì‹œ ì½”ë“œ ì—°ë™ ì™„ë£Œ";
        }

        // --- APIs ---
        async function initCityCodes() {
            if (!apiKey) { alert("API í‚¤ë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”."); return; }
            const resultBox = document.getElementById('test-result');
            resultBox.classList.remove('hidden');
            resultBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ë„ì‹œ ì½”ë“œ ìŠ¤ìº” ì¤‘...';
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getCtyCodeList?serviceKey=${serviceKey}&_type=json`;

            try {
                const response = await fetch(getProxyUrl(targetUrl));
                const text = await response.text();
                const result = parseHybrid(text);
                if (result.type === 'error') { resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ${result.msg}</span>`; return; }
                const items = result.data.response.body.items.item;
                const list = Array.isArray(items) ? items : [items];
                let found = 0;
                list.forEach(city => {
                    if (city.cityname.includes('ì•ˆë™')) { CITY_CODES.andong = city.citycode; found++; }
                    if (city.cityname.includes('êµ¬ë¯¸')) { CITY_CODES.gumi = city.citycode; found++; }
                    if (city.cityname.includes('ì¹ ê³¡')) { CITY_CODES.chilgok = city.citycode; found++; }
                });
                localStorage.setItem('my_city_codes', JSON.stringify(CITY_CODES));
                updateCityStatus();
                resultBox.innerHTML = `<span class="text-green-600 font-bold">âœ… ë„ì‹œ ì½”ë“œ ${found}ê°œ ê°±ì‹  ì™„ë£Œ!</span>`;
            } catch (e) { resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</span>`; }
        }

        async function fetchBusArrival(cityCode, nodeId) {
            if (!apiKey || !nodeId) return null;
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/ArvlInfoInqireService/getSttnAcctoArvlPrearngeInfoList?serviceKey=${serviceKey}&cityCode=${cityCode}&nodeId=${nodeId}&numOfRows=100&pageNo=1&_type=json`;
            try {
                const response = await fetch(getProxyUrl(targetUrl));
                if (!response.ok) return "NETWORK_ERROR";
                const text = await response.text();
                const result = parseHybrid(text);
                if (result.type === 'error') return result.msg;
                const data = result.data;
                if (data.response?.header?.resultCode !== '00') return data.response?.header?.resultMsg || "API_ERROR";
                const items = data.response.body.items?.item;
                if (!items) return [];
                const list = Array.isArray(items) ? items : [items];
                return list.map(normalizeBusData);
            } catch (error) { return "NETWORK_ERROR"; }
        }
        
        async function fetchRouteInfo(cityCode, routeId) {
            if (!apiKey || !routeId) return null;
            if (routeDestCache[routeId]) return routeDestCache[routeId]; 
            const serviceKey = getEncodedKey();
            const targetUrl = `http://apis.data.go.kr/1613000/BusRouteInfoInqireService/getRouteInfoIem?serviceKey=${serviceKey}&cityCode=${cityCode}&routeId=${routeId}&_type=json`;
            try {
                const response = await fetch(getProxyUrl(targetUrl));
                const text = await response.text();
                const result = parseHybrid(text);
                if (result.type === 'json' && result.data.response?.header?.resultCode === '00') {
                    const item = result.data.response.body.items.item;
                    if (item && item.endnodenm) {
                        routeDestCache[routeId] = item.endnodenm;
                        localStorage.setItem('route_dest_cache', JSON.stringify(routeDestCache));
                        return item.endnodenm;
                    }
                }
            } catch (e) { }
            return null;
        }

        async function searchStationAPI(keyword) {
            const serviceKey = getEncodedKey();
            const targetCityCode = CITY_CODES[currentRegion];
            let targetUrl = `http://apis.data.go.kr/1613000/BusSttnInfoInqireService/getSttnNoList?serviceKey=${serviceKey}&cityCode=${targetCityCode}&numOfRows=500&_type=json`;
            targetUrl += `&nodeNm=${encodeURIComponent(keyword)}`;
            try {
                const response = await fetch(getProxyUrl(targetUrl));
                const text = await response.text();
                const result = parseHybrid(text);
                if (result.type === 'error') return { error: result.msg };
                const data = result.data;
                if (data.response?.header?.resultCode !== '00') return { error: data.response.header.resultMsg };
                const items = data.response.body.items?.item;
                if (!items) return [];
                const list = Array.isArray(items) ? items : [items];
                return list.map(normalizeBusData);
            } catch (e) { return { error: "NETWORK_ERROR" }; }
        }

        // --- Main Render Logic ---
        function renderList() {
            const container = document.getElementById('dynamic-list-container');
            const empty = document.getElementById('empty-state');
            container.innerHTML = '';
            empty.classList.add('hidden');
            
            // ì•ˆë™ì‹œëŠ” í‚¤ ì—†ì–´ë„ ë¨
            if (!apiKey && currentRegion !== 'andong') { empty.classList.remove('hidden'); return; }

            const cityCode = CITY_CODES[currentRegion];
            const targets = stationConfig[currentRegion];

            if (!targets || targets.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400">ë“±ë¡ëœ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒë‹¨ '+ ì •ë¥˜ì¥ ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</div>`;
                return;
            }
            
            const addBtn = document.getElementById('add-btn-main');
            if(addBtn) {
                if(currentRegion === 'andong') addBtn.classList.add('hidden');
                else addBtn.classList.remove('hidden');
            }

            // [NEW] ì•ˆë™ì‹œ CSV ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì „ì—­ ì—ëŸ¬ í‘œì‹œ (ì¹´ë“œë³„ ì¤‘ë³µ ë°©ì§€)
            if (currentRegion === 'andong') {
                if (ANDONG_TIMETABLE === "ERROR") {
                    container.innerHTML = `
                        <div class="p-8 bg-red-50/50 rounded-3xl border border-red-100 text-center">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl shadow-sm">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                            </div>
                            <p class="text-base font-bold text-red-600 mb-2">ì‹œê°„í‘œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                            <p class="text-xs text-red-400 leading-relaxed mb-4">
                                ì„œë²„ì— <span class="font-mono bg-red-100 px-1 rounded">timetable.csv</span> íŒŒì¼ì´ ì—†ê±°ë‚˜<br>
                                íŒŒì¼ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </p>
                            <button onclick="loadTimetable()" class="text-xs bg-white border border-red-200 text-red-500 px-4 py-2 rounded-xl font-bold hover:bg-red-50 transition-colors shadow-sm">
                                <i class="fa-solid fa-rotate-right mr-1"></i> ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                            </button>
                        </div>
                    `;
                    return; 
                }
                
                // [NEW] ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° (null ìƒíƒœ)
                if (ANDONG_TIMETABLE === null) {
                    container.innerHTML = `
                        <div class="text-center py-20 animate-pulse">
                            <i class="fa-solid fa-satellite-dish text-3xl text-gray-300 mb-2"></i>
                            <p class="text-sm font-bold text-gray-400">ì‹œê°„í‘œ ë°ì´í„° ë¡œë”©ì¤‘...</p>
                        </div>
                    `;
                    return;
                }
            }

            targets.forEach((station, index) => {
                if(currentRegion === 'andong') {
                    renderStaticCard(index, station);
                } else {
                    const skeletonHtml = `
                        <div id="station-card-${index}" class="toss-card p-5 mb-4 !bg-white/50 animate-pulse relative">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center gap-2.5">
                                    <div class="w-10 h-10 rounded-[16px] bg-gray-200"></div>
                                    <div>
                                        <div class="h-4 w-32 bg-gray-200 rounded mb-1.5"></div>
                                        <div class="h-3 w-20 bg-gray-200 rounded"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="h-12 bg-gray-200 rounded-xl"></div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', skeletonHtml);
                    loadStationData(index, cityCode, station);
                }
            });
        }

        // [ìˆ˜ì •] API ë°ì´í„° ë Œë”ë§ (ê·¸ë£¹í™” ì ìš©)
        function renderCard(index, station, list) {
            const skeletonCard = document.getElementById(`station-card-${index}`);
            if (!skeletonCard) return;

            let contentHtml = '';
            
            if (list.length > 0) {
                // 1. ê·¸ë£¹í™”
                const grouped = {};
                list.forEach(bus => {
                    const no = bus.routeno || '?';
                    if(!grouped[no]) grouped[no] = [];
                    grouped[no].push(bus);
                });
                
                // 2. ì‹œê°„ìˆœ ì •ë ¬ (ê·¸ë£¹ ë‚´ë¶€)
                for(let no in grouped) {
                    grouped[no].sort((a, b) => (parseInt(a.arrtime)||0) - (parseInt(b.arrtime)||0));
                }

                // 3. ê·¸ë£¹ ì •ë ¬ (ê°€ì¥ ë¹ ë¥¸ ë„ì°©ì‹œê°„ ê¸°ì¤€)
                const sortedKeys = Object.keys(grouped).sort((a, b) => {
                     return (parseInt(grouped[a][0].arrtime)||0) - (parseInt(grouped[b][0].arrtime)||0);
                });

                sortedKeys.forEach(no => {
                    const groupItems = grouped[no];
                    const first = groupItems[0];
                    
                    const routeType = first.routetp || 'ì¼ë°˜';
                    const badgeColor = routeType.includes('ê¸‰í–‰') ? 'bg-red-500' : 'bg-blue-500';
                    const min = Math.floor(parseInt(first.arrtime) / 60);
                    const now = new Date();
                    const arrivalDate = new Date(now.getTime() + (parseInt(first.arrtime) * 1000));
                    const arrivalTimeStr = formatTime(arrivalDate);

                    const timeStr = min < 2 ? `ê³§ ë„ì°© (${arrivalTimeStr})` : `${min}ë¶„ (${arrivalTimeStr})`;
                    const colorClass = min < 5 ? "text-red-500 font-bold" : "text-main";
                    const destText = first.endnodenm ? `${first.endnodenm} ë°©ë©´` : (first.nodenm ? `${first.nodenm} ê²½ìœ ` : 'ìš´í–‰ì¤‘');
                    
                    contentHtml += `
                    <div class="glass-item p-3 mb-2 flex flex-col gap-2 active:scale-[0.98] transition-transform">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="${badgeColor} text-white text-[10px] font-bold px-1.5 py-0.5 rounded min-w-[36px] text-center">${routeType}</span>
                                <div>
                                    <span class="text-sm font-bold text-main">${no}</span>
                                    <span class="text-[10px] text-sub ml-1">${destText} ${first.arrprevstationcnt ? `Â· ${first.arrprevstationcnt}ì „` : ''}</span>
                                </div>
                            </div>
                            <span class="text-sm ${colorClass}">${timeStr}</span>
                        </div>
                    `;

                    // ì¶”ê°€ ë„ì°© ì •ë³´ (ê°™ì€ ë²ˆí˜¸)
                    if (groupItems.length > 1) {
                         contentHtml += `<div class="pl-2 border-t border-gray-100/50 pt-2 space-y-1">`;
                         for(let i=1; i<groupItems.length; i++) {
                             const sub = groupItems[i];
                             const sMin = Math.floor(parseInt(sub.arrtime) / 60);
                             const sDate = new Date(now.getTime() + (parseInt(sub.arrtime) * 1000));
                             const sTimeStr = sMin < 2 ? `ê³§ ë„ì°©` : `${sMin}ë¶„`;
                             const sDest = sub.endnodenm ? `${sub.endnodenm} ë°©ë©´` : 'ìš´í–‰ì¤‘';
                             const sColor = sMin < 5 ? "text-red-500 font-bold" : "text-gray-600";
                             
                             contentHtml += `
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-sub pl-9">${sDest} (${formatTime(sDate)})</span>
                                <span class="text-xs ${sColor}">${sTimeStr}</span>
                            </div>`;
                         }
                         contentHtml += `</div>`;
                    }
                    contentHtml += `</div>`;
                });

            } else {
                contentHtml = `
                    <div class="p-4 bg-gray-50/50 rounded-xl text-center border border-gray-100">
                        <i class="fa-solid fa-moon text-gray-300 text-lg mb-1"></i>
                        <p class="text-xs text-gray-500 font-bold">ìš´í–‰ì¤‘ì¸ ë²„ìŠ¤ ì—†ìŒ</p>
                    </div>`;
            }

            const cardHtml = `
                <div class="toss-card p-5 mb-4 !bg-white/70 animate-[fadeInUp_0.4s_ease-out] relative group">
                    <button onclick="removeStation('${currentRegion}', ${index})" class="delete-btn absolute top-4 right-4 text-gray-300 hover:text-red-500 p-1">
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2.5">
                            <div class="w-10 h-10 rounded-[16px] bg-blue-100 flex items-center justify-center text-blue-600 text-lg shadow-sm">
                                <i class="fa-solid fa-bus"></i>
                            </div>
                            <div>
                                <h4 class="text-base font-bold text-main">${station.name}</h4>
                                <p class="text-xs text-sub text-[10px]">ARS: ${station.arsNo || '-'} | Node: ${station.nodeId}</p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1">${contentHtml}</div>
                </div>
            `;
            skeletonCard.outerHTML = cardHtml;
        }

        function renderErrorCard(index, station, msg) {
            const skeletonCard = document.getElementById(`station-card-${index}`);
            if (!skeletonCard) return;
            
            let displayMsg = msg;
            if (msg.includes('KEY_NOT_REGISTERED') || msg.includes('KEY_ERROR')) displayMsg = "ì¸ì¦í‚¤ ì—ëŸ¬: í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
            else if (msg === 'NETWORK_ERROR') displayMsg = "ë„¤íŠ¸ì›Œí¬/í”„ë¡ì‹œ ì—°ê²° ì‹¤íŒ¨";

            const kakaoSearchQuery = `${CITY_NAMES[currentRegion]} ${station.name}`;
            const kakaoMapUrl = `https://map.kakao.com/link/search/${encodeURIComponent(kakaoSearchQuery)}`;

            const html = `
                <div class="toss-card p-5 mb-4 !bg-red-50 border-red-100 relative">
                     <div class="absolute top-4 right-4 flex gap-1">
                        <a href="${kakaoMapUrl}" target="_blank" class="text-xs btn-kakao px-2 py-1 rounded-md font-bold hover:opacity-80 transition-opacity flex items-center gap-1 shadow-sm">
                            <i class="fa-solid fa-map-location-dot"></i> ì¹´ì¹´ì˜¤ë§µ
                        </a>
                        <button onclick="removeStation('${currentRegion}', ${index})" class="text-red-300 hover:text-red-500 p-1">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
                        <h4 class="text-base font-bold text-red-600">${station.name}</h4>
                    </div>
                    <p class="text-xs text-red-500 break-all">${displayMsg}</p>
                </div>
            `;
            skeletonCard.outerHTML = html;
        }

        // --- Event Handlers (ë™ì¼) ---
        function openSearchModal() {
            if(currentRegion === 'andong') { 
                document.getElementById('search-modal').classList.remove('hidden');
                document.getElementById('search-modal-region').innerText = "ì•ˆë™ì‹œ (ì‹œê°„í‘œ ëª¨ë“œ)";
                document.getElementById('api-search-box').classList.add('hidden');
                document.getElementById('andong-manual-guide').classList.remove('hidden');
                document.getElementById('add-station-results').innerHTML = '';
                return;
            }

            if(!apiKey) { alert("ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); openSettings(); return; }
            document.getElementById('search-modal').classList.remove('hidden');
            document.getElementById('search-modal-region').innerText = `${CITY_NAMES[currentRegion]}ì—ì„œ ê²€ìƒ‰`;
            document.getElementById('api-search-box').classList.remove('hidden');
            document.getElementById('andong-manual-guide').classList.add('hidden');
            document.getElementById('add-station-input').placeholder = `ì˜ˆ: ${CITY_NAMES[currentRegion]} ì •ë¥˜ì¥ ì´ë¦„`;
            document.getElementById('add-station-input').value = '';
            document.getElementById('add-station-results').innerHTML = '<p class="text-center text-gray-400 mt-10 text-sm">ì •ë¥˜ì¥ ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>';
            document.getElementById('add-station-input').focus();
        }
        function closeSearchModal() { document.getElementById('search-modal').classList.add('hidden'); }
        async function doSearchStation() {
            const keyword = document.getElementById('add-station-input').value.trim();
            if(!keyword) return;
            const resultArea = document.getElementById('add-station-results');
            resultArea.innerHTML = '<p class="text-center mt-4"><i class="fa-solid fa-spinner fa-spin"></i> ê²€ìƒ‰ì¤‘...</p>';
            const result = await searchStationAPI(keyword);
            if (result.error) { resultArea.innerHTML = `<p class="text-center mt-4 text-red-400 text-xs">ì˜¤ë¥˜: ${result.error}</p>`; return; }
            if (result.length === 0) { resultArea.innerHTML = '<p class="text-center mt-4 text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
            result.sort((a, b) => (a.nodenm || "").length - (b.nodenm || "").length);
            let html = '';
            result.forEach(item => {
                const arsNo = item.nodeno || '-';
                html += `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-2xl border border-gray-100">
                    <div class="flex-1 min-w-0 mr-2">
                        <p class="font-bold text-main text-sm truncate">${item.nodenm}</p>
                        <p class="text-xs text-gray-400 truncate">ë²ˆí˜¸: <span class="text-blue-500 font-bold">${arsNo}</span> | ID: ${item.nodeid}</p>
                    </div>
                    <button onclick="addStation('${(item.nodenm || "").replace(/'/g, "\\'")}', '${item.nodeid}', '${arsNo}')" class="flex-none text-xs bg-blue-500 text-white px-3 py-2 rounded-xl font-bold hover:bg-blue-600 transition-colors">ì¶”ê°€</button>
                </div>`;
            });
            resultArea.innerHTML = html;
        }
        function addStation(name, nodeId, arsNo) {
            stationConfig[currentRegion].push({ name: name, sub: "ì‚¬ìš©ì ì¶”ê°€", nodeId: nodeId, arsNo: arsNo, tags: [] });
            localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig));
            alert(`'${name}' ì •ë¥˜ì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeSearchModal();
            renderList();
        }
        function removeStation(region, index) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                stationConfig[region].splice(index, 1);
                localStorage.setItem('my_station_config_v40', JSON.stringify(stationConfig));
                renderList();
            }
        }
        function selectRegion(region) {
            currentRegion = region;
            ['andong', 'gumi', 'chilgok'].forEach(id => {
                const el = document.getElementById('btn-' + id);
                const txt = el.querySelector('.status-text');
                if (id === region) { el.classList.add('region-card-selected'); txt.innerText = 'ì„ íƒë¨'; } 
                else { el.classList.remove('region-card-selected'); txt.innerText = 'ì„ íƒí•˜ê¸°'; }
            });
            document.getElementById('region-status-label').innerText = CITY_NAMES[region];
            renderList();
        }
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const type = document.querySelector('input[name="key-type"]:checked').value;
            const proxy = document.getElementById('proxy-select').value;
            if(key) {
                apiKey = key; keyType = type; selectedProxy = proxy;
                localStorage.setItem('toss_bus_api_key', key);
                localStorage.setItem('toss_bus_key_type', type);
                localStorage.setItem('toss_bus_proxy', proxy);
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeSettings();
                renderList();
            } else { alert('í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }
        }
        function resetData() {
            if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('my_station_config_v40');
                localStorage.removeItem('station_routes_cache_v1');
                stationConfig = JSON.parse(JSON.stringify(defaultStationConfig));
                renderList();
                alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeSettings();
            }
        }
        async function testConnection() {
            const inputKey = document.getElementById('api-key-input').value.trim();
            const resultBox = document.getElementById('test-result');
            const selectedType = document.querySelector('input[name="key-type"]:checked').value;
            const currentProxy = document.getElementById('proxy-select').value;
            
            const originalProxy = selectedProxy;
            selectedProxy = currentProxy;
            
            if(!inputKey) { alert("í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
            resultBox.classList.remove('hidden');
            resultBox.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> í…ŒìŠ¤íŠ¸ ì¤‘...';
            apiKey = inputKey; keyType = selectedType;
            
            const result = await fetchBusArrival('37010', 'DJB8001793'); 
            
            selectedProxy = originalProxy;

            if (Array.isArray(result)) {
                resultBox.innerHTML = '<span class="text-green-600 font-bold">âœ… ì—°ê²° ì„±ê³µ!</span><br>ëª¨ë“  ì„¤ì •ì´ ì •ìƒì…ë‹ˆë‹¤.';
            } else {
                resultBox.innerHTML = `<span class="text-red-500 font-bold">âŒ ${result}</span>`;
            }
        }

        function manualAddStation() {
            const id = document.getElementById('manual-station-id').value;
            const name = document.getElementById('manual-station-name').value;
            if(!id || !name) { alert("ì´ë¦„ê³¼ IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            addStation(name, id, "ì§ì ‘ì¶”ê°€");
        }
        
        function addManualStation() {
            const name = document.getElementById('manual-station-name').value;
            const id = document.getElementById('manual-station-id').value;
            if(!name || !id) { alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"); return; }
            addStation(name, id, "ì§ì ‘ì¶”ê°€");
        }

        const mainContent = document.getElementById('main-content');
        const island = document.getElementById('dynamic-island');
        mainContent.addEventListener('scroll', () => { island.classList.toggle('island-active', mainContent.scrollTop > 20); });
    </script>
</body>
</html>